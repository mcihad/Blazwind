@namespace Blazwind.Components.Countdown
@inherits BwBase
@using Blazwind.Components.Shared
@implements IDisposable

@{
    var sizeClass = Size switch
    {
        BwSize.Small => "bw-countdown-sm",
        BwSize.Large => "bw-countdown-lg",
        BwSize.ExtraLarge => "bw-countdown-xl",
        _ => "bw-countdown-md"
    };

    var boxSizeClass = Size switch
    {
        BwSize.Small => "bw-countdown-box-sm",
        BwSize.Large => "bw-countdown-box-lg",
        BwSize.ExtraLarge => "bw-countdown-box-xl",
        _ => "bw-countdown-box-md"
    };

    var numSizeClass = Size switch
    {
        BwSize.Small => "bw-countdown-num-sm",
        BwSize.Large => "bw-countdown-num-lg",
        BwSize.ExtraLarge => "bw-countdown-num-xl",
        _ => "bw-countdown-num-md"
    };

    var lblSizeClass = Size switch
    {
        BwSize.Small => "bw-countdown-lbl-sm",
        BwSize.Large => "bw-countdown-lbl-lg",
        BwSize.ExtraLarge => "bw-countdown-lbl-xl",
        _ => "bw-countdown-lbl-md"
    };

    var colorClass = Color switch
    {
        BwColor.Success => "bw-countdown-success",
        BwColor.Danger => "bw-countdown-danger",
        BwColor.Warning => "bw-countdown-warning",
        BwColor.Info => "bw-countdown-info",
        BwColor.Secondary => "bw-countdown-secondary",
        BwColor.Dark => "bw-countdown-dark",
        _ => "bw-countdown-primary"
    };

    var variantClass = Variant switch
    {
        BwVariant.Filled => "bw-countdown-filled",
        BwVariant.Outline => "bw-countdown-outline",
        BwVariant.Soft => "bw-countdown-soft",
        _ => "bw-countdown-ghost"
    };

    // Combine classes
    var boxClasses = CombineClasses($"bw-countdown-box {boxSizeClass} {variantClass} {colorClass}");
    var separatorClasses = "bw-countdown-separator";
}

<div class="@CombineClasses($"bw-countdown {sizeClass}")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (ShowDays && _remaining.Days > 0)
    {
        <div class="@boxClasses">
            <span class="bw-countdown-number @numSizeClass">@_remaining.Days.ToString("D2")</span>
            @if (ShowLabels)
            {
                <span class="bw-countdown-label @lblSizeClass">@DayLabel</span>
            }
        </div>
        <span class="@separatorClasses">:</span>
    }

    @if (ShowHours)
    {
        <div class="@boxClasses">
            <span class="bw-countdown-number @numSizeClass">@_remaining.Hours.ToString("D2")</span>
            @if (ShowLabels)
            {
                <span class="bw-countdown-label @lblSizeClass">@HourLabel</span>
            }
        </div>
        @if (ShowMinutes || ShowSeconds)
        {
            <span class="@separatorClasses">:</span>
        }
    }

    @if (ShowMinutes)
    {
        <div class="@boxClasses">
            <span class="bw-countdown-number @numSizeClass">@_remaining.Minutes.ToString("D2")</span>
            @if (ShowLabels)
            {
                <span class="bw-countdown-label @lblSizeClass">@MinuteLabel</span>
            }
        </div>
        @if (ShowSeconds)
        {
            <span class="@separatorClasses">:</span>
        }
    }

    @if (ShowSeconds)
    {
        <div class="@boxClasses">
            <span class="bw-countdown-number @numSizeClass">@_remaining.Seconds.ToString("D2")</span>
            @if (ShowLabels)
            {
                <span class="bw-countdown-label @lblSizeClass">@SecondLabel</span>
            }
        </div>
    }

    @if (ShowMilliseconds)
    {
        <span class="@separatorClasses">.</span>
        <div class="@boxClasses opacity-80">
            <span class="text-lg font-mono tabular-nums">@_remaining.Milliseconds.ToString("D3")</span>
        </div>
    }
</div>

@code {

    [Parameter]
    public DateTime TargetDate { get; set; }

    [Parameter]
    public TimeSpan? Duration { get; set; }

    [Parameter]
    public BwSize Size { get; set; } = BwSize.Medium;

    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    [Parameter]
    public BwVariant Variant { get; set; } = BwVariant.Ghost;

    [Parameter]
    public bool ShowDays { get; set; } = true;

    [Parameter]
    public bool ShowHours { get; set; } = true;

    [Parameter]
    public bool ShowMinutes { get; set; } = true;

    [Parameter]
    public bool ShowSeconds { get; set; } = true;

    [Parameter]
    public bool ShowMilliseconds { get; set; }

    [Parameter]
    public bool ShowLabels { get; set; }

    [Parameter]
    public string DayLabel { get; set; } = "g√ºn";

    [Parameter]
    public string HourLabel { get; set; } = "saat";

    [Parameter]
    public string MinuteLabel { get; set; } = "dk";

    [Parameter]
    public string SecondLabel { get; set; } = "sn";

    [Parameter]
    public EventCallback OnComplete { get; set; }

    private TimeSpan _remaining = TimeSpan.Zero;
    private Timer? _timer;
    private DateTime _endTime;
    private bool _isCompleted;

    protected override void OnInitialized()
    {
        if (Duration.HasValue)
        {
            _endTime = DateTime.Now.Add(Duration.Value);
        }
        else
        {
            _endTime = TargetDate;
        }

        UpdateRemaining();
        _timer = new Timer(TimerCallback, null, 0, ShowMilliseconds ? 50 : 1000);
    }

    private void TimerCallback(object? state)
    {
        UpdateRemaining();
        InvokeAsync(StateHasChanged);
    }

    private void UpdateRemaining()
    {
        var remaining = _endTime - DateTime.Now;

        if (remaining <= TimeSpan.Zero)
        {
            _remaining = TimeSpan.Zero;
            if (!_isCompleted)
            {
                _isCompleted = true;
                _timer?.Dispose();
                InvokeAsync(async () => await OnComplete.InvokeAsync());
            }
        }
        else
        {
            _remaining = remaining;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

}