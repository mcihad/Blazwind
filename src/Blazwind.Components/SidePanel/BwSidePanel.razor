@namespace Blazwind.Components.SidePanel
@using Blazwind.Components.Shared
@inherits BwBase

@if (IsOpen)
{
    @* Backdrop *@
    @if (ShowBackdrop)
    {
        <div class="fixed inset-0 z-[1040] bg-black/50 transition-opacity duration-300 @(IsOpen ? "opacity-100" : "opacity-0")"
            @onclick="HandleBackdropClick"></div>
    }

    @* Panel *@
    <div class="@CombineClasses("fixed z-[1050] bg-white dark:bg-gray-800 shadow-2xl flex flex-col transition-transform duration-300 ease-out", PositionClasses, SizeClasses, IsOpen ? OpenTransform : ClosedTransform)"
        style="@Style"
        id="@Id"
        @attributes="AdditionalAttributes"
        @onclick:stopPropagation="true">

        @* Header *@
        @if (ShowHeader)
        {
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <div class="flex items-center gap-3">
                    @if (!string.IsNullOrEmpty(Icon))
                    {
                        <div class="w-10 h-10 flex items-center justify-center rounded-lg @IconBgClass">
                            <i class="@Icon @IconColorClass"></i>
                        </div>
                    }
                    <div>
                        @if (!string.IsNullOrEmpty(Title))
                        {
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">@Title</h3>
                        }
                        @if (!string.IsNullOrEmpty(Subtitle))
                        {
                            <p class="text-sm text-gray-500 dark:text-gray-400">@Subtitle</p>
                        }
                    </div>
                </div>
                @if (Closable)
                {
                    <button type="button"
                        class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 dark:hover:text-gray-300 transition-colors"
                        @onclick="Close">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                }
            </div>
        }

        @* Body *@
        <div class="flex-1 overflow-y-auto p-6 @BodyClass">
            @ChildContent
        </div>

        @* Footer *@
        @if (FooterContent != null)
        {
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                @FooterContent
            </div>
        }
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? FooterContent { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public string? Icon { get; set; }
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public BwPosition Position { get; set; } = BwPosition.Right;
    [Parameter] public BwSize Size { get; set; } = BwSize.Medium;
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowBackdrop { get; set; } = true;
    [Parameter] public bool Closable { get; set; } = true;
    [Parameter] public bool CloseOnBackdropClick { get; set; } = true;
    [Parameter] public bool CloseOnEscape { get; set; } = true;
    [Parameter] public string? BodyClass { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private string PositionClasses => Position switch
    {
        BwPosition.Left => "left-0 top-0 h-full",
        BwPosition.Top => "top-0 left-0 w-full",
        BwPosition.Bottom => "bottom-0 left-0 w-full",
        _ => "right-0 top-0 h-full" // Right (default)
    };

    private string SizeClasses => (Position, Size) switch
    {
        (BwPosition.Left or BwPosition.Right, BwSize.Small) => "w-80",
        (BwPosition.Left or BwPosition.Right, BwSize.Large) => "w-[600px]",
        (BwPosition.Left or BwPosition.Right, _) => "w-96", // Medium
        (BwPosition.Top or BwPosition.Bottom, BwSize.Small) => "h-48",
        (BwPosition.Top or BwPosition.Bottom, BwSize.Large) => "h-96",
        (BwPosition.Top or BwPosition.Bottom, _) => "h-64", // Medium
        _ => "w-96"
    };

    private string OpenTransform => Position switch
    {
        BwPosition.Left => "translate-x-0",
        BwPosition.Top => "translate-y-0",
        BwPosition.Bottom => "translate-y-0",
        _ => "translate-x-0"
    };

    private string ClosedTransform => Position switch
    {
        BwPosition.Left => "-translate-x-full",
        BwPosition.Top => "-translate-y-full",
        BwPosition.Bottom => "translate-y-full",
        _ => "translate-x-full"
    };

    private string IconBgClass => Color switch
    {
        BwColor.Primary => "bg-blue-100 dark:bg-blue-900/30",
        BwColor.Success => "bg-green-100 dark:bg-green-900/30",
        BwColor.Warning => "bg-amber-100 dark:bg-amber-900/30",
        BwColor.Danger => "bg-red-100 dark:bg-red-900/30",
        BwColor.Info => "bg-cyan-100 dark:bg-cyan-900/30",
        _ => "bg-gray-100 dark:bg-gray-800"
    };

    private string IconColorClass => Color switch
    {
        BwColor.Primary => "text-blue-600 dark:text-blue-400",
        BwColor.Success => "text-green-600 dark:text-green-400",
        BwColor.Warning => "text-amber-600 dark:text-amber-400",
        BwColor.Danger => "text-red-600 dark:text-red-400",
        BwColor.Info => "text-cyan-600 dark:text-cyan-400",
        _ => "text-gray-600 dark:text-gray-400"
    };

    private async Task HandleBackdropClick()
    {
        if (CloseOnBackdropClick)
        {
            await Close();
        }
    }

    public async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
        await OnClose.InvokeAsync();
    }

    public async Task Open()
    {
        IsOpen = true;
        await IsOpenChanged.InvokeAsync(true);
    }

    public async Task Toggle()
    {
        if (IsOpen)
            await Close();
        else
            await Open();
    }
}