@namespace Blazwind.Components.SidePanel
@using Blazwind.Components.Shared
@inherits BwBase

@if (IsOpen)
{
    @* Backdrop *@
    @if (ShowBackdrop)
    {
        <div class="bw-sidepanel-backdrop @(IsOpen ? "opacity-100" : "opacity-0")"
            @onclick="HandleBackdropClick"></div>
    }

    @* Panel *@
    <div class="@CombineClasses("bw-sidepanel", PositionClasses, SizeClasses, IsOpen ? OpenTransform : ClosedTransform)"
        style="@Style"
        id="@Id"
        @attributes="AdditionalAttributes"
        @onclick:stopPropagation="true">

        @* Header *@
        @if (ShowHeader)
        {
            <div class="bw-sidepanel-header">
                <div class="bw-sidepanel-title-group">
                    @if (!string.IsNullOrEmpty(Icon))
                    {
                        <div class="bw-sidepanel-icon-box @GetColorClass()">
                            <i class="@Icon bw-sidepanel-icon @GetColorClass()"></i>
                        </div>
                    }
                    <div>
                        @if (!string.IsNullOrEmpty(Title))
                        {
                            <h3 class="bw-sidepanel-title">@Title</h3>
                        }
                        @if (!string.IsNullOrEmpty(Subtitle))
                        {
                            <p class="bw-sidepanel-subtitle">@Subtitle</p>
                        }
                    </div>
                </div>
                @if (Closable)
                {
                    <button type="button"
                        class="bw-sidepanel-close"
                        @onclick="Close">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                }
            </div>
        }

        @* Body *@
        <div class="bw-sidepanel-body @BodyClass">
            @ChildContent
        </div>

        @* Footer *@
        @if (FooterContent != null)
        {
            <div class="bw-sidepanel-footer">
                @FooterContent
            </div>
        }
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? FooterContent { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public string? Icon { get; set; }
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public BwPosition Position { get; set; } = BwPosition.Right;
    [Parameter] public BwSize Size { get; set; } = BwSize.Medium;
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowBackdrop { get; set; } = true;
    [Parameter] public bool Closable { get; set; } = true;
    [Parameter] public bool CloseOnBackdropClick { get; set; } = true;
    [Parameter] public bool CloseOnEscape { get; set; } = true;
    [Parameter] public string? BodyClass { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private string PositionClasses => Position switch
    {
        BwPosition.Left => "left-0 top-0 h-full",
        BwPosition.Top => "top-0 left-0 w-full",
        BwPosition.Bottom => "bottom-0 left-0 w-full",
        _ => "right-0 top-0 h-full" // Right (default)
    };

    private string SizeClasses => (Position, Size) switch
    {
        (BwPosition.Left or BwPosition.Right, BwSize.Small) => "w-80",
        (BwPosition.Left or BwPosition.Right, BwSize.Large) => "w-[600px]",
        (BwPosition.Left or BwPosition.Right, _) => "w-96", // Medium
        (BwPosition.Top or BwPosition.Bottom, BwSize.Small) => "h-48",
        (BwPosition.Top or BwPosition.Bottom, BwSize.Large) => "h-96",
        (BwPosition.Top or BwPosition.Bottom, _) => "h-64", // Medium
        _ => "w-96"
    };

    private string OpenTransform => Position switch
    {
        BwPosition.Left => "translate-x-0",
        BwPosition.Top => "translate-y-0",
        BwPosition.Bottom => "translate-y-0",
        _ => "translate-x-0"
    };

    private string ClosedTransform => Position switch
    {
        BwPosition.Left => "-translate-x-full",
        BwPosition.Top => "-translate-y-full",
        BwPosition.Bottom => "translate-y-full",
        _ => "translate-x-full"
    };

    private string GetColorClass() => Color.ToString().ToLower();

    private async Task HandleBackdropClick()
    {
        if (CloseOnBackdropClick)
        {
            await Close();
        }
    }

    public async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
        await OnClose.InvokeAsync();
    }

    public async Task Open()
    {
        IsOpen = true;
        await IsOpenChanged.InvokeAsync(true);
    }

    public async Task Toggle()
    {
        if (IsOpen)
            await Close();
        else
            await Open();
    }
}