@namespace Blazwind.Components.Avatar
@using Blazwind.Components.Shared
@inherits BwBase
@{
    var sizeClass = Size switch
    {
        BwSize.Small => "w-8 h-8 text-xs",
        BwSize.Large => "w-12 h-12 text-lg",
        _ => "w-10 h-10 text-sm"
    };

    var overlapMargin = Size switch
    {
        BwSize.Small => "-ml-2",
        BwSize.Large => "-ml-4",
        _ => "-ml-3"
    };

    var displayAvatars = MaxDisplay.HasValue ? Avatars.Take(MaxDisplay.Value).ToList() : Avatars;
    var remainingCount = MaxDisplay.HasValue ? Avatars.Count - MaxDisplay.Value : 0;
}

<div class="@CombineClasses("flex items-center")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @foreach (var (avatar, index) in displayAvatars.Select((a, i) => (a, i)))
    {
        <div
            class="relative @(index > 0 ? overlapMargin : "") @sizeClass rounded-full ring-2 ring-white dark:ring-gray-900 bg-gray-100 dark:bg-gray-800 flex items-center justify-center overflow-hidden"
            style="z-index: @(displayAvatars.Count - index);">
            @if (!string.IsNullOrEmpty(avatar.Src))
            {
                <img src="@avatar.Src" alt="@avatar.Name" class="w-full h-full object-cover"/>
            }
            else
            {
                <span class="font-medium text-gray-600 dark:text-gray-300">@GetInitials(avatar.Name)</span>
            }
        </div>
    }

    @if (remainingCount > 0)
    {
        <div
            class="@overlapMargin @sizeClass rounded-full ring-2 ring-white dark:ring-gray-900 bg-gray-200 dark:bg-gray-700 flex items-center justify-center"
            style="z-index: 0;">
            <span class="font-medium text-gray-600 dark:text-gray-300">+@remainingCount</span>
        </div>
    }
</div>

@code {

    [Parameter]
    public List<AvatarItem> Avatars { get; set; } = new();

    [Parameter]
    public BwSize Size { get; set; } = BwSize.Medium;

    [Parameter]
    public int? MaxDisplay { get; set; }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0) return "?";
        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
        return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
    }

}
