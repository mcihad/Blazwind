@namespace Blazwind.Components.Pagination
@using Blazwind.Components.Shared
@inherits BwBase

@{
    var totalPages = PageSize > 0 ? (int)Math.Ceiling(TotalItems / (double)PageSize) : 0;
    var pages = GetVisiblePages(totalPages);
    
    // Size classes
    var sizeClass = Size switch
    {
        BwSize.Small => "h-7 min-w-7 px-2 text-xs",
        BwSize.Large => "h-11 min-w-11 px-4 text-base",
        _ => "h-9 min-w-9 px-3 text-sm"
    };
    
    var baseButtonClass = $"bw-pagination-btn {sizeClass}";
}

<nav class="@CombineClasses("flex items-center gap-4")" style="@Style" id="@Id" @attributes="AdditionalAttributes" aria-label="Pagination">
    @* Info Display - Left side (Hide in Compact/Mobile if Responsive) *@
    @if (ShowInfo)
    {
        <div class="bw-pagination-info @(Compact ? "hidden" : (Responsive ? "hidden md:block" : ""))">
            @{
                var start = TotalItems > 0 ? (CurrentPage - 1) * PageSize + 1 : 0;
                var end = Math.Min(CurrentPage * PageSize, TotalItems);
            }
            <span class="bw-pagination-info-value">@start</span>
            <span class="mx-1">-</span>
            <span class="bw-pagination-info-value">@end</span>
            <span class="mx-1">/</span>
            <span class="bw-pagination-info-value">@TotalItems</span>
            <span class="ml-1 opacity-70">kayıt</span>
        </div>
    }

    @* Page Size Selector (Hide in Compact/Mobile if Responsive) *@
    @if (ShowPageSizeSelector)
    {
        <div class="flex items-center gap-2 @(Compact ? "hidden" : (Responsive ? "hidden md:flex" : ""))">
            <select class="bw-pagination-select"
                    @onchange="OnPageSizeChange">
                @foreach (var size in PageSizeOptions)
                {
                    <option value="@size" selected="@(size == PageSize)">@size</option>
                }
            </select>
        </div>
    }

    @* STANDARD NAVIGATION (Hidden heavily on Mobile if Responsive, or hidden if Compact) *@
    <div class="items-center gap-1 @(Compact ? "hidden" : (Responsive ? "hidden md:flex" : "flex"))">
        @* First Button *@
        @if (ShowFirstLast)
        {
            <button type="button"
                    class="@baseButtonClass @(CurrentPage <= 1 ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                    disabled="@(CurrentPage <= 1)"
                    title="İlk sayfa"
                    @onclick="() => GoToPage(1)">
                <i class="fa-solid fa-angles-left text-xs"></i>
            </button>
        }

        @* Previous Button *@
        <button type="button"
                    class="@baseButtonClass @(CurrentPage <= 1 ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                    disabled="@(CurrentPage <= 1)"
                    title="Önceki sayfa"
                    @onclick="() => GoToPage(CurrentPage - 1)">
            <i class="fa-solid fa-chevron-left text-xs"></i>
        </button>

        @* Page Numbers *@
        <div class="flex items-center gap-1 mx-1">
            @foreach (var pageNum in pages)
            {
                @if (pageNum == -1)
                {
                    <span class="@baseButtonClass opacity-50 cursor-default">…</span>
                }
                else
                {
                    <button type="button"
                            class="@baseButtonClass @(pageNum == CurrentPage ? "bw-pagination-btn-active" : "")"
                            @onclick="() => GoToPage(pageNum)">
                        @pageNum
                    </button>
                }
            }
        </div>

        @* Next Button *@
        <button type="button"
                    class="@baseButtonClass @(CurrentPage >= totalPages ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                    disabled="@(CurrentPage >= totalPages)"
                    title="Sonraki sayfa"
                    @onclick="() => GoToPage(CurrentPage + 1)">
            <i class="fa-solid fa-chevron-right text-xs"></i>
        </button>

        @* Last Button *@
        @if (ShowFirstLast)
        {
            <button type="button"
                    class="@baseButtonClass @(CurrentPage >= totalPages ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                    disabled="@(CurrentPage >= totalPages)"
                    title="Son sayfa"
                    @onclick="() => GoToPage(totalPages)">
                <i class="fa-solid fa-angles-right text-xs"></i>
            </button>
        }
    </div>

    @* COMPACT / MOBILE NAVIGATION (Visible only if Compact OR (Responsive AND Mobile)) *@
    <div class="items-center gap-2 @(Compact ? "flex" : (Responsive ? "flex md:hidden" : "hidden"))">
        @* First Button *@
        <button type="button"
                class="@baseButtonClass @(CurrentPage <= 1 ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                disabled="@(CurrentPage <= 1)"
                title="İlk sayfa"
                @onclick="() => GoToPage(1)">
            <i class="fa-solid fa-angles-left text-xs"></i>
        </button>

        @* Prev Button *@
        <button type="button"
                class="@baseButtonClass @(CurrentPage <= 1 ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                disabled="@(CurrentPage <= 1)"
                title="Önceki sayfa"
                @onclick="() => GoToPage(CurrentPage - 1)">
            <i class="fa-solid fa-chevron-left text-xs"></i>
        </button>

        @* Input / Total *@
        <div class="bw-pagination-compact-input">
            <input type="number" 
                   min="1" 
                   max="@totalPages"
                   value="@CurrentPage"
                   class="w-8 text-center bg-transparent border-none p-0 text-sm font-medium focus:ring-0 appearance-none [-moz-appearance:_textfield] [&::-webkit-inner-spin-button]:m-0 [&::-webkit-inner-spin-button]:appearance-none"
                   @onchange="OnInputPageChange" />
            <span class="text-sm opacity-60">/ @totalPages</span>
        </div>

        @* Next Button *@
        <button type="button"
                class="@baseButtonClass @(CurrentPage >= totalPages ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                disabled="@(CurrentPage >= totalPages)"
                title="Sonraki sayfa"
                @onclick="() => GoToPage(CurrentPage + 1)">
            <i class="fa-solid fa-chevron-right text-xs"></i>
        </button>

        @* Last Button *@
        <button type="button"
                class="@baseButtonClass @(CurrentPage >= totalPages ? "bw-pagination-btn-disabled" : "bw-pagination-btn-nav")"
                disabled="@(CurrentPage >= totalPages)"
                title="Son sayfa"
                @onclick="() => GoToPage(totalPages)">
            <i class="fa-solid fa-angles-right text-xs"></i>
        </button>
    </div>
</nav>

@code {
    [Parameter] public int TotalItems { get; set; }
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public int CurrentPage { get; set; } = 1;
    [Parameter] public int MaxVisiblePages { get; set; } = 5;
    [Parameter] public bool ShowFirstLast { get; set; } = true;
    [Parameter] public bool ShowPageSizeSelector { get; set; } = false;
    [Parameter] public bool ShowInfo { get; set; } = true;
    [Parameter] public int[] PageSizeOptions { get; set; } = new[] { 10, 25, 50, 100 };
    [Parameter] public BwSize Size { get; set; } = BwSize.Medium;
    // Removed Class parameter (inherited)
    
    [Parameter] public bool Compact { get; set; } = false;
    [Parameter] public bool Responsive { get; set; } = true;
    
    [Parameter] public EventCallback<int> CurrentPageChanged { get; set; }
    [Parameter] public EventCallback<int> PageSizeChanged { get; set; }

    private async Task GoToPage(int page)
    {
        var totalPages = PageSize > 0 ? (int)Math.Ceiling(TotalItems / (double)PageSize) : 0;
        if (page < 1 || page > totalPages || page == CurrentPage) return;
        
        CurrentPage = page;
        await CurrentPageChanged.InvokeAsync(page);
    }
    
    private async Task OnInputPageChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var page))
        {
            await GoToPage(page);
        }
    }

    private async Task OnPageSizeChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var newSize) && newSize != PageSize)
        {
            PageSize = newSize;
            CurrentPage = 1; // Reset to first page
            await PageSizeChanged.InvokeAsync(newSize);
            await CurrentPageChanged.InvokeAsync(1);
        }
    }

    private List<int> GetVisiblePages(int totalPages)
    {
        var pages = new List<int>();
        if (totalPages <= 0) return pages;

        if (totalPages <= MaxVisiblePages)
        {
            for (int i = 1; i <= totalPages; i++)
                pages.Add(i);
            return pages;
        }

        var half = MaxVisiblePages / 2;
        var start = Math.Max(1, CurrentPage - half);
        var end = Math.Min(totalPages, CurrentPage + half);

        if (CurrentPage <= half)
        {
            end = MaxVisiblePages;
        }
        else if (CurrentPage > totalPages - half)
        {
            start = totalPages - MaxVisiblePages + 1;
        }

        if (start > 1)
        {
            pages.Add(1);
            if (start > 2) pages.Add(-1); // Ellipsis
        }

        for (int i = start; i <= end; i++)
            pages.Add(i);

        if (end < totalPages)
        {
            if (end < totalPages - 1) pages.Add(-1); // Ellipsis
            pages.Add(totalPages);
        }

        return pages;
    }
}
