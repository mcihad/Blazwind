@namespace Blazwind.Components.Range
@inject IJSRuntime JS
@implements IAsyncDisposable
@using System.Globalization
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inherits BwBase

@{
    var colorName = Color.ToString().ToLower();
    var brushFillClass = $"bw-brush-fill-{colorName}";
    var handleClass = $"bw-brush-handle bw-brush-handle-{colorName}";
    var textColorClass = $"bw-brush-value-text-{colorName}";
    var badgeClass = $"bw-range-selection-{colorName}";
}

<div class="@CombineClasses("bw-range-brush")" style="@Style" id="@_elementId" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="bw-brush-label">@Label</label>
    }

    @* Main Brush Container *@
    <div class="relative">
        @* Background Chart/Visualization Area *@
        @if (ChildContent != null)
        {
            <div class="bw-brush-chart">
                @ChildContent
            </div>
        }

        @* Brush Track *@
        <div class="bw-brush-track">
            @* Inactive areas (grayed out) *@
            <div class="bw-brush-inactive left-0" style="width: @GetInvariantPercent(CurrentStartPercent)%;"></div>
            <div class="bw-brush-inactive right-0" style="width: @GetInvariantPercent(100 - CurrentEndPercent)%;"></div>

            @* Selection Brush *@
            <div class="bw-brush-selection @brushFillClass"
                 style="left: @GetInvariantPercent(CurrentStartPercent)%; width: @GetInvariantPercent(CurrentEndPercent - CurrentStartPercent)%;">

                @* Left Handle *@
                <div class="bw-brush-handle-left @handleClass">
                    <div class="bw-brush-handle-bar"></div>
                </div>

                @* Center Grip Pattern *@
                <div class="bw-brush-grip">
                    <div class="bw-brush-grip-bar"></div>
                    <div class="bw-brush-grip-bar"></div>
                    <div class="bw-brush-grip-bar"></div>
                </div>

                @* Right Handle *@
                <div class="bw-brush-handle-right @handleClass">
                    <div class="bw-brush-handle-bar"></div>
                </div>
            </div>

            @* Scale Markers *@
            @if (ShowScale)
            {
                <div class="bw-brush-scale">
                    @for (var i = 0; i <= 10; i++)
                    {
                        <div class="bw-brush-scale-marker"></div>
                    }
                </div>
            }
        </div>
    </div>

    @* Value Display *@
    @if (ShowValues)
    {
        <div class="bw-brush-values">
            <div class="flex items-center gap-2">
                <span class="bw-brush-value-label">Başlangıç:</span>
                <span class="@textColorClass">@FormatValue(CurrentStart)</span>
            </div>
            <div class="flex items-center gap-2 px-3 py-1 rounded-full @badgeClass">
                <i class="fa-solid fa-arrows-left-right text-xs"></i>
                <span class="font-medium">@GetRangeText()</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="bw-brush-value-label">Bitiş:</span>
                <span class="@textColorClass">@FormatValue(CurrentEnd)</span>
            </div>
        </div>
    }
</div>

@code {

    [Parameter]
    public double Min { get; set; }

    [Parameter]
    public double Max { get; set; } = 100;

    [Parameter]
    public double Step { get; set; } = 1;

    [Parameter]
    public double Start { get; set; } = 20;

    [Parameter]
    public double End { get; set; } = 80;

    [Parameter]
    public double StartPercent { get; set; }

    [Parameter]
    public double EndPercent { get; set; } = 100;

    [Parameter]
    public double MinWidthPercent { get; set; } = 5;

    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public string? Format { get; set; }

    [Parameter]
    public bool ShowValues { get; set; } = true;

    [Parameter]
    public bool ShowScale { get; set; } = true;

    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    // Removed Class and Style parameters (inherited)
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public EventCallback<BrushChangedEventArgs<double>> OnBrushChanged { get; set; }

    private string _elementId = "";
    private DotNetObjectReference<BwRangeBrush>? _dotNetRef;
    private bool _isDragging;

    private double CurrentStartPercent { get; set; }

    private double CurrentEndPercent { get; set; }

    private double CurrentStart => Min + (Max - Min) * (CurrentStartPercent / 100);
    private double CurrentEnd => Min + (Max - Min) * (CurrentEndPercent / 100);

    protected override bool ShouldRender()
    {
        return !_isDragging;
    }

    private double _prevStart;
    private double _prevEnd;
    private double _prevStartPercent;
    private double _prevEndPercent;

    protected override void OnInitialized()
    {
        _elementId = Id ?? $"bw-brush-{Guid.NewGuid():N}";
        InitializeState();
    }

    private void InitializeState()
    {
        if (StartPercent > 0 || EndPercent < 100)
        {
            CurrentStartPercent = StartPercent;
            CurrentEndPercent = EndPercent;
        }
        else
        {
            CurrentStartPercent = (Start - Min) / (Max - Min) * 100;
            CurrentEndPercent = (End - Min) / (Max - Min) * 100;
        }

        _prevStart = Start;
        _prevEnd = End;
        _prevStartPercent = StartPercent;
        _prevEndPercent = EndPercent;
    }

    protected override void OnParametersSet()
    {
        // Skip updates if dragging
        if (_isDragging) return;

        // Check if parameters actually changed
        var startChanged = Math.Abs(Start - _prevStart) > double.Epsilon;
        var endChanged = Math.Abs(End - _prevEnd) > double.Epsilon;
        var startPercentChanged = Math.Abs(StartPercent - _prevStartPercent) > double.Epsilon;
        var endPercentChanged = Math.Abs(EndPercent - _prevEndPercent) > double.Epsilon;

        if (!startChanged && !endChanged && !startPercentChanged && !endPercentChanged) return;

        // Determine which set of parameters to use
        // Priority: StartPercent/EndPercent if changed, then Start/End
        if (startPercentChanged || endPercentChanged)
        {
            CurrentStartPercent = StartPercent;
            CurrentEndPercent = EndPercent;
        }
        else if (startChanged || endChanged)
        {
            CurrentStartPercent = (Start - Min) / (Max - Min) * 100;
            CurrentEndPercent = (End - Min) / (Max - Min) * 100;
        }

        // Update tracking variables
        _prevStart = Start;
        _prevEnd = End;
        _prevStartPercent = StartPercent;
        _prevEndPercent = EndPercent;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.initialize", _elementId, _dotNetRef, CurrentStartPercent, CurrentEndPercent,
                MinWidthPercent);
        }
    }

    [JSInvokable]
    public void HandleDragStart()
    {
        _isDragging = true;
    }

    [JSInvokable]
    public void HandleDragEnd()
    {
        _isDragging = false;
        // Trigger a render to ensure consistency
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleBrushChanged(double startPercent, double endPercent)
    {
        CurrentStartPercent = Math.Round(startPercent, 2);
        CurrentEndPercent = Math.Round(endPercent, 2);

        // Snap to step
        var start = SnapToStep(CurrentStart);
        var end = SnapToStep(CurrentEnd);

        await OnBrushChanged.InvokeAsync(new BrushChangedEventArgs<double>
        {
            Start = start,
            End = end,
            Min = Min,
            Max = Max,
            StartPercent = CurrentStartPercent,
            EndPercent = CurrentEndPercent
        });

        await InvokeAsync(StateHasChanged);
    }

    private double SnapToStep(double value)
    {
        return Math.Round(value / Step) * Step;
    }

    private string FormatValue(double value)
    {
        var snapped = SnapToStep(value);
        return string.IsNullOrEmpty(Format) ? snapped.ToString("N0") : snapped.ToString(Format);
    }

    private string GetRangeText()
    {
        var range = SnapToStep(CurrentEnd) - SnapToStep(CurrentStart);
        return string.IsNullOrEmpty(Format) ? range.ToString("N0") : range.ToString(Format);
    }

    private string GetInvariantPercent(double value)
    {
        return value.ToString("0.##", CultureInfo.InvariantCulture);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.dispose", _elementId);
        }
        catch
        {
        }

        _dotNetRef?.Dispose();
    }

}