@namespace Blazwind.Components.Range
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable
@inherits BwBase

@{
    var colorName = Color.ToString().ToLower();
    var brushFillClass = $"bw-brush-fill-{colorName}";
    var handleClass = $"bw-brush-handle bw-brush-handle-{colorName}";
    var barActiveClass = $"bw-brush-bar-active-{colorName}";
    var iconColorClass = $"bw-brush-icon-{colorName}";
    var presetActiveClass = $"bw-brush-preset-active-{colorName}";
}

<div class="@CombineClasses("bw-time-range-brush")" style="@Style" id="@_elementId" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="bw-brush-label">@Label</label>
    }

    @* Activity/Usage Chart *@
    @if (ShowActivityChart && Data?.Any() == true)
    {
        <div class="h-8 flex items-end gap-px mb-1">
            @foreach (var (point, index) in Data.Select((v, i) => (v, i)))
            {
                var height = MaxValue > 0 ? (point.Value / MaxValue) * 100 : 0;
                var isInRange = IsTimeInRange(point.Time);
                <div class="flex-1 rounded-t transition-all duration-150 @(isInRange? barActiveClass : "bg-gray-200 dark:bg-gray-700")"
                    style="height: @(Math.Max(2, height))%;" title="@point.Time.ToString(@"hh\:mm") - @point.Value">
                </div>
            }
        </div>
    }

    @* Brush Track *@
    <div class="bw-brush-track border border-gray-200 dark:border-gray-700">
        @* Inactive areas *@
        <div class="bw-brush-inactive left-0" style="width: @GetInvariantPercent(StartPercent)%;"></div>
        <div class="bw-brush-inactive right-0" style="width: @GetInvariantPercent(100 - EndPercent)%;"></div>

        @* Selection Brush *@
        <div class="bw-brush-selection @brushFillClass"
            style="left: @GetInvariantPercent(StartPercent)%; width: @GetInvariantPercent(EndPercent - StartPercent)%;">

            @* Left Handle *@
            <div class="bw-brush-handle-left @handleClass">
                <div class="w-0.5 h-4 bg-white/50 rounded-full"></div>
            </div>

            @* Grip *@
            <div class="bw-brush-grip">
                <div class="bw-brush-grip-bar" style="height: 0.625rem;"></div>
                <div class="bw-brush-grip-bar" style="height: 0.625rem;"></div>
            </div>

            @* Right Handle *@
            <div class="bw-brush-handle-right @handleClass">
                <div class="w-0.5 h-4 bg-white/50 rounded-full"></div>
            </div>
        </div>

        @* Time Scale *@
        @if (ShowTimeScale)
        {
            <div class="absolute -bottom-4 inset-x-0 flex justify-between text-[9px] text-gray-400 px-1">
                <span>@MinTime.ToString(@"hh\:mm")</span>
                @if (ShowQuarterMarks)
                {
                    <span>@MinTime.Add(TimeSpan.FromMinutes(TotalMinutes / 4)).ToString(@"hh\:mm")</span>
                    <span>@MinTime.Add(TimeSpan.FromMinutes(TotalMinutes / 2)).ToString(@"hh\:mm")</span>
                    <span>@MinTime.Add(TimeSpan.FromMinutes(TotalMinutes * 3 / 4)).ToString(@"hh\:mm")</span>
                }
                else
                {
                    <span>@MinTime.Add(TimeSpan.FromMinutes(TotalMinutes / 2)).ToString(@"hh\:mm")</span>
                }
                <span>@MaxTime.ToString(@"hh\:mm")</span>
            </div>
        }
    </div>

    @* Selected Time Display *@
    @if (ShowSelectedRange)
    {
        <div class="mt-5 flex items-center justify-center gap-3">
            <div
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                <i class="fa-regular fa-clock @iconColorClass text-xs"></i>
                <span
                    class="text-sm font-mono font-medium text-gray-700 dark:text-gray-300">@CurrentStartTime.ToString(@"hh\:mm")</span>
            </div>
            <div class="flex items-center gap-1 text-gray-400">
                <i class="fa-solid fa-arrow-right text-xs"></i>
                <span class="text-xs">(@DurationText)</span>
            </div>
            <div
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                <i class="fa-regular fa-clock @iconColorClass text-xs"></i>
                <span
                    class="text-sm font-mono font-medium text-gray-700 dark:text-gray-300">@CurrentEndTime.ToString(@"hh\:mm")</span>
            </div>
        </div>
    }

    @* Quick Time Presets *@
    @if (Presets?.Any() == true)
    {
        <div class="mt-3 flex flex-wrap justify-center gap-2">
            @foreach (var preset in Presets)
            {
                <button type="button"
                    class="px-2 py-1 text-xs font-medium rounded-md transition-all
                                                               @(IsPresetActive(preset) ? presetActiveClass : "bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300")"
                    @onclick="() => ApplyPreset(preset)">
                    @preset.Label
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public TimeSpan MinTime { get; set; } = TimeSpan.Zero;
    [Parameter] public TimeSpan MaxTime { get; set; } = TimeSpan.FromHours(24);
    [Parameter] public TimeSpan StartTime { get; set; } = TimeSpan.FromHours(9);
    [Parameter] public TimeSpan EndTime { get; set; } = TimeSpan.FromHours(17);
    [Parameter] public TimeSpan Step { get; set; } = TimeSpan.FromMinutes(15);
    [Parameter] public double MinWidthPercent { get; set; } = 5;
    [Parameter] public string? Label { get; set; }
    [Parameter] public bool ShowSelectedRange { get; set; } = true;
    [Parameter] public bool ShowTimeScale { get; set; } = true;
    [Parameter] public bool ShowQuarterMarks { get; set; } = true;
    [Parameter] public bool ShowActivityChart { get; set; } = true;
    [Parameter] public List<TimeActivityPoint>? Data { get; set; }
    [Parameter] public List<TimeBrushPreset>? Presets { get; set; }
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    // Removed Class and Style parameters (inherited)
    [Parameter] public EventCallback<BrushChangedEventArgs<TimeSpan>> OnBrushChanged { get; set; }

    private string _elementId = "";
    private DotNetObjectReference<BwTimeRangeBrush>? _dotNetRef;
    private double _startPercent;
    private double _endPercent;

    private bool _isDragging;

    private TimeSpan _prevStart;
    private TimeSpan _prevEnd;
    private TimeSpan _prevMin;
    private TimeSpan _prevMax;

    private double StartPercent => _startPercent;
    private double EndPercent => _endPercent;
    private double TotalMinutes => (MaxTime - MinTime).TotalMinutes;
    private TimeSpan CurrentStartTime => SnapToStep(MinTime.Add(TimeSpan.FromMinutes(TotalMinutes * (_startPercent /
    100))));
    private TimeSpan CurrentEndTime => SnapToStep(MinTime.Add(TimeSpan.FromMinutes(TotalMinutes * (_endPercent / 100))));
    private double MaxValue => Data?.Max(x => x.Value) ?? 0;

    protected override bool ShouldRender() => !_isDragging;

    private string DurationText
    {
        get
        {
            var duration = CurrentEndTime - CurrentStartTime;
            if (duration.TotalHours >= 1)
                return $"{(int)duration.TotalHours}s {duration.Minutes}dk";
            return $"{duration.Minutes}dk";
        }
    }

    protected override void OnInitialized()
    {
        _elementId = Id ?? $"bw-time-brush-{Guid.NewGuid():N}";
        InitializeState();
    }

    private void InitializeState()
    {
        if (TotalMinutes > 0)
        {
            _startPercent = ((StartTime - MinTime).TotalMinutes / TotalMinutes) * 100;
            _endPercent = ((EndTime - MinTime).TotalMinutes / TotalMinutes) * 100;
        }

        _prevStart = StartTime;
        _prevEnd = EndTime;
        _prevMin = MinTime;
        _prevMax = MaxTime;
    }

    protected override void OnParametersSet()
    {
        if (_isDragging) return;

        bool paramsChanged = StartTime != _prevStart ||
        EndTime != _prevEnd ||
        MinTime != _prevMin ||
        MaxTime != _prevMax;

        if (!paramsChanged) return;

        if (TotalMinutes > 0)
        {
            _startPercent = ((StartTime - MinTime).TotalMinutes / TotalMinutes) * 100;
            _endPercent = ((EndTime - MinTime).TotalMinutes / TotalMinutes) * 100;
        }

        _prevStart = StartTime;
        _prevEnd = EndTime;
        _prevMin = MinTime;
        _prevMax = MaxTime;
    }

    [JSInvokable]
    public void HandleDragStart()
    {
        _isDragging = true;
    }

    [JSInvokable]
    public void HandleDragEnd()
    {
        _isDragging = false;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.initialize", _elementId, _dotNetRef, _startPercent, _endPercent,
            MinWidthPercent);
        }
    }

    [JSInvokable]
    public async Task HandleBrushChanged(double startPercent, double endPercent)
    {
        _startPercent = Math.Round(startPercent, 2);
        _endPercent = Math.Round(endPercent, 2);

        await OnBrushChanged.InvokeAsync(new BrushChangedEventArgs<TimeSpan>
        {
            Start = CurrentStartTime,
            End = CurrentEndTime,
            Min = MinTime,
            Max = MaxTime,
            StartPercent = _startPercent,
            EndPercent = _endPercent
        });

        await InvokeAsync(StateHasChanged);
    }

    private async Task ApplyPreset(TimeBrushPreset preset)
    {
        if (TotalMinutes <= 0) return;

        _startPercent = ((preset.StartTime - MinTime).TotalMinutes / TotalMinutes) * 100;
        _endPercent = ((preset.EndTime - MinTime).TotalMinutes / TotalMinutes) * 100;

        await JS.InvokeVoidAsync("Blazwind.RangeBrush.updatePosition", _elementId, _startPercent, _endPercent);

        await OnBrushChanged.InvokeAsync(new BrushChangedEventArgs<TimeSpan>
        {
            Start = preset.StartTime,
            End = preset.EndTime,
            Min = MinTime,
            Max = MaxTime,
            StartPercent = _startPercent,
            EndPercent = _endPercent
        });
    }

    private bool IsPresetActive(TimeBrushPreset preset)
    {
        return Math.Abs((CurrentStartTime - preset.StartTime).TotalMinutes) < Step.TotalMinutes &&
        Math.Abs((CurrentEndTime - preset.EndTime).TotalMinutes) < Step.TotalMinutes;
    }

    private bool IsTimeInRange(TimeSpan time)
    {
        if (TotalMinutes <= 0) return false;
        var percent = ((time - MinTime).TotalMinutes / TotalMinutes) * 100;
        return percent >= _startPercent && percent <= _endPercent;
    }

    private TimeSpan SnapToStep(TimeSpan time)
    {
        var stepMinutes = Step.TotalMinutes;
        var totalMinutes = Math.Round(time.TotalMinutes / stepMinutes) * stepMinutes;
        return TimeSpan.FromMinutes(totalMinutes);
    }

    private string GetInvariantPercent(double value) =>
    value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture);

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.dispose", _elementId);
        }
        catch { }

        _dotNetRef?.Dispose();
    }

    public class TimeActivityPoint
    {
        public TimeSpan Time { get; set; }
        public double Value { get; set; }
    }

    public class TimeBrushPreset
    {
        public string Label { get; set; } = "";
        public TimeSpan StartTime { get; set; }
        public TimeSpan EndTime { get; set; }
    }
}