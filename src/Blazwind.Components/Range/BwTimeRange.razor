@namespace Blazwind.Components.Range
@using Blazwind.Components.Shared
@inherits BwBase

@{
    var colorName = Color.ToString().ToLower();
    var focusClass = $"bw-range-focus-{colorName}";
    var durationClass = $"bw-range-duration-{colorName}";
}

<div class="@CombineClasses("bw-time-range")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="bw-range-input-label">@Label</label>
    }

    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
        @* Start Time *@
        <div class="flex-1">
            <div class="relative">
                <i
                    class="fa-regular fa-clock absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i>
                <input type="time" min="@Min?.ToString(@"hh\:mm")" max="@End?.ToString(@"hh\:mm")"
                       step="@((int)Step.TotalSeconds)" value="@Start?.ToString(@"hh\:mm")" class="w-full pl-10 pr-3 py-2.5 text-sm border rounded-lg focus:ring-2 focus:outline-none transition-all
                              bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600
                              text-gray-900 dark:text-white @focusClass" @onchange="HandleStartChange"/>
            </div>
        </div>

        @* Separator *@
        <div class="hidden sm:flex items-center justify-center px-2">
            <i class="fa-solid fa-arrow-right text-gray-400"></i>
        </div>

        @* End Time *@
        <div class="flex-1">
            <div class="relative">
                <i
                    class="fa-regular fa-clock absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i>
                <input type="time" min="@Start?.ToString(@"hh\:mm")" max="@Max?.ToString(@"hh\:mm")"
                       step="@((int)Step.TotalSeconds)" value="@End?.ToString(@"hh\:mm")" class="w-full pl-10 pr-3 py-2.5 text-sm border rounded-lg focus:ring-2 focus:outline-none transition-all
                              bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600
                              text-gray-900 dark:text-white @focusClass" @onchange="HandleEndChange"/>
            </div>
        </div>
    </div>

    @* Duration Display *@
    @if (ShowDuration && Start.HasValue && End.HasValue)
    {
        <div class="mt-2 text-center">
            <span class="inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-full @durationClass">
                <i class="fa-solid fa-hourglass-half text-xs"></i>
                <span>@GetDurationText()</span>
            </span>
        </div>
    }

    @* Quick Presets *@
    @if (ShowPresets)
    {
        <div class="mt-3 flex flex-wrap gap-2">
            <button type="button" class="@GetPresetClass("morning")" @onclick='() => ApplyPreset("morning")'>Sabah
            </button>
            <button type="button" class="@GetPresetClass("noon")" @onclick='() => ApplyPreset("noon")'>Öğle</button>
            <button type="button" class="@GetPresetClass("afternoon")" @onclick='() => ApplyPreset("afternoon")'>Öğleden
                Sonra
            </button>
            <button type="button" class="@GetPresetClass("evening")" @onclick='() => ApplyPreset("evening")'>Akşam
            </button>
            <button type="button" class="@GetPresetClass("work")" @onclick='() => ApplyPreset("work")'>Mesai Saati
            </button>
            <button type="button" class="@GetPresetClass("allday")" @onclick='() => ApplyPreset("allday")'>Tüm Gün
            </button>
        </div>
    }
</div>

@code {

    [Parameter]
    public TimeSpan? Min { get; set; } = TimeSpan.Zero;

    [Parameter]
    public TimeSpan? Max { get; set; } = new TimeSpan(23, 59, 59);

    [Parameter]
    public TimeSpan Step { get; set; } = TimeSpan.FromMinutes(15);

    [Parameter]
    public TimeSpan? Start { get; set; }

    [Parameter]
    public TimeSpan? End { get; set; }

    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public bool ShowDuration { get; set; } = true;

    [Parameter]
    public bool ShowPresets { get; set; } = true;

    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    // Removed Class and Style parameters (inherited)
    [Parameter]
    public EventCallback<RangeChangedEventArgs<TimeSpan?>> OnRangeChanged { get; set; }

    private string _activePreset = "";

    private async Task HandleStartChange(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e.Value?.ToString(), out var value))
        {
            Start = value;
            _activePreset = "";
            await NotifyChange();
        }
    }

    private async Task HandleEndChange(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e.Value?.ToString(), out var value))
        {
            End = value;
            _activePreset = "";
            await NotifyChange();
        }
    }

    private async Task ApplyPreset(string preset)
    {
        _activePreset = preset;

        (Start, End) = preset switch
        {
            "morning" => (new TimeSpan(6, 0, 0), new TimeSpan(12, 0, 0)),
            "noon" => (new TimeSpan(11, 0, 0), new TimeSpan(14, 0, 0)),
            "afternoon" => (new TimeSpan(12, 0, 0), new TimeSpan(18, 0, 0)),
            "evening" => (new TimeSpan(18, 0, 0), new TimeSpan(23, 0, 0)),
            "work" => (new TimeSpan(9, 0, 0), new TimeSpan(18, 0, 0)),
            "allday" => (TimeSpan.Zero, new TimeSpan(23, 59, 0)),
            _ => (Start, End)
        };

        await NotifyChange();
    }

    private async Task NotifyChange()
    {
        await OnRangeChanged.InvokeAsync(new RangeChangedEventArgs<TimeSpan?>
        {
            Start = Start,
            End = End,
            Min = Min,
            Max = Max
        });
    }

    private string GetDurationText()
    {
        if (!Start.HasValue || !End.HasValue) return "";
        var duration = End.Value - Start.Value;
        if (duration.TotalMinutes < 0) duration = duration.Add(TimeSpan.FromHours(24));

        if (duration.TotalHours >= 1)
        {
            var hours = (int)duration.TotalHours;
            var minutes = duration.Minutes;
            return minutes > 0 ? $"{hours} saat {minutes} dk" : $"{hours} saat";
        }

        return $"{(int)duration.TotalMinutes} dakika";
    }

    private string GetPresetClass(string preset)
    {
        var colorName = Color.ToString().ToLower();
        var baseClass = "bw-range-preset ";
        if (_activePreset == preset)
        {
            return baseClass + $"bw-range-preset-active-{colorName}";
        }

        return baseClass;
    }

}