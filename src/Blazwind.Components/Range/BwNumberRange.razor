@namespace Blazwind.Components.Range
@using Blazwind.Components.Shared
@inherits BwBase

@{
    var colorName = Color.ToString().ToLower();
    var focusClass = $"bw-range-focus-{colorName}";
}

<div class="@CombineClasses("bw-number-range")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="bw-range-input-label">@Label</label>
    }

    <div class="flex items-center gap-3">
        @* Start Input *@
        <div class="flex-1">
            <div class="relative">
                <input type="number" min="@Min" max="@End" step="@Step" value="@Start" class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:outline-none transition-all
                              bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600
                              text-gray-900 dark:text-white @focusClass" placeholder="@StartPlaceholder"
                    @onchange="HandleStartChange" />
                @if (!string.IsNullOrEmpty(Prefix))
                {
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Prefix</span>
                }
                @if (!string.IsNullOrEmpty(Suffix))
                {
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Suffix</span>
                }
            </div>
        </div>

        @* Separator *@
        <div class="flex items-center justify-center w-8">
            <i class="fa-solid fa-arrow-right text-gray-400"></i>
        </div>

        @* End Input *@
        <div class="flex-1">
            <div class="relative">
                <input type="number" min="@Start" max="@Max" step="@Step" value="@End" class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:outline-none transition-all
                              bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600
                              text-gray-900 dark:text-white @focusClass" placeholder="@EndPlaceholder"
                    @onchange="HandleEndChange" />
                @if (!string.IsNullOrEmpty(Prefix))
                {
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Prefix</span>
                }
                @if (!string.IsNullOrEmpty(Suffix))
                {
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Suffix</span>
                }
            </div>
        </div>
    </div>

    @* Slider *@
    @if (ShowSlider)
    {
        <div class="mt-3">
            <BwRange Min="@Min" Max="@Max" Step="@Step" Start="@Start" End="@End" Color="@Color" ShowValues="false"
                ShowSelection="false" OnRangeChanged="HandleSliderChange" />
        </div>
    }

    @* Quick Presets *@
    @if (Presets?.Any() == true)
    {
        <div class="mt-3 flex flex-wrap gap-2">
            @foreach (var preset in Presets)
            {
                <button type="button" class="@GetPresetClass(preset)" @onclick="() => ApplyPreset(preset)">
                    @preset.Label
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public double Min { get; set; } = 0;
    [Parameter] public double Max { get; set; } = 1000;
    [Parameter] public double Step { get; set; } = 1;
    [Parameter] public double Start { get; set; } = 0;
    [Parameter] public double End { get; set; } = 100;
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Prefix { get; set; }
    [Parameter] public string? Suffix { get; set; }
    [Parameter] public string? StartPlaceholder { get; set; } = "Min";
    [Parameter] public string? EndPlaceholder { get; set; } = "Max";
    [Parameter] public bool ShowSlider { get; set; } = true;
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    // Removed Class and Style parameters (inherited)
    [Parameter] public List<NumberRangePreset>? Presets { get; set; }
    [Parameter] public EventCallback<RangeChangedEventArgs<double>> OnRangeChanged { get; set; }

    private async Task HandleStartChange(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var value))
        {
            Start = Math.Max(Min, Math.Min(value, End));
            await NotifyChange();
        }
    }

    private async Task HandleEndChange(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var value))
        {
            End = Math.Min(Max, Math.Max(value, Start));
            await NotifyChange();
        }
    }

    private async Task HandleSliderChange(RangeChangedEventArgs<double> args)
    {
        Start = args.Start;
        End = args.End;
        await NotifyChange();
    }

    private async Task ApplyPreset(NumberRangePreset preset)
    {
        Start = preset.Start;
        End = preset.End;
        await NotifyChange();
    }

    private bool IsPresetActive(NumberRangePreset preset) => Start == preset.Start && End == preset.End;

    private async Task NotifyChange()
    {
        await OnRangeChanged.InvokeAsync(new RangeChangedEventArgs<double>
        {
            Start = Start,
            End = End,
            Min = Min,
            Max = Max
        });
    }

    private string GetPresetClass(NumberRangePreset preset)
    {
        var colorName = Color.ToString().ToLower();
        var baseClass = "bw-range-preset ";
        if (IsPresetActive(preset))
        {
            return baseClass + $"bw-range-preset-active-{colorName}";
        }
        return baseClass;
    }

    public class NumberRangePreset
    {
        public string Label { get; set; } = "";
        public double Start { get; set; }
        public double End { get; set; }
    }
}