@namespace Blazwind.Components.Range
@using Blazwind.Components.Shared

<div class="bw-number-range @Class" style="@Style">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">@Label</label>
    }

    <div class="flex items-center gap-3">
        @* Start Input *@
        <div class="flex-1">
            <div class="relative">
                <input type="number" min="@Min" max="@End" step="@Step" value="@Start" class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:outline-none transition-all
                              bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600
                              text-gray-900 dark:text-white @GetFocusRingClass()" placeholder="@StartPlaceholder"
                    @onchange="HandleStartChange" />
                @if (!string.IsNullOrEmpty(Prefix))
                {
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Prefix</span>
                }
                @if (!string.IsNullOrEmpty(Suffix))
                {
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Suffix</span>
                }
            </div>
        </div>

        @* Separator *@
        <div class="flex items-center justify-center w-8">
            <i class="fa-solid fa-arrow-right text-gray-400"></i>
        </div>

        @* End Input *@
        <div class="flex-1">
            <div class="relative">
                <input type="number" min="@Start" max="@Max" step="@Step" value="@End" class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:outline-none transition-all
                              bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600
                              text-gray-900 dark:text-white @GetFocusRingClass()" placeholder="@EndPlaceholder"
                    @onchange="HandleEndChange" />
                @if (!string.IsNullOrEmpty(Prefix))
                {
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Prefix</span>
                }
                @if (!string.IsNullOrEmpty(Suffix))
                {
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">@Suffix</span>
                }
            </div>
        </div>
    </div>

    @* Slider *@
    @if (ShowSlider)
    {
        <div class="mt-3">
            <BwRange Min="@Min" Max="@Max" Step="@Step" Start="@Start" End="@End" Color="@Color" ShowValues="false"
                ShowSelection="false" OnRangeChanged="HandleSliderChange" />
        </div>
    }

    @* Quick Presets *@
    @if (Presets?.Any() == true)
    {
        <div class="mt-3 flex flex-wrap gap-2">
            @foreach (var preset in Presets)
            {
                <button type="button"
                    class="px-2 py-1 text-xs rounded-md transition-colors
                                       @(IsPresetActive(preset) ? GetActivePresetClass() : "bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600")"
                    @onclick="() => ApplyPreset(preset)">
                    @preset.Label
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public double Min { get; set; } = 0;
    [Parameter] public double Max { get; set; } = 1000;
    [Parameter] public double Step { get; set; } = 1;
    [Parameter] public double Start { get; set; } = 0;
    [Parameter] public double End { get; set; } = 100;
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Prefix { get; set; }
    [Parameter] public string? Suffix { get; set; }
    [Parameter] public string? StartPlaceholder { get; set; } = "Min";
    [Parameter] public string? EndPlaceholder { get; set; } = "Max";
    [Parameter] public bool ShowSlider { get; set; } = true;
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public List<NumberRangePreset>? Presets { get; set; }
    [Parameter] public EventCallback<RangeChangedEventArgs<double>> OnRangeChanged { get; set; }

    private async Task HandleStartChange(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var value))
        {
            Start = Math.Max(Min, Math.Min(value, End));
            await NotifyChange();
        }
    }

    private async Task HandleEndChange(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var value))
        {
            End = Math.Min(Max, Math.Max(value, Start));
            await NotifyChange();
        }
    }

    private async Task HandleSliderChange(RangeChangedEventArgs<double> args)
    {
        Start = args.Start;
        End = args.End;
        await NotifyChange();
    }

    private async Task ApplyPreset(NumberRangePreset preset)
    {
        Start = preset.Start;
        End = preset.End;
        await NotifyChange();
    }

    private bool IsPresetActive(NumberRangePreset preset) => Start == preset.Start && End == preset.End;

    private async Task NotifyChange()
    {
        await OnRangeChanged.InvokeAsync(new RangeChangedEventArgs<double>
        {
            Start = Start,
            End = End,
            Min = Min,
            Max = Max
        });
    }

    private string GetFocusRingClass() => Color switch
    {
        BwColor.Primary => "focus:ring-blue-500/30 focus:border-blue-500",
        BwColor.Success => "focus:ring-green-500/30 focus:border-green-500",
        BwColor.Danger => "focus:ring-red-500/30 focus:border-red-500",
        BwColor.Warning => "focus:ring-yellow-500/30 focus:border-yellow-500",
        BwColor.Info => "focus:ring-cyan-500/30 focus:border-cyan-500",
        _ => "focus:ring-blue-500/30 focus:border-blue-500"
    };

    private string GetActivePresetClass() => Color switch
    {
        BwColor.Primary => "bg-blue-500 text-white",
        BwColor.Success => "bg-green-500 text-white",
        BwColor.Danger => "bg-red-500 text-white",
        BwColor.Warning => "bg-yellow-500 text-white",
        BwColor.Info => "bg-cyan-500 text-white",
        _ => "bg-blue-500 text-white"
    };

    public class NumberRangePreset
    {
        public string Label { get; set; } = "";
        public double Start { get; set; }
        public double End { get; set; }
    }
}