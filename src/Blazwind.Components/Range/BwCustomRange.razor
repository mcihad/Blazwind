@namespace Blazwind.Components.Range
@inject IJSRuntime JS
@typeparam TValue
@implements IAsyncDisposable
@using System.Globalization
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inherits BwBase

@{
    var colorName = Color.ToString().ToLower();
    var brushFillClass = $"bw-brush-fill-{colorName}";
    var handleClass = $"bw-brush-handle bw-brush-handle-{colorName}";
}

<div class="@CombineClasses("bw-custom-range")" style="@Style" id="@_elementId" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="bw-custom-range-label">@Label</label>
    }

    @* Custom Content Area (Chart, etc.) *@
    @if (ChildContent != null)
    {
        <div class="relative mb-1">
            @ChildContent
        </div>
    }

    @* Brush Track *@
    <div class="bw-brush-track" style="height: 2rem;">
        @* Inactive Left *@
        <div class="bw-brush-inactive left-0" style="width: @GetInvariantPercent(_startPercent)%;"></div>
        @* Inactive Right *@
        <div class="bw-brush-inactive right-0" style="width: @GetInvariantPercent(100 - _endPercent)%;"></div>

        @* Selection Brush *@
        <div class="bw-brush-selection @brushFillClass"
             style="left: @GetInvariantPercent(_startPercent)%; width: @GetInvariantPercent(_endPercent - _startPercent)%;">

            @* Left Handle *@
            <div class="bw-brush-handle-left @handleClass">
                <div class="bw-brush-handle-bar"></div>
            </div>

            @* Center Grip Pattern *@
            <div class="bw-brush-grip">
                @for (var i = 0; i < 3; i++)
                {
                    <div class="bw-brush-grip-bar"></div>
                }
            </div>

            @* Right Handle *@
            <div class="bw-brush-handle-right @handleClass">
                <div class="bw-brush-handle-bar"></div>
            </div>
        </div>

        @* Scale Markers *@
        @if (ShowScale && ScaleLabels?.Any() == true)
        {
            <div class="absolute -bottom-4 inset-x-0 flex justify-between text-[9px] text-gray-400 px-1">
                @foreach (var label in ScaleLabels)
                {
                    <span>@label</span>
                }
            </div>
        }
    </div>

    @* Custom Value Display *@
    @if (ShowValues && ValueTemplate != null)
    {
        <div class="mt-5 flex items-center justify-center">
            @ValueTemplate((StartPercent, EndPercent))
        </div>
    }
    else if (ShowValues && FormatStart != null && FormatEnd != null)
    {
        <div class="mt-5 flex items-center justify-center gap-3">
            <div class="px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">@FormatStart(StartPercent)</span>
            </div>
            <i class="fa-solid fa-arrow-right text-gray-400 text-xs"></i>
            <div class="px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">@FormatEnd(EndPercent)</span>
            </div>
        </div>
    }

    @* Action Buttons *@
    @if (Actions != null)
    {
        <div class="mt-3 flex justify-center">
            @Actions
        </div>
    }
</div>

@code {

    [Parameter]
    public double StartPercent { get; set; } = 20;

    [Parameter]
    public double EndPercent { get; set; } = 80;

    [Parameter]
    public double MinWidthPercent { get; set; } = 5;

    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public bool ShowValues { get; set; } = true;

    [Parameter]
    public bool ShowScale { get; set; } = true;

    [Parameter]
    public List<string>? ScaleLabels { get; set; }

    [Parameter]
    public Func<double, string>? FormatStart { get; set; }

    [Parameter]
    public Func<double, string>? FormatEnd { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public RenderFragment<(double Start, double End)>? ValueTemplate { get; set; }

    [Parameter]
    public RenderFragment? Actions { get; set; }

    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    // Removed Class and Style parameters (inherited)
    [Parameter]
    public EventCallback<(double StartPercent, double EndPercent)> OnBrushChanged { get; set; }

    [Parameter]
    public EventCallback<(TValue Start, TValue End)> OnValueChanged { get; set; }

    [Parameter]
    public Func<double, TValue>? ConvertFromPercent { get; set; }

    private string _elementId = "";
    private DotNetObjectReference<BwCustomRange<TValue>>? _dotNetRef;
    private double _startPercent;
    private double _endPercent;

    private bool _isDragging;

    private double _prevStart;
    private double _prevEnd;

    protected override bool ShouldRender()
    {
        return !_isDragging;
    }

    protected override void OnInitialized()
    {
        _elementId = Id ?? $"bw-custom-range-{Guid.NewGuid():N}";
        InitializeState();
    }

    private void InitializeState()
    {
        _startPercent = StartPercent;
        _endPercent = EndPercent;

        _prevStart = StartPercent;
        _prevEnd = EndPercent;
    }

    protected override void OnParametersSet()
    {
        if (_isDragging) return;

        var paramsChanged = Math.Abs(StartPercent - _prevStart) > double.Epsilon ||
                            Math.Abs(EndPercent - _prevEnd) > double.Epsilon;

        if (!paramsChanged) return;

        _startPercent = StartPercent;
        _endPercent = EndPercent;

        _prevStart = StartPercent;
        _prevEnd = EndPercent;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.initialize", _elementId, _dotNetRef, _startPercent, _endPercent,
                MinWidthPercent);
        }
    }

    [JSInvokable]
    public void HandleDragStart()
    {
        _isDragging = true;
    }

    [JSInvokable]
    public void HandleDragEnd()
    {
        _isDragging = false;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleBrushChanged(double startPercent, double endPercent)
    {
        _startPercent = Math.Round(startPercent, 2);
        _endPercent = Math.Round(endPercent, 2);

        await OnBrushChanged.InvokeAsync((_startPercent, _endPercent));

        if (ConvertFromPercent != null)
        {
            var startValue = ConvertFromPercent(_startPercent);
            var endValue = ConvertFromPercent(_endPercent);
            await OnValueChanged.InvokeAsync((startValue, endValue));
        }

        await InvokeAsync(StateHasChanged);
    }

    public async Task UpdatePositionAsync(double startPercent, double endPercent)
    {
        _startPercent = startPercent;
        _endPercent = endPercent;

        await JS.InvokeVoidAsync("Blazwind.RangeBrush.updatePosition", _elementId, _startPercent, _endPercent);
        StateHasChanged();
    }

    private string GetInvariantPercent(double value)
    {
        return value.ToString("0.##", CultureInfo.InvariantCulture);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.dispose", _elementId);
        }
        catch
        {
        }

        _dotNetRef?.Dispose();
    }

}