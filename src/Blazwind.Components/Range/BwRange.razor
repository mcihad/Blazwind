@namespace Blazwind.Components.Range
@inject IJSRuntime JS
@implements IAsyncDisposable
@using System.Globalization
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inherits BwBase

@{
    var colorName = Color.ToString().ToLower();
    var fillClass = $"bw-range-fill-{colorName}";
    var thumbClass = $"bw-range-thumb bw-range-thumb-{colorName}";
    var tooltipClass = $"bw-range-tooltip bw-range-tooltip-{colorName}";
    var selectionClass = $"bw-range-selection-{colorName}";
}

<div class="@CombineClasses("bw-range")" style="@Style" id="@_elementId" @attributes="AdditionalAttributes">
    <div class="flex items-center gap-4">
        @if (!string.IsNullOrEmpty(Label))
        {
            <label class="bw-range-label">@Label</label>
        }

        <div class="flex-1 flex items-center gap-3">
            @* Min Value Display *@
            @if (ShowValues)
            {
                <span class="bw-range-value text-right">@FormatValue(Min)</span>
            }

            @* Dual Range Slider Track *@
            <div class="bw-range-track flex-1 select-none">
                @* Track Background *@
                <div class="bw-range-track-bg"></div>

                @* Active Range *@
                <div class="bw-active-range absolute h-2 rounded-full @fillClass"
                     style="left: @GetInvariantPercent(_startPercent)%; width: @GetInvariantPercent(_endPercent - _startPercent)%;">
                </div>

                @* Start Thumb *@
                <div class="bw-range-thumb-start @thumbClass" style="left: @GetInvariantPercent(_startPercent)%;">
                    @if (ShowTooltip)
                    {
                        <div class="bw-tooltip-start @tooltipClass">
                            @FormatValue(_currentStart)
                        </div>
                    }
                </div>

                @* End Thumb *@
                <div class="bw-range-thumb-end @thumbClass" style="left: @GetInvariantPercent(_endPercent)%;">
                    @if (ShowTooltip)
                    {
                        <div class="bw-tooltip-end @tooltipClass">
                            @FormatValue(_currentEnd)
                        </div>
                    }
                </div>
            </div>

            @* Max Value Display *@
            @if (ShowValues)
            {
                <span class="bw-range-value">@FormatValue(Max)</span>
            }
        </div>
    </div>

    @* Current Selection Display *@
    @if (ShowSelection)
    {
        <div class="mt-2 text-center">
            <span class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-full @selectionClass">
                <span>@FormatValue(_currentStart)</span>
                <i class="fa-solid fa-arrow-right text-xs opacity-60"></i>
                <span>@FormatValue(_currentEnd)</span>
            </span>
        </div>
    }
</div>

@code {

    [Parameter]
    public double Min { get; set; }

    [Parameter]
    public double Max { get; set; } = 100;

    [Parameter]
    public double Step { get; set; } = 1;

    [Parameter]
    public double Start { get; set; }

    [Parameter]
    public double End { get; set; } = 100;

    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public bool ShowValues { get; set; } = true;

    [Parameter]
    public bool ShowSelection { get; set; } = true;

    [Parameter]
    public bool ShowTooltip { get; set; } = true;

    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    [Parameter]
    public string? Format { get; set; }

    // Removed Class and Style parameters (inherited)
    [Parameter]
    public EventCallback<RangeChangedEventArgs<double>> OnRangeChanged { get; set; }

    private string _elementId = "";
    private DotNetObjectReference<BwRange>? _dotNetRef;
    private double _currentStart;
    private double _currentEnd;
    private double _startPercent;
    private double _endPercent;
    private bool _isDraggingStart;
    private bool _isDraggingEnd;

    private double _prevStart;
    private double _prevEnd;
    private double _prevMin;
    private double _prevMax;

    private bool IsDragging => _isDraggingStart || _isDraggingEnd;

    protected override bool ShouldRender()
    {
        return !IsDragging;
    }

    protected override void OnInitialized()
    {
        _elementId = Id ?? $"bw-range-{Guid.NewGuid():N}";
        InitializeState();
    }

    private void InitializeState()
    {
        _currentStart = Start;
        _currentEnd = End;

        _prevStart = Start;
        _prevEnd = End;
        _prevMin = Min;
        _prevMax = Max;

        UpdatePercentages();
    }

    protected override void OnParametersSet()
    {
        if (IsDragging) return;

        var paramsChanged = Math.Abs(Start - _prevStart) > double.Epsilon ||
                            Math.Abs(End - _prevEnd) > double.Epsilon ||
                            Math.Abs(Min - _prevMin) > double.Epsilon ||
                            Math.Abs(Max - _prevMax) > double.Epsilon;

        if (!paramsChanged) return;

        _currentStart = Start;
        _currentEnd = End;

        _prevStart = Start;
        _prevEnd = End;
        _prevMin = Min;
        _prevMax = Max;

        UpdatePercentages();
    }

    private void UpdatePercentages()
    {
        if (Max > Min)
        {
            _startPercent = (_currentStart - Min) / (Max - Min) * 100;
            _endPercent = (_currentEnd - Min) / (Max - Min) * 100;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("Blazwind.RangeSlider.initialize", _elementId, _dotNetRef, Min, Max, Step, _startPercent,
                _endPercent);
        }
    }

    [JSInvokable]
    public async Task HandleThumbChanged(string thumb, double percent)
    {
        var value = Min + (Max - Min) * (percent / 100);
        value = SnapToStep(value);

        if (thumb == "start")
        {
            _isDraggingStart = true;
            _isDraggingEnd = false;
            _currentStart = Math.Min(value, _currentEnd - Step);
            _currentStart = Math.Max(_currentStart, Min);
        }
        else
        {
            _isDraggingStart = false;
            _isDraggingEnd = true;
            _currentEnd = Math.Max(value, _currentStart + Step);
            _currentEnd = Math.Min(_currentEnd, Max);
        }

        UpdatePercentages();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleDragEnd()
    {
        _isDraggingStart = false;
        _isDraggingEnd = false;

        await OnRangeChanged.InvokeAsync(new RangeChangedEventArgs<double>
        {
            Start = _currentStart,
            End = _currentEnd,
            Min = Min,
            Max = Max
        });

        StateHasChanged();
    }

    private double SnapToStep(double value)
    {
        return Math.Round(value / Step) * Step;
    }

    private string FormatValue(double value)
    {
        return string.IsNullOrEmpty(Format) ? value.ToString("N0") : value.ToString(Format);
    }

    private string GetInvariantPercent(double value)
    {
        return value.ToString("0.##", CultureInfo.InvariantCulture);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("Blazwind.RangeSlider.dispose", _elementId);
        }
        catch
        {
        }

        _dotNetRef?.Dispose();
    }

}