@namespace Blazwind.Components.Notification
@using Blazwind.Components.Shared
@using Blazwind.Components.Services
@inject NotificationService NotificationService
@inherits BwBase

<div class="@CombineClasses("relative inline-block")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    <button type="button" class="relative w-10 h-10 border-none bg-transparent rounded-full cursor-pointer flex items-center justify-center text-gray-500 dark:text-gray-400 text-lg transition-all hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white" @onclick="TogglePanel">
        <i class="fa-solid fa-bell"></i>
        @if (_unreadCount > 0)
        {
            <span class="absolute top-0.5 right-0.5 min-w-[18px] h-[18px] px-1 bg-red-500 text-white text-[10px] font-semibold rounded-full flex items-center justify-center">
                @(_unreadCount > 99 ? "99+" : _unreadCount)
            </span>
        }
    </button>
    
    @if (_isOpen)
    {
        <div class="absolute top-full right-0 mt-2 w-[360px] max-h-[480px] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow-lg shadow-black/10 z-50 overflow-hidden animate-in fade-in slide-in-from-top-2 duration-150">
            <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                <span class="font-semibold text-sm text-gray-900 dark:text-white">Bildirimler</span>
                @if (_notifications.Any())
                {
                    <button type="button" class="border-none bg-transparent text-blue-600 dark:text-blue-400 text-xs cursor-pointer px-2 py-1 rounded transition-colors hover:bg-blue-50 dark:hover:bg-blue-900/20" @onclick="ClearAll">
                        Tümünü Temizle
                    </button>
                }
            </div>
            
            <div class="max-h-[400px] overflow-y-auto">
                @if (_notifications.Any())
                {
                    @foreach (var notification in _notifications)
                    {
                        var bgClass = notification.IsRead ? "bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700" : "bg-blue-50 dark:bg-blue-900/10 hover:bg-blue-100 dark:hover:bg-blue-900/20";
                        var iconBgClass = notification.Type switch
                        {
                            NotificationType.Success => "bg-green-100 text-green-600 dark:bg-green-900/20 dark:text-green-400",
                            NotificationType.Warning => "bg-yellow-100 text-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-400",
                            NotificationType.Error => "bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400",
                            _ => "bg-blue-100 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400"
                        };
                        
                        <div class="flex items-start gap-3 px-4 py-3 border-b border-gray-100 dark:border-gray-700 cursor-pointer transition-colors @bgClass group"
                             @onclick="() => MarkAsRead(notification)">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm flex-shrink-0 @iconBgClass">
                                <i class="@GetIcon(notification.Type)"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="m-0 text-[13px] text-gray-900 dark:text-gray-200 leading-snug">@notification.Message</p>
                                <span class="text-[11px] text-gray-400 dark:text-gray-500 mt-1 block">@GetTimeAgo(notification.CreatedAt)</span>
                            </div>
                            <button type="button" class="w-6 h-6 border-none bg-transparent text-gray-400 dark:text-gray-500 cursor-pointer rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:bg-gray-200 dark:hover:bg-gray-600 hover:text-gray-900 dark:hover:text-white" @onclick:stopPropagation="true" @onclick="() => Dismiss(notification)">
                                <i class="fa-solid fa-times text-xs"></i>
                            </button>
                        </div>
                    }
                }
                else
                {
                    <div class="py-12 px-4 text-center text-gray-400 dark:text-gray-500">
                        <i class="fa-solid fa-bell-slash text-3xl mb-2"></i>
                        <p class="m-0 text-sm">Bildirim yok</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    // Removed Class parameter (inherited)
    
    private bool _isOpen = false;
    private List<NotificationItem> _notifications = new();
    private int _unreadCount => _notifications.Count(n => !n.IsRead);
    
    protected override void OnInitialized()
    {
        NotificationService.OnNotificationsChanged += RefreshNotifications;
        RefreshNotifications();
    }
    
    private void RefreshNotifications()
    {
        _notifications = NotificationService.Notifications.OrderByDescending(n => n.CreatedAt).ToList();
        InvokeAsync(StateHasChanged);
    }
    
    private void TogglePanel() => _isOpen = !_isOpen;
    
    private void MarkAsRead(NotificationItem notification)
    {
        NotificationService.MarkAsRead(notification.Id);
    }
    
    private void Dismiss(NotificationItem notification)
    {
        NotificationService.Remove(notification.Id);
    }
    
    private void ClearAll()
    {
        NotificationService.ClearAll();
        _isOpen = false;
    }
    
    private string GetIcon(NotificationType type) => type switch
    {
        NotificationType.Success => "fa-solid fa-check-circle",
        NotificationType.Warning => "fa-solid fa-exclamation-triangle",
        NotificationType.Error => "fa-solid fa-times-circle",
        _ => "fa-solid fa-info-circle"
    };
    
    private string GetTimeAgo(DateTime time)
    {
        var diff = DateTime.Now - time;
        if (diff.TotalMinutes < 1) return "Şimdi";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} dk önce";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} saat önce";
        return $"{(int)diff.TotalDays} gün önce";
    }
    
    public void Dispose()
    {
        NotificationService.OnNotificationsChanged -= RefreshNotifications;
    }
}
