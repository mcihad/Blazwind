@namespace Blazwind.Components.Notification
@inject NotificationService NotificationService
@inherits BwBase

<div class="@CombineClasses("relative inline-block")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    <button type="button" class="bw-notification-btn" @onclick="TogglePanel">
        <i class="fa-solid fa-bell"></i>
        @if (_unreadCount > 0)
        {
            <span class="bw-notification-badge">
                @(_unreadCount > 99 ? "99+" : _unreadCount)
            </span>
        }
    </button>

    @if (_isOpen)
    {
        <div class="bw-notification-panel animate-in fade-in slide-in-from-top-2 duration-150">
            <div class="bw-notification-header">
                <span class="bw-notification-title">Bildirimler</span>
                @if (_notifications.Any())
                {
                    <button type="button" class="bw-notification-clear-btn" @onclick="ClearAll">
                        Tümünü Temizle
                    </button>
                }
            </div>

            <div class="bw-notification-list">
                @if (_notifications.Any())
                {
                    @foreach (var notification in _notifications)
                    {
                        var itemClass = notification.IsRead ? "" : "unread";
                        var iconTypeClass = notification.Type switch
                        {
                            NotificationType.Success => "success",
                            NotificationType.Warning => "warning",
                            NotificationType.Error => "error",
                            _ => "info"
                        };

                        <div class="bw-notification-item @itemClass group"
                             @onclick="() => MarkAsRead(notification)">
                            <div class="bw-notification-icon @iconTypeClass">
                                <i class="@GetIcon(notification.Type)"></i>
                            </div>
                            <div class="bw-notification-content">
                                <p class="bw-notification-message">@notification.Message</p>
                                <span class="bw-notification-time">@GetTimeAgo(notification.CreatedAt)</span>
                            </div>
                            <button type="button" class="bw-notification-dismiss group-hover:opacity-100"
                                    @onclick:stopPropagation="true" @onclick="() => Dismiss(notification)">
                                <i class="fa-solid fa-times text-xs"></i>
                            </button>
                        </div>
                    }
                }
                else
                {
                    <div class="bw-notification-empty">
                        <i class="fa-solid fa-bell-slash text-3xl mb-2"></i>
                        <p class="m-0 text-sm">Bildirim yok</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    // Removed Class parameter (inherited)

    private bool _isOpen;
    private List<NotificationItem> _notifications = new();
    private int _unreadCount => _notifications.Count(n => !n.IsRead);

    protected override void OnInitialized()
    {
        NotificationService.OnNotificationsChanged += RefreshNotifications;
        RefreshNotifications();
    }

    private void RefreshNotifications()
    {
        _notifications = NotificationService.Notifications.OrderByDescending(n => n.CreatedAt).ToList();
        InvokeAsync(StateHasChanged);
    }

    private void TogglePanel()
    {
        _isOpen = !_isOpen;
    }

    private void MarkAsRead(NotificationItem notification)
    {
        NotificationService.MarkAsRead(notification.Id);
    }

    private void Dismiss(NotificationItem notification)
    {
        NotificationService.Remove(notification.Id);
    }

    private void ClearAll()
    {
        NotificationService.ClearAll();
        _isOpen = false;
    }

    private string GetIcon(NotificationType type)
    {
        return type switch
        {
            NotificationType.Success => "fa-solid fa-check-circle",
            NotificationType.Warning => "fa-solid fa-exclamation-triangle",
            NotificationType.Error => "fa-solid fa-times-circle",
            _ => "fa-solid fa-info-circle"
        };
    }

    private string GetTimeAgo(DateTime time)
    {
        var diff = DateTime.Now - time;
        if (diff.TotalMinutes < 1) return "Şimdi";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} dk önce";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} saat önce";
        return $"{(int)diff.TotalDays} gün önce";
    }

    public void Dispose()
    {
        NotificationService.OnNotificationsChanged -= RefreshNotifications;
    }

}
