@namespace Blazwind.Components.BackToTop
@inherits BwBase
@inject IJSRuntime JS
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@implements IAsyncDisposable

@{
    var baseClass = "bw-backtotop";

    var sizeClass = Size switch
    {
        BwSize.Small => "bw-backtotop-sm",
        BwSize.Large => "bw-backtotop-lg",
        BwSize.ExtraLarge => "bw-backtotop-xl",
        BwSize.ExtraSmall => "bw-backtotop-xs",
        _ => "bw-backtotop-md"
    };

    var colorClass = $"bw-backtotop-{Color.ToString().ToLower()}";

    var positionClass = Position switch
    {
        BwPosition.BottomLeft => "bw-backtotop-bottom-left",
        _ => "bw-backtotop-bottom-right"
    };

    var shapeClass = Shape switch
    {
        "square" => "bw-backtotop-square",
        "rounded" => "bw-backtotop-rounded",
        _ => "bw-backtotop-circle"
    };

    var visibilityClass = _isVisible ? "bw-backtotop-visible" : "bw-backtotop-hidden";
}

<button type="button"
        class="@CombineClasses($"{baseClass} {positionClass} {sizeClass} {colorClass} {shapeClass} {visibilityClass}")"
        style="@Style" id="@Id" @onclick="ScrollToTop" title="@Tooltip" @attributes="AdditionalAttributes">
    @if (ChildContent != null)
    {
        @ChildContent
    }
    else
    {
        <i class="@Icon"></i>
    }
</button>

@code {

    [Parameter]
    public string Icon { get; set; } = "fa-solid fa-arrow-up";

    [Parameter]
    public string Tooltip { get; set; } = "Yukarı çık";

    [Parameter]
    public int VisibilityThreshold { get; set; } = 300;

    [Parameter]
    public bool Smooth { get; set; } = true;

    [Parameter]
    public BwSize Size { get; set; } = BwSize.Medium;

    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    [Parameter]
    public BwPosition Position { get; set; } = BwPosition.BottomRight;

    [Parameter]
    public string Shape { get; set; } = "circle";

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private readonly bool _isVisible = false;
    private DotNetObjectReference<BwBackToTop>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);

            await JS.InvokeVoidAsync("eval", $@"
(function() {{
// Configuration
var threshold = {VisibilityThreshold};
var elementId = '{Id}';
var scrollContainerId = null; // Can be added as parameter later if needed

function getScrollY() {{
    if (scrollContainerId) {{
        var container = document.getElementById(scrollContainerId);
        return container ? container.scrollTop : 0;
    }}
    return window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0;
}}

function checkVisibility() {{
    var isVisible = getScrollY() > threshold;
    var el = document.getElementById(elementId);
    if (el) {{
        if (isVisible) {{
            el.classList.remove('bw-backtotop-hidden');
            el.classList.add('bw-backtotop-visible');
        }} else {{
            el.classList.add('bw-backtotop-hidden');
            el.classList.remove('bw-backtotop-visible');
        }}
    }}
}}

// Attach to specific container if ID provided, otherwise window
var target = scrollContainerId ? document.getElementById(scrollContainerId) : window;
if (target) {{
    target.addEventListener('scroll', checkVisibility);
    // Also check on load/resize just in case
    window.addEventListener('resize', checkVisibility);
    checkVisibility(); // Initial check
}}

window['bwBackToTop_{Id}_cleanup'] = function() {{
    if (target) target.removeEventListener('scroll', checkVisibility);
    window.removeEventListener('resize', checkVisibility);
}};
}})();
");
        }
    }

    private async Task ScrollToTop()
    {
        var behavior = Smooth ? "smooth" : "instant";
        await JS.InvokeVoidAsync("eval", $@"
            var container = null; // document.getElementById('{ /*ScrollElementId*/""}'); 
            if (container) {{
                container.scrollTo({{ top: 0, behavior: '{behavior}' }});
            }} else {{
                window.scrollTo({{ top: 0, behavior: '{behavior}' }});
            }}
        ");
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", $"if(window['bwBackToTop_{Id}_cleanup']) window['bwBackToTop_{Id}_cleanup']();");
        }
        catch
        {
        }

        _dotNetRef?.Dispose();
    }

}