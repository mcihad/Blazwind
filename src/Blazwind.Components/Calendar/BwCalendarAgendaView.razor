@namespace Blazwind.Components.Calendar
@using Blazwind.Components.Shared

@{
    var culture = new System.Globalization.CultureInfo("tr-TR");
    var upcomingEvents = Events?
        .Where(e => e.StartTime.Date >= SelectedDate.Date)
        .OrderBy(e => e.StartTime)
        .GroupBy(e => e.StartTime.Date)
        .Take(14) // 2 weeks agenda
        .ToList() ?? new();
}

<div class="bw-calendar-agenda">
    @if (!upcomingEvents.Any())
    {
        @* Empty State - Premium Design *@
        <div class="flex flex-col items-center justify-center h-full text-center px-8 py-16">
            <div class="relative">
                <div class="absolute inset-0 rounded-full blur-2xl scale-150" style="background-color: color-mix(in srgb, var(--bw-color-primary) 10%, transparent);"></div>
                <div class="bw-calendar-agenda-empty-icon relative" style="box-shadow: 0 20px 25px -5px color-mix(in srgb, var(--bw-color-primary) 20%, transparent);">
                    <i class="fa-regular fa-calendar-check text-4xl text-white"></i>
                </div>
            </div>
            <h3 class="bw-calendar-agenda-empty-title">Yaklaşan etkinlik yok</h3>
            <p class="bw-calendar-agenda-empty-text">
                Takviminiz temiz görünüyor. Yeni etkinlik eklemek için takvime tıklayın.
            </p>
        </div>
    }
    else
    {
        <div class="p-4 sm:p-6 space-y-6">
            @foreach (var dayGroup in upcomingEvents)
            {
                var date = dayGroup.Key;
                var isToday = date == DateTime.Today;
                var isTomorrow = date == DateTime.Today.AddDays(1);
                var isThisWeek = date <= DateTime.Today.AddDays(7);
                
                var dateTitle = isToday ? "Bugün" : isTomorrow ? "Yarın" : date.ToString("d MMMM, dddd", culture);
                
                <div class="relative">
                    @* Date Header - Modern Glass Style *@
                    <div class="bw-calendar-agenda-date-header backdrop-blur-sm">
                        <div class="flex items-center gap-4">
                            @* Date Badge *@
                            <div class="flex-shrink-0 w-16 sm:w-20">
                                <div class="@(isToday ? "bw-calendar-agenda-date-badge bw-calendar-agenda-date-badge-today" : "bw-calendar-agenda-date-badge")">
                                    <div class="@(isToday ? "bw-calendar-agenda-date-month bw-calendar-agenda-date-month-today" : "bw-calendar-agenda-date-month")">
                                        @date.ToString("MMM", culture).ToUpper()
                                    </div>
                                    <div class="@(isToday ? "bw-calendar-agenda-date-day bw-calendar-agenda-date-day-today" : "bw-calendar-agenda-date-day")">
                                        @date.Day
                                    </div>
                                    <div class="@(isToday ? "bw-calendar-agenda-date-weekday bw-calendar-agenda-date-weekday-today" : "bw-calendar-agenda-date-weekday")">
                                        @date.ToString("ddd", culture)
                                    </div>
                                </div>
                            </div>
                            
                            @* Day Title & Count *@
                            <div class="flex-1 min-w-0">
                                <h3 class="bw-calendar-agenda-day-title">
                                    @dateTitle
                                </h3>
                                <p class="bw-calendar-agenda-day-count">
                                    @dayGroup.Count() etkinlik
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    @* Events List - Premium Cards *@
                    <div class="ml-20 sm:ml-24 space-y-3">
                        @foreach (var calendarEvent in dayGroup.OrderBy(e => e.StartTime))
                        {
                            var calendar = Calendars?.FirstOrDefault(c => c.Id == calendarEvent.CalendarId);
                            var eventColor = calendarEvent.Color ?? calendar?.Color ?? "#3B82F6";
                            var isPast = calendarEvent.EndTime < DateTime.Now;
                            
                            // Convert hex to rgba for background
                            var r = Convert.ToInt32(eventColor.Substring(1, 2), 16);
                            var g = Convert.ToInt32(eventColor.Substring(3, 2), 16);
                            var b = Convert.ToInt32(eventColor.Substring(5, 2), 16);
                            var bgColor = $"rgba({r}, {g}, {b}, 0.08)";
                            var borderColor = $"rgba({r}, {g}, {b}, 0.25)";
                            
                            <div class="bw-calendar-agenda-event @(isPast ? "bw-calendar-agenda-event-past" : "")"
                                 style="background: @bgColor; border-color: @borderColor;"
                                 @onclick="() => HandleEventClicked(calendarEvent)">
                                
                                @* Color Accent Bar *@
                                <div class="absolute left-0 top-0 bottom-0 w-1.5" 
                                     style="background: @eventColor;"></div>
                                
                                <div class="p-4 pl-5">
                                    <div class="flex items-start justify-between gap-4">
                                        @* Main Content *@
                                        <div class="flex-1 min-w-0">
                                            @* Time Badge *@
                                            <div class="flex items-center gap-2 mb-2">
                                                @if (calendarEvent.IsAllDay)
                                                {
                                                    <span class="bw-calendar-agenda-allday-badge">
                                                        <i class="fa-solid fa-sun text-[10px] mr-1.5"></i>
                                                        Tüm gün
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="bw-calendar-agenda-time-badge">
                                                        <i class="fa-regular fa-clock text-[10px] mr-1.5 opacity-70"></i>
                                                        @calendarEvent.StartTime.ToString("HH:mm") - @calendarEvent.EndTime.ToString("HH:mm")
                                                    </span>
                                                    
                                                    @* Duration *@
                                                    <span class="bw-calendar-agenda-duration">
                                                        (@(calendarEvent.DurationMinutes) dk)
                                                    </span>
                                                }
                                            </div>
                                            
                                            @* Title *@
                                            <h4 class="bw-calendar-agenda-event-title">
                                                @calendarEvent.Title
                                            </h4>
                                            
                                            @* Description *@
                                            @if (!string.IsNullOrEmpty(calendarEvent.Description))
                                            {
                                                <p class="bw-calendar-agenda-event-desc">
                                                    @calendarEvent.Description
                                                </p>
                                            }
                                            
                                            @* Meta Info *@
                                            @if (!string.IsNullOrEmpty(calendarEvent.Location) || calendar != null)
                                            {
                                                <div class="flex flex-wrap items-center gap-3 mt-3">
                                                    @if (!string.IsNullOrEmpty(calendarEvent.Location))
                                                    {
                                                        <span class="bw-calendar-agenda-event-meta">
                                                            <i class="fa-solid fa-location-dot text-[10px] mr-1.5 opacity-70"></i>
                                                            @calendarEvent.Location
                                                        </span>
                                                    }
                                                    
                                                    @if (calendar != null)
                                                    {
                                                        <span class="bw-calendar-agenda-event-meta">
                                                            <span class="w-2 h-2 rounded-full mr-1.5" style="background-color: @calendar.Color"></span>
                                                            @calendar.Name
                                                        </span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        
                                        @* Arrow Icon *@
                                        <div class="flex-shrink-0 bw-calendar-agenda-arrow">
                                            <i class="fa-solid fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            @* Load More Indicator *@
            <div class="bw-calendar-agenda-footer">
                Son 2 haftadaki etkinlikler gösteriliyor
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public DateTime SelectedDate { get; set; }
    [Parameter] public IEnumerable<CalendarEvent>? Events { get; set; }
    [Parameter] public IEnumerable<CalendarInfo>? Calendars { get; set; }
    [Parameter] public RenderFragment<CalendarEvent>? EventTemplate { get; set; }
    [Parameter] public EventCallback<CalendarEvent> OnEventClicked { get; set; }
    
    private async Task HandleEventClicked(CalendarEvent calendarEvent)
    {
        await OnEventClicked.InvokeAsync(calendarEvent);
    }
}
