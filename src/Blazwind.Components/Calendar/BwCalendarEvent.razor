@namespace Blazwind.Components.Calendar
@using Blazwind.Components.Shared
@using Microsoft.JSInterop

@inject IJSRuntime JS

@{
    var eventColor = !string.IsNullOrEmpty(Event.Color) 
        ? Event.Color 
        : CalendarColor ?? "#3B82F6";
    
    var isHex = eventColor.StartsWith("#");
    var bgStyle = isHex ? $"background-color: {eventColor}20; border-left-color: {eventColor};" : "";
    var textStyle = isHex ? $"color: {eventColor};" : "";
}

<div data-event-id="@Event.Id"
     class="group relative rounded px-2 py-1 border-l-2 cursor-pointer transition-all hover:shadow-md select-none @(Compact ? "text-xs" : "text-sm") @(!isHex ? $"bg-{eventColor}-50 border-{eventColor}-500 dark:bg-{eventColor}-900/30" : "")"
     style="@bgStyle @StyleOverride"
     @onmousedown="HandleMouseDown"
     @onmousedown:preventDefault="@_isDragging"
     @ontouchstart="HandleTouchStart"
     @onclick="HandleClick"
     @onclick:stopPropagation="true">
    
    @if (EventTemplate != null)
    {
        @* Custom template provided by user *@
        @EventTemplate(Event)
    }
    else
    {
        @* Default event rendering *@
        @* Title *@
        <div class="font-medium truncate @(!isHex ? $"text-{eventColor}-700 dark:text-{eventColor}-300" : "")" 
             style="@textStyle">
            @Event.Title
        </div>
        
        @if (!Compact && !Event.IsAllDay)
        {
            @* Time *@
            <div class="text-xs opacity-70 truncate @(!isHex ? $"text-{eventColor}-600 dark:text-{eventColor}-400" : "")"
                 style="@textStyle">
                @Event.StartTime.ToString("HH:mm") - @Event.EndTime.ToString("HH:mm")
            </div>
        }
        
        @if (!Compact && !string.IsNullOrEmpty(Event.Location))
        {
            @* Location *@
            <div class="text-xs opacity-60 truncate flex items-center gap-1 mt-0.5">
                <i class="fa-solid fa-location-dot text-[10px]"></i>
                @Event.Location
            </div>
        }
    }
    
    @if (AllowResize && !Compact)
    {
        @* Resize Handle *@
        <div class="absolute bottom-0 left-0 right-0 h-2 cursor-ns-resize opacity-0 group-hover:opacity-100 flex items-center justify-center"
             @onmousedown="HandleResizeStart"
             @onmousedown:stopPropagation="true"
             @ontouchstart="HandleResizeStart"
             @ontouchstart:stopPropagation="true">
            <div class="w-8 h-1 rounded-full bg-gray-400 dark:bg-gray-500"></div>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public CalendarEvent Event { get; set; } = default!;
    [Parameter] public string? CalendarColor { get; set; }
    [Parameter] public bool Compact { get; set; }
    [Parameter] public bool AllowResize { get; set; }
    [Parameter] public bool AllowDrag { get; set; } = true;
    [Parameter] public int DayIndex { get; set; }
    [Parameter] public int SlotHeight { get; set; } = 48;
    [Parameter] public int SlotMinutes { get; set; } = 30;
    [Parameter] public string? StyleOverride { get; set; }
    [Parameter] public EventCallback<CalendarEvent> OnClick { get; set; }
    [Parameter] public EventCallback<(string EventId, double ClientY)> OnResizeStart { get; set; }
    [Parameter] public RenderFragment<CalendarEvent>? EventTemplate { get; set; }
    
    private bool _isDragging = false;
    private double _startX;
    private double _startY;
    
    private async Task HandleMouseDown(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        if (!AllowDrag) return;
        
        _startX = e.ClientX;
        _startY = e.ClientY;
        _isDragging = true;
        
        // Start drag via JS
        await JS.InvokeVoidAsync("Blazwind.Calendar.startDrag", Event.Id, DayIndex, e.ClientX, e.ClientY, SlotHeight, SlotMinutes);
    }
    
    private async Task HandleClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        // Calculate distance to differentiate between click and drag
        var dx = e.ClientX - _startX;
        var dy = e.ClientY - _startY;
        var distance = Math.Sqrt(dx * dx + dy * dy);

        // Only trigger click if movement is small (less than 5 pixels)
        // implying it was a click, not a drag operation
        if (distance < 5)
        {
            await OnClick.InvokeAsync(Event);
        }
        _isDragging = false;
    }
    
    private async Task HandleTouchStart(Microsoft.AspNetCore.Components.Web.TouchEventArgs e)
    {
        if (!AllowDrag || e.Touches.Length == 0) return;
        
        var touch = e.Touches[0];
        _startX = touch.ClientX;
        _startY = touch.ClientY;
        _isDragging = true;
        
        // Start drag via JS
        await JS.InvokeVoidAsync("Blazwind.Calendar.startDrag", Event.Id, DayIndex, touch.ClientX, touch.ClientY, SlotHeight, SlotMinutes);
    }
    
    private async Task HandleResizeStart(EventArgs e)
    {
        if (e is Microsoft.AspNetCore.Components.Web.MouseEventArgs me)
        {
            await OnResizeStart.InvokeAsync((Event.Id, me.ClientY));
        }
        else if (e is Microsoft.AspNetCore.Components.Web.TouchEventArgs te && te.Touches.Length > 0)
        {
            await OnResizeStart.InvokeAsync((Event.Id, te.Touches[0].ClientY));
        }
    }
}
