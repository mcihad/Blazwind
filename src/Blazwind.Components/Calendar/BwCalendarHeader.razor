@using System.Globalization
@using Blazwind.Components.Segmented
@using Blazwind.Components.Shared
@namespace Blazwind.Components.Calendar

@{
    var headerTitle = View switch
    {
        BwCalendarView.Daily => SelectedDate.ToString("d MMMM yyyy, dddd", CultureInfo.InvariantCulture),
        BwCalendarView.Weekly => $"{WeekStart:d MMM} - {WeekEnd:d MMM yyyy}",
        BwCalendarView.Monthly => SelectedDate.ToString("MMMM yyyy", CultureInfo.InvariantCulture),
        BwCalendarView.Agenda => "Agenda",
        _ => ""
    };
}

<div class="bw-calendar-header">
    @* Left - Navigation and Title *@
    <div class="flex items-center gap-2 sm:gap-3 w-full sm:w-auto">
        @* Today Button *@
        <button type="button" class="bw-calendar-btn" @onclick="OnToday">
            Today
        </button>

        @* Navigation Buttons *@
        <div class="bw-calendar-nav-group">
            <button type="button" class="bw-calendar-nav-btn" @onclick="PreviousPeriod">
                <i class="fa-solid fa-chevron-left text-sm"></i>
            </button>
            <button type="button" class="bw-calendar-nav-btn bw-calendar-nav-btn-divider" @onclick="NextPeriod">
                <i class="fa-solid fa-chevron-right text-sm"></i>
            </button>
        </div>

        @* Title *@
        <h2 class="bw-calendar-title">
            @headerTitle
        </h2>
    </div>

    @* Right - View Selector & Fullscreen *@
    <div class="flex items-center gap-2 w-full sm:w-auto">
        @* View Selector *@
        <BwSegmented Options="@_viewOptions" Value="@View" ValueChanged="@OnViewValueChanged" Size="BwSize.Small" />

        @* Fullscreen Button *@
        @if (ShowFullscreenButton)
        {
            <button type="button" class="bw-calendar-fullscreen-btn" title="Fullscreen" @onclick="OnFullscreenToggle">
                <i class="fa-solid fa-expand text-sm"></i>
            </button>
        }
    </div>
</div>

@code {

    [Parameter]
    public DateTime SelectedDate { get; set; }

    [Parameter]
    public BwCalendarView View { get; set; }

    [Parameter]
    public IEnumerable<CalendarInfo>? Calendars { get; set; }

    [Parameter]
    public bool ShowFullscreenButton { get; set; } = true;

    [Parameter]
    public EventCallback<DateTime> OnDateChanged { get; set; }

    [Parameter]
    public EventCallback<BwCalendarView> OnViewChanged { get; set; }

    [Parameter]
    public EventCallback OnToday { get; set; }

    [Parameter]
    public EventCallback OnFullscreenToggle { get; set; }

    private DateTime WeekStart => SelectedDate.AddDays(-(((int)SelectedDate.DayOfWeek + 6) % 7));
    private DateTime WeekEnd => WeekStart.AddDays(6);

    // View options for BwSegmented
    private readonly List<BwSegmented.SegmentedOption> _viewOptions = new()
{
new() { Label = "Agenda", Value = BwCalendarView.Agenda },
new() { Label = "Day", Value = BwCalendarView.Daily },
new() { Label = "Week", Value = BwCalendarView.Weekly },
new() { Label = "Month", Value = BwCalendarView.Monthly }
};

    private async Task OnViewValueChanged(object? value)
    {
        if (value is BwCalendarView view)
        {
            await OnViewChanged.InvokeAsync(view);
        }
    }

    private async Task PreviousPeriod()
    {
        var newDate = View switch
        {
            BwCalendarView.Daily => SelectedDate.AddDays(-1),
            BwCalendarView.Weekly => SelectedDate.AddDays(-7),
            BwCalendarView.Monthly => SelectedDate.AddMonths(-1),
            BwCalendarView.Agenda => SelectedDate.AddDays(-7),
            _ => SelectedDate
        };
        await OnDateChanged.InvokeAsync(newDate);
    }

    private async Task NextPeriod()
    {
        var newDate = View switch
        {
            BwCalendarView.Daily => SelectedDate.AddDays(1),
            BwCalendarView.Weekly => SelectedDate.AddDays(7),
            BwCalendarView.Monthly => SelectedDate.AddMonths(1),
            BwCalendarView.Agenda => SelectedDate.AddDays(7),
            _ => SelectedDate
        };
        await OnDateChanged.InvokeAsync(newDate);
    }

}