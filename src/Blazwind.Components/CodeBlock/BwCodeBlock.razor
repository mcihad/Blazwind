@namespace Blazwind.Components.CodeBlock
@using Microsoft.JSInterop
@inherits BwBase
@inject IJSRuntime JS

@{
    var themeClass = Theme switch
    {
        "light" => "bw-code-block-light",
        _ => ""
    };
}

<div class="@CombineClasses($"bw-code-block {themeClass}")" style="@Style" id="@Id"
     @attributes="AdditionalAttributes">
    @if (ShowHeader)
    {
        <div class="bw-code-header">
            <div class="flex items-center gap-2">
                @if (ShowDots)
                {
                    <div class="flex gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(FileName))
                {
                    <span class="text-sm text-gray-400 ml-2">@FileName</span>
                }
            </div>

            <div class="flex items-center gap-2">
                @if (!string.IsNullOrEmpty(Language))
                {
                    <span class="bw-code-lang-tag">@Language</span>
                }
                @if (ShowCopyButton)
                {
                    <button type="button" class="bw-code-copy-btn" title="Kodu kopyala"
                            @onclick="CopyToClipboard">
                        <i class="@(_copied ? "fa-solid fa-check text-green-500" : "fa-solid fa-copy")"></i>
                    </button>
                }
            </div>
        </div>
    }

    <div class="relative">
        <pre class="bw-code-content @(ShowLineNumbers ? "bw-code-content-numbered" : "")"><code>@if (ShowLineNumbers)
                {
                    var lines = GetLines();
                    for (var i = 0; i < lines.Length; i++)
                    {
                        var lineNum = i + 1;
                        var isHighlighted = HighlightLines?.Contains(lineNum) == true;
                        var lineClass = isHighlighted ? "bw-code-line-highlight" : "";
                        <div class="@lineClass bw-code-line"><span
                                class="bw-code-line-number">@lineNum</span><span>@lines[i]</span></div>
                    }
                }
                else
                {
                    @Code
                }
</code></pre>
    </div>
</div>

@code {

    [Parameter]
    public string Code { get; set; } = "";

    [Parameter]
    public string? Language { get; set; }

    [Parameter]
    public string? FileName { get; set; }

    [Parameter]
    public string Theme { get; set; } = "dark";

    [Parameter]
    public bool ShowHeader { get; set; } = true;

    [Parameter]
    public bool ShowLineNumbers { get; set; } = true;

    [Parameter]
    public bool ShowCopyButton { get; set; } = true;

    [Parameter]
    public bool ShowDots { get; set; } = true;

    [Parameter]
    public int[]? HighlightLines { get; set; }

    private bool _copied;

    private string[] GetLines()
    {
        return Code.Split('\n');
    }

    private async Task CopyToClipboard()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", Code);
            _copied = true;
            StateHasChanged();

            await Task.Delay(2000);
            _copied = false;
            StateHasChanged();
        }
        catch
        {
        }
    }

}