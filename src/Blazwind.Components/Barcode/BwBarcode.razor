@namespace Blazwind.Components.Barcode
@using Blazwind.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@inherits BwBase
@using Microsoft.JSInterop
@inject IJSRuntime JS

<div class="@CombineClasses("bw-barcode")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium text-gray-700 mb-1">@Label</label>
    }
    
    @if (RenderAs == BarcodeRenderType.Svg)
    {
        <svg @ref="_element" class="block"></svg>
    }
    else
    {
        <canvas @ref="_element" class="block"></canvas>
    }
</div>

@code {
    private ElementReference _element;
    private bool _isInitialized;
    
    #region Parameters
    
    /// <summary>
    /// CSS class
    /// </summary>
    
    /// <summary>
    /// Label text
    /// </summary>
    [Parameter] public string? Label { get; set; }
    
    /// <summary>
    /// Barcode value
    /// </summary>
    [Parameter] public string Value { get; set; } = "";
    
    /// <summary>
    /// Barcode format
    /// </summary>
    [Parameter] public BarcodeFormat Format { get; set; } = BarcodeFormat.CODE128;
    
    /// <summary>
    /// Render type (SVG or Canvas)
    /// </summary>
    [Parameter] public BarcodeRenderType RenderAs { get; set; } = BarcodeRenderType.Svg;
    
    /// <summary>
    /// Bar width in pixels
    /// </summary>
    [Parameter] public int Width { get; set; } = 2;
    
    /// <summary>
    /// Barcode height in pixels
    /// </summary>
    [Parameter] public int Height { get; set; } = 100;
    
    /// <summary>
    /// Show value text below barcode
    /// </summary>
    [Parameter] public bool DisplayValue { get; set; } = true;
    
    /// <summary>
    /// Custom text to display (instead of value)
    /// </summary>
    [Parameter] public string? Text { get; set; }
    
    /// <summary>
    /// Font family for text
    /// </summary>
    [Parameter] public string Font { get; set; } = "monospace";
    
    /// <summary>
    /// Font size for text
    /// </summary>
    [Parameter] public int FontSize { get; set; } = 14;
    
    /// <summary>
    /// Text alignment
    /// </summary>
    [Parameter] public string TextAlign { get; set; } = "center";
    
    /// <summary>
    /// Background color
    /// </summary>
    [Parameter] public string Background { get; set; } = "#ffffff";
    
    /// <summary>
    /// Line (bar) color
    /// </summary>
    [Parameter] public string LineColor { get; set; } = "#000000";
    
    /// <summary>
    /// Margin around barcode
    /// </summary>
    [Parameter] public int Margin { get; set; } = 10;
    
    #endregion
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || !_isInitialized)
        {
            await GenerateBarcodeAsync();
            _isInitialized = true;
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (_isInitialized)
        {
            await GenerateBarcodeAsync();
        }
    }
    
    private async Task GenerateBarcodeAsync()
    {
        if (string.IsNullOrEmpty(Value)) return;
        
        try
        {
            var options = new Dictionary<string, object>
            {
                { "format", Format.ToString() },
                { "width", Width },
                { "height", Height },
                { "displayValue", DisplayValue },
                { "font", Font },
                { "fontSize", FontSize },
                { "textAlign", TextAlign },
                { "background", Background },
                { "lineColor", LineColor },
                { "margin", Margin }
            };

            if (!string.IsNullOrEmpty(Text))
            {
                options.Add("text", Text);
            }
            
            await JS.InvokeVoidAsync("Blazwind.Barcode.generate", _element, Value, options);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[BwBarcode] Error generating barcode: {ex.Message}");
        }
    }
    
    /// <summary>
    /// Export barcode as Data URL
    /// </summary>
    public async Task<string> ToDataUrlAsync()
    {
        return await JS.InvokeAsync<string>("Blazwind.Barcode.toDataURL", _element);
    }
}
