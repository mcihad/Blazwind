@namespace Blazwind.Components.Popover
@using Blazwind.Components.Shared
@inherits BwBase

@{
    var placementClasses = Placement switch
    {
        BwPlacement.Top => "bottom-full left-1/2 -translate-x-1/2 mb-2",
        BwPlacement.Left => "right-full top-1/2 -translate-y-1/2 mr-2",
        BwPlacement.Right => "left-full top-1/2 -translate-y-1/2 ml-2",
        _ => "top-full left-1/2 -translate-x-1/2 mt-2" // Bottom
    };
    
    var arrowClasses = Placement switch
    {
        BwPlacement.Top => "bottom-[-6px] left-1/2 -translate-x-1/2 rotate-45 border-r border-b border-gray-200 dark:border-gray-700",
        BwPlacement.Left => "right-[-6px] top-1/2 -translate-y-1/2 rotate-45 border-r border-t border-gray-200 dark:border-gray-700",
        BwPlacement.Right => "left-[-6px] top-1/2 -translate-y-1/2 rotate-45 border-l border-b border-gray-200 dark:border-gray-700",
        _ => "top-[-6px] left-1/2 -translate-x-1/2 rotate-45 border-l border-t border-gray-200 dark:border-gray-700" // Bottom
    };
}

<div class="@CombineClasses("relative inline-block")" style="@Style" id="@Id" @attributes="AdditionalAttributes" @onmouseenter="HandleMouseEnter" @onmouseleave="HandleMouseLeave">
    <div class="inline-block cursor-pointer" @onclick="HandleTriggerClick">
        @ChildContent
    </div>
    
    @if (_isOpen)
    {
        <div class="absolute z-[1070] min-w-[200px] max-w-xs bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow-lg shadow-black/10 animate-in fade-in zoom-in-95 duration-150 @placementClasses">
            @if (ShowArrow)
            {
                <div class="absolute w-3 h-3 bg-white dark:bg-gray-800 @arrowClasses"></div>
            }
            
            @if (HeaderContent != null || !string.IsNullOrEmpty(Title))
            {
                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 rounded-t">
                    @if (HeaderContent != null)
                    {
                        @HeaderContent
                    }
                    else
                    {
                        <span class="font-semibold text-sm text-gray-900 dark:text-white">@Title</span>
                    }
                    @if (Closable)
                    {
                        <button type="button" class="w-6 h-6 flex items-center justify-center border-none bg-transparent cursor-pointer text-gray-500 dark:text-gray-400 rounded hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors" @onclick="Close">
                            <i class="fa-solid fa-times text-xs"></i>
                        </button>
                    }
                </div>
            }
            
            <div class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
                @if (BodyContent != null)
                {
                    @BodyContent
                }
                else
                {
                    @Content
                }
            </div>
            
            @if (FooterContent != null)
            {
                <div class="flex items-center justify-end gap-2 px-4 py-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 rounded-b">
                    @FooterContent
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? HeaderContent { get; set; }
    [Parameter] public RenderFragment? BodyContent { get; set; }
    [Parameter] public RenderFragment? FooterContent { get; set; }
    
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Content { get; set; }
    [Parameter] public BwPlacement Placement { get; set; } = BwPlacement.Bottom;
    [Parameter] public bool ShowArrow { get; set; } = true;
    [Parameter] public bool Closable { get; set; } = false;
    [Parameter] public BwTrigger Trigger { get; set; } = BwTrigger.Click;
    // Removed Class parameter (inherited)
    
    [Parameter] public bool IsOpen { get; set; } = false;
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    
    private bool _isOpen = false;
    
    protected override void OnParametersSet()
    {
        _isOpen = IsOpen;
    }
    
    private async Task HandleTriggerClick()
    {
        if (Trigger == BwTrigger.Click || Trigger == BwTrigger.Focus)
        {
            await Toggle();
        }
    }
    
    private async Task HandleMouseEnter()
    {
        if (Trigger == BwTrigger.Hover)
        {
            await Open();
        }
    }
    
    private async Task HandleMouseLeave()
    {
        if (Trigger == BwTrigger.Hover)
        {
            await Close();
        }
    }
    
    private async Task Toggle()
    {
        _isOpen = !_isOpen;
        await IsOpenChanged.InvokeAsync(_isOpen);
    }
    
    private async Task Open()
    {
        _isOpen = true;
        await IsOpenChanged.InvokeAsync(true);
    }
    
    private async Task Close()
    {
        _isOpen = false;
        await IsOpenChanged.InvokeAsync(false);
    }
}
