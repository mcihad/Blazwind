@namespace Blazwind.Components.Carousel
@inherits BwBase
@inject IJSRuntime JS
@using Microsoft.JSInterop
@implements IDisposable

@{
    var baseClasses = "bw-carousel";
}

<div class="@CombineClasses(baseClasses)" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    <div class="relative h-full">
        @foreach (var (item, index) in Items.Select((x, i) => (x, i)))
        {
            var isActive = index == _currentIndex;
            var slideClasses = isActive
                ? "opacity-100 z-10"
                : "opacity-0 z-0 absolute inset-0";
            var transition = Fade ? "transition-opacity duration-500" : "transition-transform duration-500";

            <div class="w-full @slideClasses @transition">
                @if (ItemTemplate != null)
                {
                    @ItemTemplate(item)
                }
                else if (item is string imageUrl)
                {
                    <img src="@imageUrl" alt="Slide @(index + 1)" class="w-full h-full object-cover"/>
                }
            </div>
        }
    </div>

    @if (ShowArrows && Items.Count > 1)
    {
        <button type="button"
                class="bw-carousel-control left-4"
                @onclick="Previous">
            <i class="fa-solid fa-chevron-left"></i>
        </button>

        <button type="button"
                class="bw-carousel-control right-4"
                @onclick="Next">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
    }

    @if (ShowIndicators && Items.Count > 1)
    {
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 flex gap-2">
            @for (var i = 0; i < Items.Count; i++)
            {
                var index = i;
                var isActive = index == _currentIndex;
                var activeClass = isActive ? "bw-carousel-indicator-active w-8" : "w-2 hover:bg-white/75";

                <button type="button" class="bw-carousel-indicator @activeClass"
                        @onclick="() => GoTo(index)">
                </button>
            }
        </div>
    }
</div>

@code {

    [Parameter]
    public List<object> Items { get; set; } = new();

    [Parameter]
    public RenderFragment<object>? ItemTemplate { get; set; }

    [Parameter]
    public bool AutoPlay { get; set; }

    [Parameter]
    public int Interval { get; set; } = 5000;

    [Parameter]
    public bool ShowArrows { get; set; } = true;

    [Parameter]
    public bool ShowIndicators { get; set; } = true;

    [Parameter]
    public bool Fade { get; set; } = true;

    [Parameter]
    public bool PauseOnHover { get; set; } = true;

    [Parameter]
    public bool Loop { get; set; } = true;

    [Parameter]
    public EventCallback<int> OnSlideChange { get; set; }

    private int _currentIndex;
    private Timer? _timer;
    private bool _isPaused;

    protected override void OnInitialized()
    {
        if (AutoPlay && Items.Count > 1)
        {
            StartAutoPlay();
        }
    }

    private void StartAutoPlay()
    {
        _timer = new Timer(async _ =>
        {
            if (!_isPaused)
            {
                await InvokeAsync(Next);
            }
        }, null, Interval, Interval);
    }

    public async Task Next()
    {
        if (_currentIndex < Items.Count - 1)
        {
            _currentIndex++;
        }
        else if (Loop)
        {
            _currentIndex = 0;
        }

        await OnSlideChange.InvokeAsync(_currentIndex);
        StateHasChanged();
    }

    public async Task Previous()
    {
        if (_currentIndex > 0)
        {
            _currentIndex--;
        }
        else if (Loop)
        {
            _currentIndex = Items.Count - 1;
        }

        await OnSlideChange.InvokeAsync(_currentIndex);
        StateHasChanged();
    }

    public async Task GoTo(int index)
    {
        if (index >= 0 && index < Items.Count)
        {
            _currentIndex = index;
            await OnSlideChange.InvokeAsync(_currentIndex);
            StateHasChanged();
        }
    }

    public void Pause()
    {
        _isPaused = true;
    }

    public void Resume()
    {
        _isPaused = false;
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

}