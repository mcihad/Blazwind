@namespace Blazwind.Components.Tree
@using Blazwind.Components.Shared
@using Blazwind.Components.Input
@typeparam TItem
@inherits BwBase

<div class="@CombineClasses("bw-tree", _containerClasses)" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (ShowSearch)
    {
        <div class="mb-3">
            <BwInput Placeholder="Search..." IconLeft="fa-solid fa-search" Size="BwSize.Small" @bind-Value="_searchQuery"
                @bind-Value:after="OnSearchChanged" />
        </div>
    }

    @if (ShowToolbar)
    {
        <div class="bw-tree-toolbar">
            <button type="button" class="bw-tree-toolbar-btn" @onclick="ExpandAll">
                <i class="fa-solid fa-folder-open mr-1"></i> Expand All
            </button>
            <span class="bw-tree-toolbar-separator">|</span>
            <button type="button" class="bw-tree-toolbar-btn" @onclick="CollapseAll">
                <i class="fa-solid fa-folder-minus mr-1"></i> Collapse All
            </button>
        </div>
    }

    <div class="bw-tree-content">
        @if (_filteredNodes.Any())
        {
            @foreach (var node in _filteredNodes)
            {
                <BwTreeNode TItem="TItem" Node="node" Level="0" SelectionMode="SelectionMode" Selectable="Selectable"
                    CascadeSelection="CascadeSelection" Draggable="Draggable" ShowChildCount="ShowChildCount"
                    OnNodeClick="HandleNodeClick" OnNodeToggle="HandleNodeToggle" OnSelectionChanged="HandleSelectionChanged"
                    OnRowClick="HandleRowClick" SelectedNodes="_selectedNodes" ClickedNode="_clickedNode"
                    SearchQuery="_searchQuery" NodeTemplate="NodeTemplate" ColumnsTemplate="ColumnsTemplate"
                    ShowTableMode="ShowTableMode" />
            }
        }
        else
        {
            <div class="bw-tree-empty">
                <i class="fa-solid fa-tree bw-tree-empty-icon"></i>
                <p>@(string.IsNullOrEmpty(_searchQuery) ? "No data found" : "No search results found")</p>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public List<TreeNode<TItem>> Nodes { get; set; } = new();
    [Parameter] public BwSelectionMode SelectionMode { get; set; } = BwSelectionMode.None;
    [Parameter] public bool Selectable { get; set; } = false;
    [Parameter] public bool CascadeSelection { get; set; } = false;
    [Parameter] public bool Draggable { get; set; } = false;
    [Parameter] public bool ShowSearch { get; set; } = false;
    [Parameter] public bool ShowToolbar { get; set; } = false;
    [Parameter] public bool ShowTableMode { get; set; } = false;
    [Parameter] public bool ShowChildCount { get; set; } = false;
    // Removed Class parameter (inherited)

    /// <summary>
    /// Async callback for lazy loading children when a node is expanded
    /// </summary>
    [Parameter] public Func<TreeNode<TItem>, Task<List<TreeNode<TItem>>>>? OnLoadChildren { get; set; }

    [Parameter] public RenderFragment<TreeNode<TItem>>? NodeTemplate { get; set; }
    [Parameter] public RenderFragment<TreeNode<TItem>>? ColumnsTemplate { get; set; }

    [Parameter] public EventCallback<TreeNode<TItem>> OnNodeClick { get; set; }
    [Parameter] public EventCallback<TreeNode<TItem>> OnNodeExpand { get; set; }
    [Parameter] public EventCallback<List<TreeNode<TItem>>> SelectedNodesChanged { get; set; }
    [Parameter] public List<TreeNode<TItem>> SelectedNodes { get; set; } = new();

    // For single row click selection (Selectable mode)
    [Parameter] public TreeNode<TItem>? ClickedNode { get; set; }
    [Parameter] public EventCallback<TreeNode<TItem>> ClickedNodeChanged { get; set; }

    private HashSet<TreeNode<TItem>> _selectedNodes = new();
    private TreeNode<TItem>? _clickedNode;
    private string _searchQuery = "";
    private List<TreeNode<TItem>> _filteredNodes = new();

    private string _containerClasses => ShowTableMode ? "bw-tree-table" : "";

    protected override void OnParametersSet()
    {
        _selectedNodes = new HashSet<TreeNode<TItem>>(SelectedNodes);
        _clickedNode = ClickedNode;
        FilterNodes();
    }

    private void FilterNodes()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            _filteredNodes = Nodes;
        }
        else
        {
            _filteredNodes = FilterNodesRecursive(Nodes, _searchQuery.ToLower());
        }
    }

    private List<TreeNode<TItem>> FilterNodesRecursive(List<TreeNode<TItem>> nodes, string query)
    {
        var result = new List<TreeNode<TItem>>();

        foreach (var node in nodes)
        {
            var matchesTitle = node.Title.ToLower().Contains(query);
            var filteredChildren = FilterNodesRecursive(node.Children, query);

            if (matchesTitle || filteredChildren.Any())
            {
                var clonedNode = new TreeNode<TItem>
                {
                    Id = node.Id,
                    Title = node.Title,
                    Icon = node.Icon,
                    Data = node.Data,
                    IsExpanded = true,
                    IsSelected = node.IsSelected,
                    IsDisabled = node.IsDisabled,
                    HasChildren = node.HasChildren,
                    Children = matchesTitle ? node.Children : filteredChildren
                };
                result.Add(clonedNode);
            }
        }

        return result;
    }

    private void OnSearchChanged()
    {
        FilterNodes();
        StateHasChanged();
    }

    private async Task HandleNodeClick(TreeNode<TItem> node)
    {
        await OnNodeClick.InvokeAsync(node);
    }

    private async Task HandleRowClick(TreeNode<TItem> node)
    {
        if (Selectable && !node.IsDisabled)
        {
            _clickedNode = node;
            await ClickedNodeChanged.InvokeAsync(node);
            StateHasChanged();
        }
    }

    private async Task HandleNodeToggle(TreeNode<TItem> node)
    {
        // Lazy loading: if node has children but they're not loaded yet
        if (!node.IsExpanded && node.HasChildren && !node.Children.Any() && OnLoadChildren != null)
        {
            node.IsLoading = true;
            StateHasChanged();

            try
            {
                var children = await OnLoadChildren(node);
                node.Children = children ?? new List<TreeNode<TItem>>();
            }
            finally
            {
                node.IsLoading = false;
            }
        }

        node.IsExpanded = !node.IsExpanded;
        if (node.IsExpanded)
        {
            await OnNodeExpand.InvokeAsync(node);
        }
        StateHasChanged();
    }

    private async Task HandleSelectionChanged(TreeNode<TItem> node)
    {
        if (SelectionMode == BwSelectionMode.Single)
        {
            _selectedNodes.Clear();
            _selectedNodes.Add(node);
        }
        else if (SelectionMode == BwSelectionMode.Multiple)
        {
            var wasSelected = _selectedNodes.Contains(node);

            if (wasSelected)
            {
                _selectedNodes.Remove(node);
                if (CascadeSelection)
                {
                    DeselectAllChildren(node);
                }
            }
            else
            {
                _selectedNodes.Add(node);
                if (CascadeSelection)
                {
                    SelectAllChildren(node);
                }
            }
        }

        await SelectedNodesChanged.InvokeAsync(_selectedNodes.ToList());
    }

    private void SelectAllChildren(TreeNode<TItem> node)
    {
        foreach (var child in node.Children)
        {
            if (!child.IsDisabled)
            {
                _selectedNodes.Add(child);
                SelectAllChildren(child);
            }
        }
    }

    private void DeselectAllChildren(TreeNode<TItem> node)
    {
        foreach (var child in node.Children)
        {
            _selectedNodes.Remove(child);
            DeselectAllChildren(child);
        }
    }

    public void ExpandAll()
    {
        SetExpandedRecursive(Nodes, true);
        StateHasChanged();
    }

    public void CollapseAll()
    {
        SetExpandedRecursive(Nodes, false);
        StateHasChanged();
    }

    private void SetExpandedRecursive(List<TreeNode<TItem>> nodes, bool expanded)
    {
        foreach (var node in nodes)
        {
            node.IsExpanded = expanded;
            SetExpandedRecursive(node.Children, expanded);
        }
    }
}