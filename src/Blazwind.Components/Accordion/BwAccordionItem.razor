@namespace Blazwind.Components.Accordion
@inherits BwBase
@using Blazwind.Components.Shared
@implements IDisposable

@{
    var isExpanded = ParentAccordion?.IsExpanded(this) ?? false;
    var iconRotation = isExpanded ? "rotate-180" : "rotate-0";
}

<div class="@_itemClasses" @attributes="AdditionalAttributes" style="@Style">
    <button type="button"
            class="@_headerClasses"
            disabled="@IsDisabled"
            @onclick="HandleToggle">
        <div class="flex items-center gap-3">
            @if (!string.IsNullOrEmpty(Icon))
            {
                <i class="@Icon text-current opacity-70"></i>
            }
            @if (TitleTemplate != null)
            {
                @TitleTemplate
            }
            else
            {
                <span class="font-medium">@Title</span>
            }
            @if (Badge != null)
            {
                <span class="ml-2">@Badge</span>
            }
        </div>
        <i class="fa-solid fa-chevron-down opacity-50 transition-transform duration-300 ease-in-out @iconRotation"></i>
    </button>

    @if (isExpanded)
    {
        <div class="@_contentClasses">
            @ChildContent
        </div>
    }
</div>

@code {

    [CascadingParameter]
    public BwAccordion? ParentAccordion { get; set; }

    [Parameter]
    public string? Title { get; set; }

    [Parameter]
    public RenderFragment? TitleTemplate { get; set; }

    [Parameter]
    public RenderFragment? Badge { get; set; }

    [Parameter]
    public string? Icon { get; set; }

    [Parameter]
    public bool IsDisabled { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private string _itemClasses => CombineClasses("bw-accordion-item"); // Parent handles borders via divide-y

    private string _headerClasses
    {
        get
        {
            var classes = new List<string>
            {
                "bw-accordion-header"
            };

            // Size
            var size = ParentAccordion?.Size ?? BwSize.Medium;
            switch (size)
            {
                case BwSize.ExtraSmall: classes.Add("bw-accordion-header-xs"); break;
                case BwSize.Small: classes.Add("bw-accordion-header-sm"); break;
                case BwSize.Medium: classes.Add("bw-accordion-header-md"); break;
                case BwSize.Large: classes.Add("bw-accordion-header-lg"); break;
                case BwSize.ExtraLarge: classes.Add("bw-accordion-header-xl"); break;
            }

            // State & Color
            var isExpanded = ParentAccordion?.IsExpanded(this) ?? false;

            if (IsDisabled)
            {
                // Disabled styles handled by CSS :disabled selector
            }
            else
            {
                if (isExpanded)
                {
                    // Active Color
                    var color = ParentAccordion?.Color ?? BwColor.Primary;
                    classes.Add(GetColorClasses(color));
                }
            }

            return string.Join(" ", classes);
        }
    }

    private string _contentClasses
    {
        get
        {
            var classes = new List<string> { "bw-accordion-content" };
            // Padding based on size
            var size = ParentAccordion?.Size ?? BwSize.Medium;
            switch (size)
            {
                case BwSize.ExtraSmall: classes.Add("bw-accordion-content-xs"); break;
                case BwSize.Small: classes.Add("bw-accordion-content-sm"); break;
                case BwSize.Medium: classes.Add("bw-accordion-content-md"); break;
                case BwSize.Large: classes.Add("bw-accordion-content-lg"); break;
                case BwSize.ExtraLarge: classes.Add("bw-accordion-content-xl"); break;
            }

            return string.Join(" ", classes);
        }
    }

    private string GetColorClasses(BwColor color)
    {
        // Active header background and text mapped to theme classes
        var colorName = color.ToString().ToLower();
        return $"bw-accordion-header-active-{colorName}";
    }

    protected override void OnInitialized()
    {
        ParentAccordion?.RegisterItem(this);
    }

    private void HandleToggle()
    {
        if (!IsDisabled)
        {
            ParentAccordion?.ToggleItem(this);
        }
    }

    public void Dispose()
    {
        ParentAccordion?.UnregisterItem(this);
    }

}

