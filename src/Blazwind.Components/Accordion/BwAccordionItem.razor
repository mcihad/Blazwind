@namespace Blazwind.Components.Accordion
@inherits BwBase
@using Blazwind.Components.Shared
@using Blazwind.Components
@implements IDisposable

@{
    var isExpanded = ParentAccordion?.IsExpanded(this) ?? false;
    var iconRotation = isExpanded ? "rotate-180" : "rotate-0";
}

<div class="@_itemClasses" @attributes="AdditionalAttributes" style="@Style">
    <button type="button" 
            class="@_headerClasses"
            disabled="@IsDisabled"
            @onclick="HandleToggle">
        <div class="flex items-center gap-3">
            @if (!string.IsNullOrEmpty(Icon))
            {
                <i class="@Icon text-current opacity-70"></i>
            }
            @if (TitleTemplate != null)
            {
                @TitleTemplate
            }
            else
            {
                <span class="font-medium">@Title</span>
            }
            @if (Badge != null)
            {
                <span class="ml-2">@Badge</span>
            }
        </div>
        <i class="fa-solid fa-chevron-down opacity-50 transition-transform duration-300 ease-in-out @iconRotation"></i>
    </button>
    
    @if (isExpanded)
    {
        <div class="@_contentClasses">
            @ChildContent
        </div>
    }
</div>

@code {
    [CascadingParameter] public BwAccordion? ParentAccordion { get; set; }
    
    [Parameter] public string? Title { get; set; }
    [Parameter] public RenderFragment? TitleTemplate { get; set; }
    [Parameter] public RenderFragment? Badge { get; set; }
    [Parameter] public string? Icon { get; set; }
    [Parameter] public bool IsDisabled { get; set; } = false;
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private string _itemClasses => CombineClasses("w-full bg-transparent"); // Parent handles borders via divide-y

    private string _headerClasses
    {
        get
        {
            var classes = new List<string>
            {
                "w-full flex items-center justify-between transition-colors duration-200 text-left"
            };

            // Size
            var size = ParentAccordion?.Size ?? BwSize.Medium;
            switch (size)
            {
                case BwSize.ExtraSmall: classes.Add("px-2 py-1 text-xs"); break;
                case BwSize.Small: classes.Add("px-3 py-2 text-xs"); break;
                case BwSize.Medium: classes.Add("px-4 py-3 text-sm"); break;
                case BwSize.Large: classes.Add("px-5 py-4 text-base"); break;
                case BwSize.ExtraLarge: classes.Add("px-6 py-5 text-lg"); break;
            }

            // State & Color
            var isExpanded = ParentAccordion?.IsExpanded(this) ?? false;
            
            if (IsDisabled)
            {
                classes.Add("cursor-not-allowed opacity-50 bg-gray-50 dark:bg-gray-800 text-gray-400 dark:text-gray-500");
            }
            else
            {
                classes.Add("cursor-pointer");
                
                if (isExpanded)
                {
                    // Active Color
                    var color = ParentAccordion?.Color ?? BwColor.Primary;
                    classes.Add(GetColorClasses(color));
                }
                else
                {
                    // Default State
                    // If Ghost, transparent. If Filled/Outline, hover effect.
                    classes.Add("bg-transparent hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-900 dark:text-gray-100");
                }
            }

            return string.Join(" ", classes);
        }
    }

    private string _contentClasses
    {
        get
        {
            var classes = new List<string> { "text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700" };
            // Padding based on size
             var size = ParentAccordion?.Size ?? BwSize.Medium;
             switch (size)
            {
                case BwSize.ExtraSmall: classes.Add("px-2 pb-2 pt-1"); break;
                case BwSize.Small: classes.Add("px-3 pb-3 pt-2"); break;
                case BwSize.Medium: classes.Add("px-4 pb-4 pt-2"); break; // increased bottom padding usually looks good
                case BwSize.Large: classes.Add("px-5 pb-5 pt-3"); break;
                case BwSize.ExtraLarge: classes.Add("px-6 pb-6 pt-4"); break;
            }
            return string.Join(" ", classes);
        }
    }

    private string GetColorClasses(BwColor color)
    {
        // Active header background and text
        return color switch
        {
            BwColor.Primary => "bg-blue-50 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300",
            BwColor.Secondary => "bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-300",
            BwColor.Success => "bg-emerald-50 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300",
            BwColor.Danger => "bg-red-50 dark:bg-red-900/40 text-red-700 dark:text-red-300",
            BwColor.Warning => "bg-amber-50 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300",
            BwColor.Info => "bg-blue-50 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300",
            BwColor.Light => "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200",
            BwColor.Dark => "bg-gray-800 dark:bg-black text-white dark:text-gray-100",
            BwColor.White => "bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100",
            BwColor.Black => "bg-black text-white",
            BwColor.Transparent => "bg-transparent text-gray-900 dark:text-gray-100",
             _ => "bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100" // Default/Gray
        };
    }

    protected override void OnInitialized()
    {
        ParentAccordion?.RegisterItem(this);
    }

    private void HandleToggle()
    {
        if (!IsDisabled)
        {
            ParentAccordion?.ToggleItem(this);
        }
    }

    public void Dispose()
    {
        ParentAccordion?.UnregisterItem(this);
    }
}

