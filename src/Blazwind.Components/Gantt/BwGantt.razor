@namespace Blazwind.Components.Gantt
@using Blazwind.Components.Shared
@using Blazwind.Components.Avatar
@using Blazwind.Components.Button
@using Blazwind.Components.Card
@using Blazwind.Components.ContextMenu
@using Blazwind.Components.Layout
@using Microsoft.JSInterop
@using System.Globalization
@inherits BwBase
@inject IJSRuntime JS
@implements IAsyncDisposable

<BwCard Class="@CombineClasses($"bw-gantt overflow-hidden {(_isFullScreen ? "fixed inset-0 z-[9999] m-0 rounded-none w-screen h-screen shadow-none border-none bg-white dark:bg-gray-900" : "")}")" Style="@(_isFullScreen ? "z-index: 9999;" : Style)" BodyClass="p-0" Id="@Id" AdditionalAttributes="@AdditionalAttributes">
    @* Header - Modern Toolbar *@
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 transition-colors duration-300">
        @* Title Section *@
        <div class="flex items-center gap-3 w-full sm:w-auto">
            <div class="w-8 h-8 rounded-lg bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div class="font-semibold text-gray-800 dark:text-gray-100">
                @Title
            </div>
        </div>
        
        @* Controls Container *@
        <div class="flex items-center gap-4 w-full sm:w-auto overflow-x-auto pb-1 sm:pb-0 scrollbar-hide">
            @* View Mode Switcher (Segmented Control Style) *@
            <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg flex-shrink-0 border border-transparent dark:border-gray-700">
                <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(ViewMode == GanttViewMode.Day ? "bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm ring-1 ring-black/5 dark:ring-white/10" : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200")"
                        @onclick="async () => await SetViewMode(GanttViewMode.Day)">
                    Gün
                </button>
                <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(ViewMode == GanttViewMode.Week ? "bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm ring-1 ring-black/5 dark:ring-white/10" : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200")"
                        @onclick="async () => await SetViewMode(GanttViewMode.Week)">
                    Hafta
                </button>
                <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(ViewMode == GanttViewMode.Month ? "bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm ring-1 ring-black/5 dark:ring-white/10" : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200")"
                        @onclick="async () => await SetViewMode(GanttViewMode.Month)">
                    Ay
                </button>
            </div>
            
            @* Actions Group *@
            <div class="flex items-center gap-1 flex-shrink-0 pl-4 border-l border-gray-200 dark:border-gray-700">
                <button class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                        @onclick="ZoomOut" title="Uzaklaş">
                    <i class="fa-solid fa-minus text-xs"></i>
                </button>
                <button class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                        @onclick="ZoomIn" title="Yakınlaş">
                    <i class="fa-solid fa-plus text-xs"></i>
                </button>
                
                <div class="w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1"></div>
                
                <button class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors @(_isFullScreen ? "bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400" : "")"
                        @onclick="ToggleFullScreen" title="@(_isFullScreen ? "Küçült" : "Tam Ekran")">
                    <i class="@(_isFullScreen ? "fa-solid fa-compress" : "fa-solid fa-expand") text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    @* Main Content with unified vertical scroll *@
    <div class="overflow-auto" style="height: @(_isFullScreen ? "calc(100vh - 46px)" : Height);">
        <div class="flex min-w-max">
            @* Task List (Left Panel - Sticky) *@
            @if (ShowTaskList && _isTaskListVisible)
            {
                <div class="bw-gantt-task-list flex-shrink-0 border-r border-gray-200 dark:border-gray-700 sticky left-0 bg-white dark:bg-gray-800 z-[35] relative"
                     style="width: @(_currentTaskListWidth)px;">
                    @* Task List Header *@
                    <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-3 h-8 flex items-center justify-between text-xs font-semibold text-gray-600 dark:text-gray-400 z-32" style="top: 0;">
                        <span>Görevler</span>
                        <button type="button" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors" 
                                @onclick="ToggleTaskList" title="Görev listesini gizle">
                            <i class="fa-solid fa-chevron-left text-xs"></i>
                        </button>
                    </div>
                    @* Task List Items - fixed height rows *@
                    @{ int taskIndex = 0; }
                    @foreach (var task in FlatTasks)
                    {
                        var isHovered = _hoveredTaskId == task.Id;
                        var currentTask = task;
                        <div class="bw-gantt-task-row flex items-center gap-2 px-3 border-b border-gray-100 dark:border-gray-700 cursor-pointer text-sm transition-colors h-8 @(task.ParentId != null ? "pl-6" : "") @(isHovered ? "bg-blue-50 dark:bg-blue-900/20" : "hover:bg-gray-50 dark:hover:bg-gray-700")"
                             data-task-index="@taskIndex"
                             @onclick="() => HandleTaskClick(task)"
                             @onmouseenter="() => _hoveredTaskId = task.Id"
                             @onmouseleave="() => _hoveredTaskId = null">
                            @if (TaskItemTemplate != null)
                            {
                                @TaskItemTemplate(currentTask)
                            }
                            else
                            {
                                @if (task.Children.Count > 0)
                                {
                                    <i class="fa-solid fa-folder text-amber-500 text-xs"></i>
                                }
                                else if (task.IsMilestone)
                                {
                                    <i class="fa-solid fa-diamond text-purple-500 text-xs"></i>
                                }
                                else
                                {
                                    <i class="fa-solid fa-circle text-xs" style="color: @(task.Color ?? "#3b82f6")"></i>
                                }
                                <span class="truncate flex-1 @(task.Status == GanttTaskStatus.Completed ? "line-through text-gray-400 dark:text-gray-500" : "text-gray-700 dark:text-gray-200")">
                                    @task.Title
                                </span>
                                @if (!string.IsNullOrEmpty(task.AssigneeAvatar) || !string.IsNullOrEmpty(task.AssigneeName))
                                {
                                    <BwAvatar Name="@task.AssigneeName" Src="@task.AssigneeAvatar" Size="BwSize.ExtraSmall" />
                                }
                            }
                        </div>
                        taskIndex++;
                    }
                    
                    @* Resize Handle *@
                    @if (TaskListResizable)
                    {
                        <div class="bw-gantt-resize-handle absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors z-40"
                             @onmousedown="StartTaskListResize"
                             @onmousedown:preventDefault="true"></div>
                    }
                </div>
            }
            else if (ShowTaskList)
            {
                @* Collapsed state - show expand button *@
                <div class="flex-shrink-0 border-r border-gray-200 dark:border-gray-700 sticky left-0 bg-white dark:bg-gray-800 z-[35]" style="width: 32px;">
                    <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 h-8 flex items-center justify-center z-32">
                        <button type="button" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors" 
                                @onclick="ToggleTaskList" title="Görev listesini göster">
                            <i class="fa-solid fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                    @* Row placeholders for alignment *@
                    @foreach (var task in FlatTasks)
                    {
                        <div class="h-8 border-b border-gray-100 dark:border-gray-700"></div>
                    }
                </div>
            }


        @* Timeline (Right Panel) *@
        <div class="flex-1">
            @* Timeline Header - same height as task list header *@
            <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 flex z-30 h-8 relative" style="top: 0;">
                @foreach (var period in TimelinePeriods)
                {
                    <div class="flex-shrink-0 text-center border-r border-gray-200 dark:border-gray-700 px-1 flex items-center justify-center text-xs font-semibold text-gray-600 dark:text-gray-400"
                         style="width: @(GetColumnWidth())px;">
                        @period
                    </div>
                }
                
                @* Today Marker in Header *@
                @if (ShowTodayIndicator && TodayOffset >= 0)
                {
                    <div class="absolute top-0 bottom-0 z-40 pointer-events-none flex flex-col items-center justify-center"
                         style="left: @(TodayOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))px;">
                        <div class="w-2 h-2 rounded-full bg-red-500 shadow-sm -translate-x-1/2"></div>
                    </div>
                }
            </div>

            @* Timeline Grid - with @ref for JS interop *@
            <div @ref="_timelineContainer" class="relative" style="width: @(TimelinePeriods.Count * GetColumnWidth())px; height: @(FlatTasks.Count * 32)px;">
                @* Row Backgrounds with Grid Pattern *@
                <div class="absolute inset-0 pointer-events-none">
                    @{ int rowBgIndex = 0; }
                    @foreach (var task in FlatTasks)
                    {
                        var isRowHovered = _hoveredTaskId == task.Id;
                        <div class="absolute left-0 right-0 border-b border-gray-100 dark:border-gray-700 transition-colors @(isRowHovered ? "bg-blue-50/50 dark:bg-blue-900/10" : (rowBgIndex % 2 == 0 ? "bg-white dark:bg-gray-800" : "bg-gray-50/30 dark:bg-gray-800/50"))"
                             style="top: @(rowBgIndex * 32)px; height: 32px;"></div>
                        rowBgIndex++;
                    }
                </div>
                
                @* Dependency Lines (SVG Overlay) *@
                <svg class="absolute inset-0 w-full h-full pointer-events-none z-10" style="overflow: visible;">
                    <defs>
                        <marker id="arrowhead" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto">
                            <polygon points="0 0, 6 2, 0 4" fill="#9ca3af" />
                        </marker>
                    </defs>
                    @foreach (var dep in CalculateDependencies())
                    {
                        <path d="@dep.Path" 
                              data-from="@dep.FromId" 
                              data-to="@dep.ToId"
                              stroke="#9ca3af" 
                              stroke-width="1.5" 
                              fill="none" 
                              class="opacity-60 transition-opacity hover:opacity-100 hover:stroke-gray-500" 
                              marker-end="url(#arrowhead)" />
                    }
                </svg>
                
                @* Vertical Grid Lines *@
                <div class="absolute inset-0 flex pointer-events-none">
                    @foreach (var period in TimelinePeriods)
                    {
                        <div class="border-r border-gray-100/60 dark:border-gray-700/60 flex-shrink-0 bg-gradient-to-b from-transparent via-gray-50/10 dark:via-gray-800/10 to-transparent" style="width: @(GetColumnWidth())px;"></div>
                    }
                </div>

                @* Today Line (Body) *@
                @if (ShowTodayIndicator && TodayOffset >= 0)
                {
                    <div class="absolute top-0 bottom-0 z-0 pointer-events-none"
                         style="left: @(TodayOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))px;">
                        <div class="absolute inset-y-0 left-0 w-px bg-red-400/50 dashed-line"></div>
                    </div>
                }

                @* Task Bars *@
                @{
                    int rowIndex = 0;
                }
                @foreach (var task in FlatTasks)
                {
                    var barStyle = GetTaskBarStyle(task, rowIndex);
                    var taskLocal = task;
                    
                    @* Task bar container with data-task-id for JS *@
                    @if (ContextMenuTemplate != null)
                    {
                        <BwContextMenu Class="@($"bw-gantt-bar absolute flex items-center {(Editable ? "cursor-move" : "")}")" 
                                       Style="@barStyle"
                                       @onclick="@(Editable ? null : () => HandleTaskClick(taskLocal))"
                                       data-task-id="@task.Id">
                            <ChildContent>
                                @RenderTaskBar(taskLocal)
                            </ChildContent>
                            <MenuContent>
                                @ContextMenuTemplate(taskLocal)
                            </MenuContent>
                        </BwContextMenu>
                    }
                    else
                    {
                        <div class="bw-gantt-bar absolute flex items-center @(Editable ? "cursor-move" : "")" 
                             style="@barStyle"
                             data-task-id="@task.Id"
                             @onclick="@(Editable ? null : () => HandleTaskClick(taskLocal))">
                             @RenderTaskBar(taskLocal)
                        </div>
                    }
                    rowIndex++;
                }
            </div>
        </div>
        </div>
    </div>
</BwCard>

@* Resize overlay - captures mouse during panel resize *@
@if (_isResizingTaskList)
{
    <div class="fixed inset-0 z-50 cursor-col-resize"
         @onmousemove="OnResizeMouseMove"
         @onmouseup="OnResizeMouseUp"
         @onmouseleave="OnResizeMouseUp">
    </div>
}

@code {
    // Moved to BwGantt.razor.cs
}
