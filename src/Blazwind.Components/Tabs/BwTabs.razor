@namespace Blazwind.Components.Tabs
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inherits BwBase

@inject Blazwind.Components.Services.DialogService DialogService
@inject IJSRuntime JS

<CascadingValue Value="this">
    @{
        var isVertical = Vertical;
        var containerClass = isVertical ? "horizontal" : "vertical"; // wait, original code: isVertical ? "flex flex-row gap-6" : "flex flex-col";
        // If Vertical param is true, tabs are on the left (so layout is flex-row).
        // If Vertical param is false (default), tabs are on top (so layout is flex-col).
        // Let's use clearer names in CSS.
        // Actually .bw-tabs logic in CSS:
        // .vertical -> flex-direction: row (tabs on side)
        // .horizontal -> flex-direction: column (tabs on top)
        var layoutClass = isVertical ? "vertical" : "horizontal";

        var tabListClass = GetTabListClass();
        var contentClass = "bw-tab-content";
        
        var showControls = !Vertical && Scrollable && ShowScrollControls;
    }
    <div class="@CombineClasses("bw-tabs", layoutClass)" style="@Style" id="@Id" @attributes="AdditionalAttributes">
        @* Tab Headers *@
        @if (showControls)
        {
            <div class="bw-tablists-container">
                @* Left Button *@
                <button type="button" 
                        @ref="_prevBtnRef"
                        class="bw-tabs-scroll-btn prev @(Variant == BwVariant.Outline || Variant == BwVariant.Ghost ? "on-surface" : "")">
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
                
                @* Scroll Container *@
                <div role="tablist" class="@tabListClass" @ref="_tabListRef">
                    @RenderTabItems()
                </div>
                
                @* Right Button *@
                <button type="button" 
                        @ref="_nextBtnRef"
                         class="bw-tabs-scroll-btn next @(Variant == BwVariant.Outline || Variant == BwVariant.Ghost ? "on-surface" : "")">
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            </div>
        }
        else
        {
            <div role="tablist" class="@tabListClass">
                @RenderTabItems()
            </div>
        }
        
        @* Tab Content *@
        <div role="tabpanel" class="@contentClass">
            @ChildContent
        </div>
    </div>
</CascadingValue>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public BwVariant Variant { get; set; } = BwVariant.Ghost;
    [Parameter] public bool Vertical { get; set; } = false;
    [Parameter] public int DefaultActiveIndex { get; set; } = 0;
    [Parameter] public bool Justified { get; set; } = false;
    [Parameter] public BwSize Size { get; set; } = BwSize.Medium;
    // Removed Class parameter (inherited)
    [Parameter] public bool Scrollable { get; set; }
    [Parameter] public bool ShowScrollControls { get; set; }
    [Parameter] public int? MaxTabs { get; set; }
    [Parameter] public EventCallback<int> ActiveIndexChanged { get; set; }

    private List<BwTabItem> _tabs = new();
    private int _activeIndex = 0;
    
    private ElementReference _tabListRef;
    private ElementReference _prevBtnRef;
    private ElementReference _nextBtnRef;

    protected override void OnInitialized()
    {
        _activeIndex = DefaultActiveIndex;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !Vertical && Scrollable && ShowScrollControls)
        {
            try
            {
                await JS.InvokeVoidAsync("Blazwind.Tabs.init", _tabListRef, _prevBtnRef, _nextBtnRef);
            }
            catch (JSDisconnectedException) { }
        }
    }

    internal void RegisterTab(BwTabItem tab)
    {
        if (MaxTabs.HasValue && _tabs.Count >= MaxTabs.Value) return;
        _tabs.Add(tab);
        StateHasChanged();
    }

    internal void UnregisterTab(BwTabItem tab)
    {
        var index = _tabs.IndexOf(tab);
        _tabs.Remove(tab);
        
        if (_activeIndex >= _tabs.Count && _tabs.Count > 0)
        {
            _activeIndex = _tabs.Count - 1;
        }
        StateHasChanged();
    }

    internal bool IsActive(BwTabItem tab) => _tabs.IndexOf(tab) == _activeIndex;

    public void SetActiveTab(int index)
    {
        if (index < 0 || index >= _tabs.Count) return;
        if (_tabs[index].IsDisabled) return;
        
        _activeIndex = index;
        ActiveIndexChanged.InvokeAsync(index);
        StateHasChanged();
    }

    public async Task CloseTab(BwTabItem tab)
    {
        if (tab.ConfirmClose)
        {
            var confirmed = await DialogService.ShowConfirmAsync("Sekmeyi Kapat", tab.ConfirmCloseMessage, BwColor.Warning);
            if (!confirmed) return;
        }

        await tab.OnClose.InvokeAsync(tab.Name ?? tab.Title);
    }

    public void ActivateTab(string name)
    {
        var tab = _tabs.FirstOrDefault(t => t.Name == name);
        if (tab != null)
        {
            SetActiveTab(_tabs.IndexOf(tab));
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        if (!Vertical && Scrollable && ShowScrollControls)
        {
            try
            {
                await JS.InvokeVoidAsync("Blazwind.Tabs.dispose", _tabListRef);
            }
            catch (Exception) { }
        }
    }

    private string GetTabListClass()
    {
        var baseClass = "bw-tablist";
        var orientationClass = Vertical ? "vertical" : "horizontal";

        var variantClass = Variant switch {
            BwVariant.Ghost => "variant-ghost",
            BwVariant.Outline => "variant-outline",
            BwVariant.Soft => "variant-soft",
            BwVariant.Filled => "variant-filled",
            _ => "variant-ghost"
        };
        
        var scrollClass = Scrollable ? "scrollable" : "";

        return CombineClasses(baseClass, orientationClass, variantClass, scrollClass);
    }

    private string GetTabClass(bool isActive, bool isDisabled)
    {
        var sizeClass = Size.ToString().ToLower();
        var activeClass = isActive ? "active" : "";
        var verticalClass = Vertical ? "vertical" : "";
        var justifiedClass = Justified && !Vertical ? "justified" : "";
        
        var variantClass = Variant switch {
             BwVariant.Ghost => "variant-ghost",
             BwVariant.Outline => "variant-outline",
             BwVariant.Soft => "variant-soft",
             BwVariant.Filled => "variant-filled",
             _ => "variant-ghost"
         };

        return CombineClasses("bw-tab", sizeClass, activeClass, variantClass, verticalClass, justifiedClass);
    }
    
    private RenderFragment RenderTabItems() => __builder =>
    {
        for (int i = 0; i < _tabs.Count; i++)
        {
            var tab = _tabs[i];
            var index = i;
            var isActive = _activeIndex == index;
            var tabClass = GetTabClass(isActive, tab.IsDisabled);
            
            <button type="button"
                    role="tab"
                    aria-selected="@isActive"
                    disabled="@tab.IsDisabled"
                    class="@tabClass"
                    @onclick="() => SetActiveTab(index)">
                @if (!string.IsNullOrEmpty(tab.Icon))
                {
                    <i class="@tab.Icon"></i>
                }
                @if (tab.TitleTemplate != null)
                {
                    @tab.TitleTemplate
                }
                else
                {
                    <span>@tab.Title</span>
                }
                @if (tab.Badge != null)
                {
                    <span class="ml-2">@tab.Badge</span>
                }
                @if (tab.Closable)
                {
                    <span class="bw-tab-close"
                          @onclick:stopPropagation="true"
                          @onclick="() => CloseTab(tab)">
                        <i class="fa-solid fa-xmark text-[10px]"></i>
                    </span>
                }
            </button>
        }
    };
}
