@namespace Blazwind.Components.DataGrid
@using Blazwind.Components.DataGrid.Models
@using Blazwind.Components.Shared
@inherits BwBase
@using Blazwind.Components.Input
@using Blazwind.Components.Pagination
@using Blazwind.Components.Dropdown
@typeparam TItem where TItem : notnull

<CascadingValue Value="this">
    @* Hidden column definitions collector *@
    <div style="display: none;">
        @ChildContent
        @Columns
    </div>
</CascadingValue>

@{
    var cellPadding = Compact ? "px-3 py-2" : "px-4 py-3";
    var processedItems = GetProcessedItems().ToList();
    var visibleColumns = GetVisibleColumns().ToList();
    var totalCount = GetTotalItemCount();
    var heightStyle = !string.IsNullOrEmpty(Height) ? $"height: {Height};" : "";
}

<div class="@CombineClasses("bw-datagrid")" id="@Id" style="@Style" @attributes="AdditionalAttributes">
    @* Toolbar *@
    @if (ToolbarContent != null || EnableSearch || EnableColumnToggle || EnableExport)
    {
        <div class="bw-datagrid-toolbar">
            <div class="flex items-center gap-3">
                @ToolbarContent
            </div>
            
            <div class="flex items-center gap-2">
                @if (EnableSearch)
                {
                    <div class="relative">
                        <i class="fa-solid fa-search bw-datagrid-search-icon"></i>
                        <input type="text" 
                               placeholder="Ara..." 
                               class="bw-datagrid-input pl-9 pr-3 py-1.5 w-48"
                               value="@_searchQuery"
                               @oninput="@(e => HandleSearchChanged(e.Value?.ToString() ?? ""))" />
                    </div>
                }
                
                @if (EnableColumnToggle)
                {
                    <div class="relative">
                        <button type="button" 
                                class="bw-datagrid-toolbar-btn"
                                @onclick="ToggleColumnSelector">
                            <i class="fa-solid fa-table-columns"></i>
                            <span class="hidden sm:inline">Kolonlar</span>
                        </button>
                        
                        @if (_showColumnSelector)
                        {
                            <div class="bw-datagrid-column-selector">
                                <div class="bw-datagrid-column-selector-header">
                                    <div class="relative">
                                        <i class="fa-solid fa-search bw-datagrid-search-icon"></i>
                                        <input type="text" 
                                               placeholder="Kolon ara..." 
                                               class="bw-datagrid-input w-full pl-8 pr-3 py-1.5"
                                               @bind="_columnSearchQuery"
                                               @bind:event="oninput" />
                                    </div>
                                </div>
                                <div class="py-1 max-h-64 overflow-y-auto">
                                    @{
                                        var filteredColumns = string.IsNullOrWhiteSpace(_columnSearchQuery) 
                                            ? _columns 
                                            : _columns.Where(c => c.Title?.Contains(_columnSearchQuery, StringComparison.OrdinalIgnoreCase) == true).ToList();
                                    }
                                    @foreach (var col in filteredColumns)
                                    {
                                        <div class="bw-datagrid-column-selector-item"
                                             @onclick="@(() => ToggleColumnVisibility(col))">
                                            <BwCheckbox IsChecked="@col.Visible" 
                                                        IsCheckedChanged="@((_) => {/* Already handled */})"
                                                        Size="BwSize.Small"
                                                        Class="!m-0 pointer-events-none" />
                                            <span class="text-sm">@col.Title</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                
                @if (EnableExport && Exporters?.Any() == true)
                {
                    <div class="relative">
                        <button type="button" 
                                class="bw-datagrid-toolbar-btn">
                            <i class="fa-solid fa-download"></i>
                            <span class="hidden sm:inline">Dışa Aktar</span>
                        </button>
                    </div>
                }
            </div>
        </div>
    }
    
    @* Loading Overlay *@
    @if (IsLoading)
    {
        <div class="bw-datagrid-loading">
            @if (LoadingContent != null)
            {
                @LoadingContent
            }
            else
            {
                <div class="flex flex-col items-center gap-2">
                    <i class="fa-solid fa-spinner fa-spin bw-datagrid-loading-spinner"></i>
                    <span class="bw-datagrid-loading-text">Yükleniyor...</span>
                </div>
            }
        </div>
    }
    
    @* Table Container *@
    <div class="relative overflow-auto" style="@heightStyle">
        <table class="w-full text-left border-collapse min-w-full" style="@(!string.IsNullOrEmpty(TableMinWidth) ? $"min-width: {TableMinWidth};" : (AutoFit ? "min-width: max-content;" : ""))">
            @* Header *@
            <thead class="bw-datagrid-header shadow-xs">
                <tr class="bw-datagrid-header-row">
                    @* Selection Column *@
                    @if (SelectionMode == BwSelectionMode.Single || SelectionMode == BwSelectionMode.Multiple)
                    {
                        <th class="bw-datagrid-header-cell @cellPadding w-12 text-center sticky left-0 z-30">
                            @if (SelectionMode == BwSelectionMode.Multiple)
                            {
                                <BwCheckbox IsChecked="@IsAllSelected()" 
                                            Size="BwSize.Small"
                                            IsCheckedChanged="ToggleSelectAll" />
                            }
                        </th>
                    }
                    
                    @* Expansion Column *@
                    @if (EnableRowExpansion && DetailRowTemplate != null)
                    {
                        <th class="bw-datagrid-header-cell @cellPadding w-10"></th>
                    }
                    
                    @* Data Columns *@
                    @foreach (var column in visibleColumns)
                    {
                        var sort = GetSortForColumn(column);
                        var isSorted = sort != null;
                        var sortIcon = isSorted 
                            ? (sort!.Direction == SortDirection.Ascending ? "fa-sort-up" : "fa-sort-down") 
                            : "fa-sort";
                        var sortIconClass = isSorted ? "bw-datagrid-sort-icon-active" : "bw-datagrid-sort-icon";
                        var widthStyle = column.CurrentWidth.HasValue 
                            ? $"width: {column.CurrentWidth}px;" 
                            : (!string.IsNullOrEmpty(column.Width) ? $"width: {column.Width};" : "");
                        var alignClass = column.Align switch 
                        {
                            TextAlign.Center => "text-center",
                            TextAlign.Right => "text-right",
                            _ => "text-left"
                        };
                        var frozenClass = column.Frozen switch
                        {
                            FrozenPosition.Left => "sticky left-0 z-30 bw-datagrid-frozen-cell",
                            FrozenPosition.Right => "sticky right-0 z-30 bw-datagrid-frozen-cell",
                            _ => ""
                        };
                        
                        var thRelative = EnableColumnResize ? "relative" : "";
                        
                        <th class="bw-datagrid-header-cell @cellPadding @alignClass @frozenClass @column.HeaderClass @thRelative" 
                            style="@widthStyle"
                            data-column-id="@column.GetId()">
                            <div class="flex items-center gap-2 @(column.Align == TextAlign.Right ? "justify-end" : column.Align == TextAlign.Center ? "justify-center" : "")">
                                @if (column.HeaderTemplate != null)
                                {
                                    @column.HeaderTemplate
                                }
                                else if (EnableSorting && column.Sortable)
                                {
                                    <button type="button" 
                                            class="bw-datagrid-sort-btn"
                                            @onclick="@(() => HandleSort(column))">
                                        <span>@column.Title</span>
                                        <i class="fa-solid @sortIcon @sortIconClass"></i>
                                        @if (EnableMultiSort && isSorted && _sorts.Count > 1)
                                        {
                                            <span class="bw-datagrid-sort-priority">@(sort!.Priority + 1)</span>
                                        }
                                    </button>
                                }
                                else
                                {
                                    <span>@column.Title</span>
                                }
                                
                                @if (EnableColumnResize && column.Resizable)
                                {
                                    <div class="bw-datagrid-resize-handle group"
                                         data-resize-handle="@column.GetId()">
                                        <div class="bw-datagrid-resize-handle-line group-hover:opacity-100"></div>
                                    </div>
                                }
                                
                                @if (EnableFiltering && FilterMode == FilterMode.Menu && column.Filterable)
                                {
                                    <BwDataGridFilterMenu FilterType="@column.FilterType"
                                                          CurrentFilter="@GetFilterForColumn(column)"
                                                          FilterOptions="@column.FilterOptions"
                                                          OnFilterChanged="@(f => HandleFilterChanged(column.GetFieldName(), f))" />
                                }
                            </div>
                        </th>
                    }
                </tr>
                
                @* Filter Row *@
                @if (EnableFiltering && FilterMode == FilterMode.Row && visibleColumns.Any(c => c.Filterable))
                {
                    <tr class="bw-datagrid-filter-row">
                        @if (SelectionMode == BwSelectionMode.Single || SelectionMode == BwSelectionMode.Multiple)
                        {
                            <th class="bw-datagrid-filter-cell @cellPadding sticky left-0 z-30"></th>
                        }
                        
                        @if (EnableRowExpansion && DetailRowTemplate != null)
                        {
                            <th class="bw-datagrid-filter-cell @cellPadding"></th>
                        }
                        
                        @foreach (var column in visibleColumns)
                        {
                            var filter = GetFilterForColumn(column);
                            var frozenClass = column.Frozen switch
                            {
                                FrozenPosition.Left => "sticky left-0 z-30 bw-datagrid-frozen-cell",
                                FrozenPosition.Right => "sticky right-0 z-30 bw-datagrid-frozen-cell",
                                _ => ""
                            };
                            
                            <th class="bw-datagrid-filter-cell @cellPadding @frozenClass">
                                @if (column.Filterable)
                                {
                                    @if (column.FilterTemplate != null)
                                    {
                                        @column.FilterTemplate(new FilterContext
                                        {
                                            Field = column.GetFieldName(),
                                            CurrentFilter = filter,
                                            OnFilterChanged = f => _ = HandleFilterChanged(column.GetFieldName(), f)
                                        })
                                    }
                                    else
                                    {
                                        <BwDataGridFilter FilterType="@column.FilterType"
                                                          CurrentFilter="@filter"
                                                          FilterOptions="@column.FilterOptions"
                                                          OnFilterChanged="@(f => HandleFilterChanged(column.GetFieldName(), f))" />
                                    }
                                }
                            </th>
                        }
                    </tr>
                }
            </thead>
            
            @* Body *@
            <tbody>
                @if (processedItems.Any())
                {
                    var rowIndex = 0;
                    foreach (var item in processedItems)
                    {
                        var isSelected = IsItemSelected(item);
                        var isExpanded = IsRowExpanded(item);
                        var stripedClass = Striped && rowIndex % 2 == 1 && !isSelected ? "bw-datagrid-row-striped" : "";
                        var selectedClass = isSelected ? "bw-datagrid-row-selected" : "";
                        var hoverClass = Hoverable ? "bw-datagrid-row-hover" : "";
                        var customRowClass = RowClass?.Invoke(item) ?? "";
                        var customRowStyle = RowStyle?.Invoke(item) ?? "";
                        
                        <tr class="bw-datagrid-row @stripedClass @selectedClass @hoverClass @customRowClass"
                            style="@customRowStyle"
                            @onclick="@(() => HandleRowClick(item))"
                            @ondblclick="@(() => HandleRowDoubleClick(item))"
                            @oncontextmenu="@(e => { if (EnableContextMenu) { ShowContextMenu(item, e.ClientX, e.ClientY); } })"
                            @oncontextmenu:preventDefault="@EnableContextMenu">
                            
                            @* Selection Cell *@
                            @if (SelectionMode == BwSelectionMode.Single || SelectionMode == BwSelectionMode.Multiple)
                            {
                                <td class="bw-datagrid-body-cell @cellPadding w-12 text-center sticky left-0 z-20 @(isSelected ? "bw-datagrid-selection-cell bw-datagrid-row-selected" : "bw-datagrid-selection-cell")" @onclick:stopPropagation="true">
                                    @if (SelectionMode == BwSelectionMode.Multiple)
                                    {
                                        <BwCheckbox IsChecked="@isSelected" 
                                                    Size="BwSize.Small"
                                                    IsCheckedChanged="@((_) => ToggleSelection(item))" />
                                    }
                                    else
                                    {
                                        <BwRadio TValue="bool"
                                                 Value="true"
                                                 IsChecked="@isSelected" 
                                                 OnClick="@(() => ToggleSelection(item))" />
                                    }
                                </td>
                            }
                            
                            @* Expansion Cell *@
                            @if (EnableRowExpansion && DetailRowTemplate != null)
                            {
                                <td class="bw-datagrid-body-cell @cellPadding w-10 text-center @(isSelected ? "bw-datagrid-row-selected" : (Striped && rowIndex % 2 == 1 ? "bw-datagrid-row-striped" : ""))" @onclick:stopPropagation="true">
                                    <button type="button" 
                                            class="bw-datagrid-expand-btn"
                                            @onclick="@(() => ToggleRowExpansion(item))">
                                        <i class="fa-solid @(isExpanded ? "fa-chevron-down" : "fa-chevron-right") text-xs"></i>
                                    </button>
                                </td>
                            }
                            
                            @* Data Cells *@
                            @foreach (var column in visibleColumns)
                            {
                                var widthStyle = column.CurrentWidth.HasValue 
                                    ? $"width: {column.CurrentWidth}px;" 
                                    : (!string.IsNullOrEmpty(column.Width) ? $"width: {column.Width};" : "");
                                var alignClass = column.Align switch 
                                {
                                    TextAlign.Center => "text-center",
                                    TextAlign.Right => "text-right",
                                    _ => "text-left"
                                };
                                var frozenClass = column.Frozen switch
                                {
                                    FrozenPosition.Left => $"sticky left-0 z-20 {(isSelected ? "bw-datagrid-frozen-body-cell bw-datagrid-row-selected" : "bw-datagrid-frozen-body-cell")}",
                                    FrozenPosition.Right => $"sticky right-0 z-20 {(isSelected ? "bw-datagrid-frozen-body-cell bw-datagrid-row-selected" : "bw-datagrid-frozen-body-cell")}",
                                    _ => ""
                                };
                                
                                <td class="bw-datagrid-body-cell @cellPadding @alignClass @frozenClass @column.CellClass" style="@widthStyle">
                                    @if (column.Template != null)
                                    {
                                        @column.Template(item)
                                    }
                                    else if (column.Ellipsis)
                                    {
                                        <div class="truncate" style="max-width: @(column.EllipsisMaxWidth ?? "200px");" 
                                             title="@(column.GetValue(item)?.ToString() ?? "")">
                                            @(column.GetValue(item)?.ToString() ?? "")
                                        </div>
                                    }
                                    else
                                    {
                                        @(column.GetValue(item)?.ToString() ?? "")
                                    }
                                </td>
                            }
                        </tr>
                        
                        @* Detail Row *@
                        @if (EnableRowExpansion && DetailRowTemplate != null && isExpanded)
                        {
                            <tr class="bw-datagrid-detail-row">
                                <td colspan="@(visibleColumns.Count + (SelectionMode != BwSelectionMode.None ? 1 : 0) + 1)">
                                    @DetailRowTemplate(item)
                                </td>
                            </tr>
                        }
                        
                        rowIndex++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@(visibleColumns.Count + (SelectionMode != BwSelectionMode.None ? 1 : 0) + (EnableRowExpansion && DetailRowTemplate != null ? 1 : 0))" 
                            class="bw-datagrid-body-cell @cellPadding text-center py-12">
                            @if (EmptyContent != null)
                            {
                                @EmptyContent
                            }
                            else
                            {
                                <div class="bw-datagrid-empty">
                                    <i class="fa-solid fa-inbox bw-datagrid-empty-icon"></i>
                                    <p class="bw-datagrid-empty-text">Gösterilecek veri bulunamadı</p>
                                </div>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    @* Footer / Pagination / Export *@
    @if (FooterContent != null || EnablePagination || EnableExport)
    {
        <div class="bw-datagrid-footer">
            <div class="flex items-center gap-4">
                @FooterContent
            </div>
            
            <div class="flex items-center gap-4">
                @if (EnablePagination)
                {
                    <BwPagination TotalItems="@totalCount"
                                  PageSize="@_currentPageSize"
                                  CurrentPage="@_currentPage"
                                  CurrentPageChanged="HandlePageChanged"
                                  PageSizeChanged="HandlePageSizeChanged"
                                  ShowPageSizeSelector="true"
                                  Compact="@CompactPagination"
                                  ShowInfo="true" />
                }
                
                @if (EnableExport)
                {
                    <div class="bw-datagrid-export-divider">
                        <BwDropdown Alignment="BwDirection.Right" VPosition="BwDirection.Top">
                            <TriggerContent>
                                <button type="button"
                                        class="bw-datagrid-toolbar-btn shadow-sm">
                                    <i class="fa-solid fa-download" style="color: var(--bw-color-primary);"></i>
                                    <span>Dışa Aktar</span>
                                    <i class="fa-solid fa-chevron-down text-xs" style="color: var(--bw-gray-500);"></i>
                                </button>
                            </TriggerContent>
                            <ChildContent>
                                <BwDropdownHeader Title="Dışa Aktarma Formatları" />
                                <BwDropdownItem Text="Excel (.xlsx)" 
                                                Icon="fa-solid fa-file-excel" 
                                                IconClass="text-green-600"
                                                OnClick="@(() => ExportByFormat("xlsx"))" />
                                <BwDropdownItem Text="CSV (.csv)"
                                                Icon="fa-solid fa-file-csv"
                                                IconClass="text-blue-600"
                                                OnClick="@(() => ExportByFormat("csv"))" />
                                <BwDropdownItem Text="TSV (.tsv)"
                                                Icon="fa-solid fa-file-lines"
                                                IconClass="text-purple-600"
                                                OnClick="@(() => ExportByFormat("tsv"))" />
                                <BwDropdownItem Text="JSON (.json)"
                                                Icon="fa-solid fa-file-code"
                                                IconClass="text-orange-500"
                                                OnClick="@(() => ExportByFormat("json"))" />
                            </ChildContent>
                        </BwDropdown>
                    </div>
                }
            </div>
        </div>
    }
    
    @* Context Menu *@
    @if (_showContextMenu && _contextMenuItem != null && ContextMenuContent != null)
    {
        <div class="fixed z-[1070]" style="left: @(_contextMenuX)px; top: @(_contextMenuY)px;">
            <div class="bw-datagrid-context-menu"
                 @onclick="HideContextMenu">
                @ContextMenuContent(_contextMenuItem)
            </div>
        </div>
        <div class="fixed inset-0 z-[1060]" @onclick="HideContextMenu"></div>
    }
</div>
