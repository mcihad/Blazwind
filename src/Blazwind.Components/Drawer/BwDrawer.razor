@namespace Blazwind.Components.Drawer
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inherits BwBase
@inject IJSRuntime JS
@implements IAsyncDisposable

@{
    // Position classes
    var positionClasses = Options.Position switch
    {
        BwDirection.Left => "left-0 top-0 h-full",
        BwDirection.Right => "right-0 top-0 h-full",
        BwDirection.Top => "top-0 left-0 w-full",
        BwDirection.Bottom => "bottom-0 left-0 w-full",
        _ => "right-0 top-0 h-full"
    };

    // Size computation
    var sizeStyle = GetSizeStyle();

    // Animation classes
    var slideIn = Options.Position switch
    {
        BwDirection.Left => "animate-slide-in-left",
        BwDirection.Right => "animate-slide-in-right",
        BwDirection.Top => "animate-slide-in-top",
        BwDirection.Bottom => "animate-slide-in-bottom",
        _ => "animate-slide-in-right"
    };

    // Resize cursor
    var resizeCursor = Options.Position switch
    {
        BwDirection.Left => "cursor-e-resize",
        BwDirection.Right => "cursor-w-resize",
        BwDirection.Top => "cursor-s-resize",
        BwDirection.Bottom => "cursor-n-resize",
        _ => ""
    };
    
    // Border for resize handle
    var widthClass = Options.Size switch
    {
        BwSize.Small => "w-[300px]",
        BwSize.Large => "w-[600px]",
        BwSize.ExtraLarge => "w-[800px]",
        BwSize.Full => "w-screen",
        _ => "w-[400px]" // Medium
    };

    // Variant styles
    var (bgColor, borderColor, headerBg, textColor) = Options.Color switch
    {
        BwColor.Primary => ("bg-white dark:bg-gray-900", "border-blue-200 dark:border-blue-800", "bg-blue-50 dark:bg-blue-900/10", "text-blue-900 dark:text-blue-100"),
        BwColor.Dark => ("bg-gray-900", "border-gray-700", "bg-gray-800", "text-white"),
        _ => ("bg-white dark:bg-gray-900", "border-gray-200 dark:border-gray-800", "bg-gray-50 dark:bg-gray-800", "text-gray-900 dark:text-gray-100")
    };
}

@* Overlay *@
@if (Options.ShowOverlay)
{
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[1060] animate-fade-in"
         @onclick="HandleOverlayClick"
         @onclick:stopPropagation="true">
    </div>
}

@* Drawer Panel *@
<div id="@Id"
     class="@CombineClasses($"fixed z-[1070] {positionClasses} {bgColor} {borderColor} shadow-2xl flex flex-col {slideIn} {Options.Class}")"
     style="@sizeStyle"
     @onkeydown="HandleKeyDown"
     tabindex="-1" @attributes="AdditionalAttributes">
    
    @* Resize Handle *@
    @if (Options.Resizable)
    {
        <div data-resize-handle
             class="absolute @GetResizeHandlePosition() @resizeCursor bg-transparent hover:bg-blue-500/20 transition-colors z-10">
        </div>
    }

    @* Header *@
    @if (!string.IsNullOrEmpty(Title) || Options.ShowClose)
    {
        <div class="flex items-center justify-between px-4 py-3 border-b @borderColor @headerBg shrink-0">
            <h3 class="font-semibold @textColor text-base truncate">@Title</h3>
            @if (Options.ShowClose)
            {
                <button type="button"
                        class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/10 rounded p-1.5 transition-colors"
                        @onclick="HandleClose">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            }
        </div>
    }

    @* Body *@
    <div class="flex-1 overflow-y-auto p-4">
        @ChildContent
    </div>

    @* Footer *@
    @if (Footer != null)
    {
        <div class="px-4 py-3 border-t @borderColor @headerBg shrink-0 flex items-center justify-end gap-3">
            @Footer
        </div>
    }
</div>

@code {

    [Parameter] public string? Title { get; set; }
    [Parameter] public DrawerOptions Options { get; set; } = DrawerOptions.Default;
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? Footer { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (string.IsNullOrEmpty(Id))
        {
            Id = Guid.NewGuid().ToString("N");
        }

        if (firstRender && Options.Resizable)
        {
            try
            {
                var minSize = int.TryParse(Options.MinSize?.Replace("px", ""), out var min) ? min : 200;
                var maxSize = int.TryParse(Options.MaxSize?.Replace("px", ""), out var max) ? max : 800;
                await JS.InvokeVoidAsync("Blazwind.Drawer.initializeDrawerResize", Id, Options.Position.ToString(), minSize, maxSize);
            }
            catch
            {
                // JS not available
            }
        }
    }

    private string GetSizeStyle()
    {
        var isHorizontal = Options.Position == BwDirection.Left || Options.Position == BwDirection.Right;
        
        // Custom size overrides
        if (isHorizontal && !string.IsNullOrEmpty(Options.Width))
            return $"width: {Options.Width};";
        if (!isHorizontal && !string.IsNullOrEmpty(Options.Height))
            return $"height: {Options.Height};";

        // Preset sizes
        var size = Options.Size switch
        {
            BwSize.Small => isHorizontal ? "240px" : "200px",
            BwSize.Medium => isHorizontal ? "320px" : "300px",
            BwSize.Large => isHorizontal ? "480px" : "400px",
            BwSize.ExtraLarge => isHorizontal ? "640px" : "500px",
            BwSize.Full => "100%",
            _ => isHorizontal ? "320px" : "300px"
        };

        return isHorizontal ? $"width: {size}; max-width: 100vw;" : $"height: {size}; max-height: 100vh;";
    }

    private string GetResizeHandlePosition()
    {
        return Options.Position switch
        {
            BwDirection.Left => "right-0 top-0 w-2 h-full",
            BwDirection.Right => "left-0 top-0 w-2 h-full",
            BwDirection.Top => "bottom-0 left-0 h-2 w-full",
            BwDirection.Bottom => "top-0 left-0 h-2 w-full",
            _ => ""
        };
    }

    private async Task HandleOverlayClick()
    {
        if (Options.CloseOnOverlayClick)
        {
            await HandleClose();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && Options.CloseOnEscape)
        {
            await HandleClose();
        }
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }

    private void StartResize(MouseEventArgs e)
    {

        // JS interop for resize would go here
    }

    public ValueTask DisposeAsync()
    {
        return ValueTask.CompletedTask;
    }
}
