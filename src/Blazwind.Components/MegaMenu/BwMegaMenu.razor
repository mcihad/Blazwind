@namespace Blazwind.Components.MegaMenu
@using Blazwind.Components.Shared
@using Blazwind.Components.Button
@inherits BwBase

<div class="@CombineClasses("bw-megamenu")" style="@Style" id="@Id" @onmouseenter="HandleMouseEnter" @onmouseleave="HandleMouseLeave" @attributes="AdditionalAttributes">
    @* Trigger *@
    <div class="bw-megamenu-trigger" @onclick="HandleTriggerClick">
        @if (TriggerContent != null)
        {
            @TriggerContent
        }
        else
        {
            <BwButton Text="@Text" Icon="@Icon" Color="Color" Variant="Variant" EndIcon="@ChevronIcon"
                Size="BwSize.Small" />
        }
    </div>

    @* Menu Dropdown *@
    @if (_isOpen)
    {
        <div class="@DropdownClasses">
            <div class="@ContentClasses" style="@ColumnStyle">
                @ChildContent
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public RenderFragment? TriggerContent { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string? Text { get; set; }
    [Parameter] public string? Icon { get; set; }
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public BwVariant Variant { get; set; } = BwVariant.Ghost;
    [Parameter] public int Columns { get; set; } = 3;
    [Parameter] public string? ColumnWidth { get; set; }
    [Parameter] public MegaMenuWidth Width { get; set; } = MegaMenuWidth.Auto;
    [Parameter] public MegaMenuAlignment Alignment { get; set; } = MegaMenuAlignment.Start;
    [Parameter] public MegaMenuTrigger Trigger { get; set; } = MegaMenuTrigger.Hover;
    [Parameter] public bool OpenUpward { get; set; }
    [Parameter] public int ShowDelay { get; set; } = 50;
    [Parameter] public int HideDelay { get; set; } = 150;
    
    [Parameter] public EventCallback<bool> OnOpenChanged { get; set; }

    private bool _isOpen;
    private CancellationTokenSource? _showCts;
    private CancellationTokenSource? _hideCts;

    private string ChevronIcon => OpenUpward ? "fa-solid fa-chevron-up" : "fa-solid fa-chevron-down";

    private string DropdownClasses
    {
        get
        {
            var classes = new List<string> { "bw-megamenu-dropdown" };
            classes.Add(OpenUpward ? "bw-megamenu-dropdown--top" : "bw-megamenu-dropdown--bottom");
            classes.Add(Alignment switch
            {
                MegaMenuAlignment.Center => "bw-megamenu-dropdown--center",
                MegaMenuAlignment.End => "bw-megamenu-dropdown--end",
                _ => "bw-megamenu-dropdown--start"
            });
            classes.Add(Width switch
            {
                MegaMenuWidth.Small => "bw-megamenu-dropdown--small",
                MegaMenuWidth.Medium => "bw-megamenu-dropdown--medium",
                MegaMenuWidth.Large => "bw-megamenu-dropdown--large",
                MegaMenuWidth.XLarge => "bw-megamenu-dropdown--xlarge",
                MegaMenuWidth.Full => "bw-megamenu-dropdown--full",
                _ => "bw-megamenu-dropdown--auto"
            });
            return string.Join(" ", classes);
        }
    }

    private string ContentClasses
    {
        get
        {
            var classes = new List<string> { "bw-megamenu-content" };
            classes.Add($"bw-megamenu-content--cols-{Math.Clamp(Columns, 1, 6)}");
            return string.Join(" ", classes);
        }
    }

    private string? ColumnStyle => !string.IsNullOrEmpty(ColumnWidth)
        ? $"grid-template-columns: repeat({Columns}, {ColumnWidth});"
        : null;

    private async Task HandleMouseEnter()
    {
        if (Trigger == MegaMenuTrigger.Click) return;

        _hideCts?.Cancel();
        _showCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(ShowDelay, _showCts.Token);
            await Open();
        }
        catch (TaskCanceledException) { }
    }

    private async Task HandleMouseLeave()
    {
        if (Trigger == MegaMenuTrigger.Click) return;

        _showCts?.Cancel();
        _hideCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(HideDelay, _hideCts.Token);
            await Close();
        }
        catch (TaskCanceledException) { }
    }

    private async Task HandleTriggerClick()
    {
        if (Trigger == MegaMenuTrigger.Hover) return;
        await Toggle();
    }

    public async Task Open()
    {
        _isOpen = true;
        await OnOpenChanged.InvokeAsync(true);
        StateHasChanged();
    }

    public async Task Close()
    {
        _isOpen = false;
        await OnOpenChanged.InvokeAsync(false);
        StateHasChanged();
    }

    public async Task Toggle()
    {
        if (_isOpen)
            await Close();
        else
            await Open();
    }
}