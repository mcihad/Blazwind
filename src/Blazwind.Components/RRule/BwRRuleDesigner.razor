@namespace Blazwind.Components.RRule
@using Blazwind.Components.Shared
@using Blazwind.Components.Layout
@using Blazwind.Components.Input
@using Blazwind.Components.Button
@using Blazwind.Components.Form
@using Blazwind.Components.Typography
@using Blazwind.Components.Border
@inherits BwBase

<BwColumn Spacing="BwSpacing.Md" Class="@CombineClasses("")" Style="@Style" Id="@Id" @attributes="AdditionalAttributes">
    @* Frequency & Interval Section *@
    <BwBorder Color="BwColor.Light" Padding="BwSize.Medium" Title="Recurrence">
        <BwColumn Spacing="BwSpacing.Md">
            <BwRow Spacing="BwSpacing.Lg" Wrap="true" CrossAxisAlignment="BwCrossAxisAlignment.End">
                <BwColumn Spacing="BwSpacing.Xs" Class="min-w-32">
                    <BwTypography Size="BwSize.Small" Color="BwColor.Secondary" Weight="BwFontWeight.Medium">Frequency
                    </BwTypography>
                    <BwSelect @bind-Value="_frequencyValue" Items="@_frequencyItems" />
                </BwColumn>

                <BwColumn Spacing="BwSpacing.Xs">
                    <BwTypography Size="BwSize.Small" Color="BwColor.Secondary" Weight="BwFontWeight.Medium">Interval
                    </BwTypography>
                    <BwRow Spacing="BwSpacing.Sm" CrossAxisAlignment="BwCrossAxisAlignment.Center">
                        <BwTypography Size="BwSize.Small" Color="BwColor.Secondary">Every</BwTypography>
                        <BwInput Type="number" @bind-Value="@_intervalValue" Class="w-16" />
                        <BwTypography Size="BwSize.Small" Color="BwColor.Secondary">@IntervalLabel</BwTypography>
                    </BwRow>
                </BwColumn>
            </BwRow>
        </BwColumn>
    </BwBorder>

    @* Weekly: Day Selection *@
    @if (Options.Frequency == RRuleFrequency.Weekly)
    {
        <BwBorder Color="BwColor.Light" Padding="BwSize.Medium" Title="Days">
            <BwRow Spacing="BwSpacing.Xs" Wrap="true">
                @foreach (var day in _weekDays)
                {
                    var isSelected = Options.ByDays.Contains(day.Day);
                    <BwButton Text="@day.ShortName" Size="BwSize.Small" Color="@(isSelected? BwColor.Primary: BwColor.Light)"
                        Variant="@(isSelected? BwVariant.Filled: BwVariant.Outline)" OnClick="@(() => ToggleDay(day.Day))" />
                }
            </BwRow>
        </BwBorder>
    }

    @* Monthly: Type Selection *@
    @if (Options.Frequency == RRuleFrequency.Monthly)
    {
        <BwBorder Color="BwColor.Light" Padding="BwSize.Medium" Title="Monthly Options">
            <BwColumn Spacing="BwSpacing.Sm">
                @* Day of Month *@
                <BwRow Spacing="BwSpacing.Sm" CrossAxisAlignment="BwCrossAxisAlignment.Center">
                    <div class="bw-rrule-radio @(Options.MonthlyType == RRuleMonthlyType.DayOfMonth ? "selected" : "")"
                        @onclick="@(() => { Options.MonthlyType = RRuleMonthlyType.DayOfMonth; NotifyChange(); })">
                        @if (Options.MonthlyType == RRuleMonthlyType.DayOfMonth)
                        {
                            <div class="bw-rrule-radio-dot"></div>
                        }
                    </div>
                    <BwTypography Size="BwSize.Small" Color="BwColor.Secondary">Day of month</BwTypography>
                    <BwInput Type="number" @bind-Value="@_monthDayValue" Class="w-16"
                        IsDisabled="@(Options.MonthlyType != RRuleMonthlyType.DayOfMonth)" />
                    <BwTypography Size="BwSize.Small" Color="BwColor.Secondary">th day</BwTypography>
                </BwRow>

                @* Weekday of Month *@
                <BwRow Spacing="BwSpacing.Sm" CrossAxisAlignment="BwCrossAxisAlignment.Center" Wrap="true">
                    <div class="bw-rrule-radio @(Options.MonthlyType == RRuleMonthlyType.WeekdayOfMonth ? "selected" : "")"
                        @onclick="@(() => { Options.MonthlyType = RRuleMonthlyType.WeekdayOfMonth; NotifyChange(); })">
                        @if (Options.MonthlyType == RRuleMonthlyType.WeekdayOfMonth)
                        {
                            <div class="bw-rrule-radio-dot">
                            </div>
                        }
                    </div>
                    <BwSelect @bind-Value="_setPosValue" Class="w-20" Items="@_setPosItems"
                        IsDisabled="@(Options.MonthlyType != RRuleMonthlyType.WeekdayOfMonth)" />
                    <BwSelect @bind-Value="_weekDayValue" Class="w-28" Items="@_weekDayItems"
                        IsDisabled="@(Options.MonthlyType != RRuleMonthlyType.WeekdayOfMonth)" />
                </BwRow>
            </BwColumn>
        </BwBorder>
    }

    @* Yearly: Month and Day *@
    @if (Options.Frequency == RRuleFrequency.Yearly)
    {
        <BwBorder Color="BwColor.Light" Padding="BwSize.Medium" Title="Yearly Date">
            <BwRow Spacing="BwSpacing.Sm" CrossAxisAlignment="BwCrossAxisAlignment.Center">
                <BwInput Type="number" @bind-Value="@_monthDayValue" Class="w-16" />
                <BwSelect @bind-Value="_monthValue" Class="w-28" Items="@_monthItems" />
            </BwRow>
        </BwBorder>
    }

    @* End Type *@
    <BwBorder Color="BwColor.Light" Padding="BwSize.Medium" Title="End">
        <BwColumn Spacing="BwSpacing.Sm">
            @* Never *@
            <BwRow Spacing="BwSpacing.Sm" CrossAxisAlignment="BwCrossAxisAlignment.Center">
                <div class="bw-rrule-radio @(Options.EndType == RRuleEndType.Never ? "selected" : "")"
                    @onclick="@(() => { Options.EndType = RRuleEndType.Never; NotifyChange(); })">
                    @if (Options.EndType == RRuleEndType.Never)
                    {
                        <div class="bw-rrule-radio-dot"></div>
                    }
                </div>
                <BwTypography Size="BwSize.Small" Color="BwColor.Dark">Continue indefinitely</BwTypography>
            </BwRow>

            @* After Count *@
            <BwRow Spacing="BwSpacing.Sm" CrossAxisAlignment="BwCrossAxisAlignment.Center">
                <div class="bw-rrule-radio @(Options.EndType == RRuleEndType.AfterCount ? "selected" : "")"
                    @onclick="@(() => { Options.EndType = RRuleEndType.AfterCount; NotifyChange(); })">
                    @if (Options.EndType == RRuleEndType.AfterCount)
                    {
                        <div class="bw-rrule-radio-dot"></div>
                    }
                </div>
                <BwInput Type="number" @bind-Value="@_countValue" Class="w-16"
                    IsDisabled="@(Options.EndType != RRuleEndType.AfterCount)" />
                <BwTypography Size="BwSize.Small" Color="BwColor.Dark">occurrences</BwTypography>
            </BwRow>

            @* Until Date *@
            <BwRow Spacing="BwSpacing.Sm" CrossAxisAlignment="BwCrossAxisAlignment.Center">
                <div class="bw-rrule-radio @(Options.EndType == RRuleEndType.UntilDate ? "selected" : "")"
                    @onclick="@(() => { Options.EndType = RRuleEndType.UntilDate; NotifyChange(); })">
                    @if (Options.EndType == RRuleEndType.UntilDate)
                    {
                        <div class="bw-rrule-radio-dot"></div>
                    }
                </div>
                <BwInput Type="date" @bind-Value="@_untilValue" Class="w-36"
                    IsDisabled="@(Options.EndType != RRuleEndType.UntilDate)" />
                <BwTypography Size="BwSize.Small" Color="BwColor.Dark">until</BwTypography>
            </BwRow>
        </BwColumn>
    </BwBorder>

    @* Preview *@
    @if (ShowPreview)
    {
        <BwBorder Color="BwColor.Info" Padding="BwSize.Medium" Title="Preview" HasShadow="true">
            <BwColumn Spacing="BwSpacing.Sm">
                <BwTypography Color="BwColor.Dark">@HumanReadableText</BwTypography>
                <code class="bw-rrule-preview-code">
                            @RRuleString
                        </code>
            </BwColumn>
        </BwBorder>
    }
</BwColumn>

@code {
    /// <summary>Başlangıç tarihi</summary>
    [Parameter] public DateTime StartDate { get; set; } = DateTime.Today;

    /// <summary>RRULE string değeri (two-way binding)</summary>
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>Önizleme gösterilsin mi?</summary>
    [Parameter] public bool ShowPreview { get; set; } = true;

    /// <summary>Değişiklik callback</summary>
    [Parameter] public EventCallback<RRuleOptions> OnOptionsChanged { get; set; }

    // Internal state
    private RRuleOptions Options { get; set; } = new();
    private List<WeekDayInfo> _weekDays = new();
    private bool _initialized;

    // Select Items
    private static readonly List<BwSelectItem<string>> _frequencyItems = new()
{
new("Daily", "Daily"),
new("Weekly", "Weekly"),
new("Monthly", "Monthly"),
new("Yearly", "Yearly")
};

    private static readonly List<BwSelectItem<string>> _setPosItems = new()
{
new("1", "1st"),
new("2", "2nd"),
new("3", "3rd"),
new("4", "4th"),
new("-1", "Last")
};

    private static readonly List<BwSelectItem<string>> _weekDayItems = new()
{
new("1", "Monday"),
new("2", "Tuesday"),
new("3", "Wednesday"),
new("4", "Thursday"),
new("5", "Friday"),
new("6", "Saturday"),
new("0", "Sunday")
};

    private static readonly List<BwSelectItem<string>> _monthItems = new()
{
new("1", "January"), new("2", "February"), new("3", "March"),
new("4", "April"), new("5", "May"), new("6", "June"),
new("7", "July"), new("8", "August"), new("9", "September"),
new("10", "October"), new("11", "November"), new("12", "December")
};

    // Computed properties
    private string RRuleString => RRuleBuilder.Build(Options);
    private string HumanReadableText => RRuleBuilder.GetHumanReadable(Options);

    private string IntervalLabel => Options.Frequency switch
    {
        RRuleFrequency.Daily => "day",
        RRuleFrequency.Weekly => "week",
        RRuleFrequency.Monthly => "month",
        RRuleFrequency.Yearly => "year",
        _ => "day"
    };

    // Binding helpers
    private string _frequencyValue
    {
        get => Options.Frequency.ToString();
        set
        {
            if (Enum.TryParse<RRuleFrequency>(value, out var freq))
            {
                Options.Frequency = freq;
                NotifyChange();
            }
        }
    }

    private string _intervalValue
    {
        get => Options.Interval.ToString();
        set
        {
            if (int.TryParse(value, out var v) && v > 0)
            {
                Options.Interval = v;
                NotifyChange();
            }
        }
    }

    private string _monthDayValue
    {
        get => Options.ByMonthDay.ToString();
        set
        {
            if (int.TryParse(value, out var v) && v >= 1 && v <= 31)
            {
                Options.ByMonthDay = v;
                NotifyChange();
            }
        }
    }

    private string _setPosValue
    {
        get => Options.BySetPos.ToString();
        set
        {
            if (int.TryParse(value, out var v))
            {
                Options.BySetPos = v;
                NotifyChange();
            }
        }
    }

    private string _weekDayValue
    {
        get => ((int)Options.ByWeekDay).ToString();
        set
        {
            if (int.TryParse(value, out var v))
            {
                Options.ByWeekDay = (DayOfWeek)v;
                NotifyChange();
            }
        }
    }

    private string _monthValue
    {
        get => Options.ByMonth.ToString();
        set
        {
            if (int.TryParse(value, out var v) && v >= 1 && v <= 12)
            {
                Options.ByMonth = v;
                NotifyChange();
            }
        }
    }

    private string _countValue
    {
        get => Options.Count.ToString();
        set
        {
            if (int.TryParse(value, out var v) && v > 0)
            {
                Options.Count = v;
                NotifyChange();
            }
        }
    }

    private string _untilValue
    {
        get => Options.Until?.ToString("yyyy-MM-dd") ?? "";
        set
        {
            if (DateTime.TryParse(value, out var d))
            {
                Options.Until = d;
                NotifyChange();
            }
        }
    }

    protected override void OnInitialized()
    {
        InitializeWeekDays();

        if (!string.IsNullOrWhiteSpace(Value))
        {
            Options = RRuleBuilder.Parse(Value);
        }
        else
        {
            Options = RRuleOptions.CreateDefault(StartDate);
        }

        _initialized = true;
    }

    protected override void OnParametersSet()
    {
        if (_initialized && !string.IsNullOrWhiteSpace(Value))
        {
            var currentRRule = RRuleBuilder.Build(Options);
            if (currentRRule != Value)
            {
                Options = RRuleBuilder.Parse(Value);
            }
        }
    }

    private void InitializeWeekDays()
    {
        _weekDays = new List<WeekDayInfo>
{
new() { Day = DayOfWeek.Monday, ShortName = "Mo", LongName = "Monday" },
new() { Day = DayOfWeek.Tuesday, ShortName = "Tu", LongName = "Tuesday" },
new() { Day = DayOfWeek.Wednesday, ShortName = "We", LongName = "Wednesday" },
new() { Day = DayOfWeek.Thursday, ShortName = "Th", LongName = "Thursday" },
new() { Day = DayOfWeek.Friday, ShortName = "Fr", LongName = "Friday" },
new() { Day = DayOfWeek.Saturday, ShortName = "Sa", LongName = "Saturday" },
new() { Day = DayOfWeek.Sunday, ShortName = "Su", LongName = "Sunday" }
};
    }

    private void ToggleDay(DayOfWeek day)
    {
        if (Options.ByDays.Contains(day))
            Options.ByDays.Remove(day);
        else
            Options.ByDays.Add(day);

        NotifyChange();
    }

    private async void NotifyChange()
    {
        var rrule = RRuleBuilder.Build(Options);

        if (ValueChanged.HasDelegate)
            await ValueChanged.InvokeAsync(rrule);

        if (OnOptionsChanged.HasDelegate)
            await OnOptionsChanged.InvokeAsync(Options);

        StateHasChanged();
    }
}