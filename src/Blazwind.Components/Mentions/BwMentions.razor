@namespace Blazwind.Components.Mentions
@inherits BwBase
@using Blazwind.Components.Shared
@using Blazwind.Components
@using Microsoft.AspNetCore.Components.Web

<div class="@CombineClasses("relative")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    <textarea @ref="_textareaRef"
        class="@CombineClasses("bw-mentions-textarea", GetSizeClass(), GetVariantClass(), GetFocusClass())"
        placeholder="@Placeholder" disabled="@IsDisabled" rows="@Rows" @bind="_internalValue" @bind:event="oninput"
        @onkeydown="HandleKeyDown" @onkeydown:preventDefault="_preventKeyDown"
        @onblur="HandleBlur"></textarea>

    @if (_showSuggestions && _filteredMentions.Any())
    {
        <div class="bw-mentions-dropdown"
            style="bottom: 100%; left: 0; margin-bottom: 4px;">
            @foreach (var mention in _filteredMentions)
            {
                var isSelected = _selectedIndex == _filteredMentions.IndexOf(mention);
                <button type="button"
                    class="@($"bw-mentions-item {(isSelected ? "bw-mentions-item-selected" : "")}")"
                    @onmousedown="() => SelectMention(mention)" @onmousedown:preventDefault>
                    @if (!string.IsNullOrEmpty(mention.Avatar))
                    {
                        <img src="@mention.Avatar" alt="@mention.Label" class="bw-mentions-item-avatar" />
                    }
                    else
                    {
                        <div class="bw-mentions-item-avatar-placeholder">
                            @mention.Label?.FirstOrDefault()
                        </div>
                    }
                    <div class="flex flex-col min-w-0">
                        <span class="bw-mentions-item-label">@mention.Label</span>
                        @if (!string.IsNullOrEmpty(mention.Description))
                        {
                            <span class="bw-mentions-item-description">@mention.Description</span>
                        }
                    </div>
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Bir şeyler yazın... @ ile bahsedin";
    [Parameter] public string Prefix { get; set; } = "@";
    [Parameter] public int Rows { get; set; } = 3;
    [Parameter] public bool IsDisabled { get; set; } = false;
    [Parameter] public List<BwMentionItem> Mentions { get; set; } = new();
    [Parameter] public EventCallback<BwMentionItem> OnMention { get; set; } = new();
    [Parameter] public BwSize Size { get; set; } = BwSize.Medium;
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public BwVariant Variant { get; set; } = BwVariant.Outline;

    [Parameter] public EventCallback<KeyboardEventArgs> OnKeyDown { get; set; }

    private ElementReference _textareaRef;
    private bool _showSuggestions = false;
    private bool _preventKeyDown = false;
    private string _searchQuery = "";
    private int _selectedIndex = 0;
    private int _mentionStartPos = -1;
    private List<BwMentionItem> _filteredMentions = new();

    private string _internalValue
    {
        get => Value;
        set
        {
            Value = value;
            ValueChanged.InvokeAsync(value);
            CheckForMentionTrigger(value);
        }
    }

    private string GetSizeClass() => Size switch
    {
        BwSize.Small => "bw-mentions-size-small",
        BwSize.Large => "bw-mentions-size-large",
        _ => "bw-mentions-size-medium"
    };

    private string GetVariantClass() => Variant switch
    {
        BwVariant.Filled => "bw-mentions-variant-filled",
        BwVariant.Ghost => "bw-mentions-variant-ghost",
        _ => "bw-mentions-variant-outline"
    };

    private string GetFocusClass() => Color switch
    {
        BwColor.Success => "bw-mentions-focus-success",
        BwColor.Danger => "bw-mentions-focus-danger",
        BwColor.Warning => "bw-mentions-focus-warning",
        BwColor.Info => "bw-mentions-focus-info",
        BwColor.Secondary => "bw-mentions-focus-secondary",
        _ => "bw-mentions-focus-primary"
    };

    private void CheckForMentionTrigger(string text)
    {
        var lastAtIndex = text.LastIndexOf(Prefix);
        if (lastAtIndex >= 0)
        {
            var textAfterAt = text.Substring(lastAtIndex + 1);
            // Eğer @ sonrasında boşluk yoksa ve 20 karakterden kısaysa
            if (!textAfterAt.Contains(" ") && !textAfterAt.Contains("\n") && textAfterAt.Length <= 20)
            {
                _searchQuery = textAfterAt.ToLower();
                _mentionStartPos = lastAtIndex;
                _filteredMentions = Mentions
                .Where(m => string.IsNullOrEmpty(_searchQuery) ||
                m.Label?.ToLower().Contains(_searchQuery) == true ||
                m.Value?.ToLower().Contains(_searchQuery) == true)
                .Take(10)
                .ToList();
                _showSuggestions = _filteredMentions.Any();
                _selectedIndex = 0;
            }
            else
            {
                _showSuggestions = false;
            }
        }
        else
        {
            _showSuggestions = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        _preventKeyDown = false;

        if (_showSuggestions)
        {
            if (e.Key == "ArrowDown")
            {
                _selectedIndex = Math.Min(_selectedIndex + 1, _filteredMentions.Count - 1);
                _preventKeyDown = true;
                return;
            }
            else if (e.Key == "ArrowUp")
            {
                _selectedIndex = Math.Max(_selectedIndex - 1, 0);
                _preventKeyDown = true;
                return;
            }
            else if (e.Key == "Enter" || e.Key == "Tab")
            {
                if (_selectedIndex >= 0 && _selectedIndex < _filteredMentions.Count)
                {
                    await SelectMention(_filteredMentions[_selectedIndex]);
                    _preventKeyDown = true;
                    return;
                }
            }
            else if (e.Key == "Escape")
            {
                _showSuggestions = false;
                _preventKeyDown = true;
                return;
            }
        }
        
        // Bubble up normal keys
        await OnKeyDown.InvokeAsync(e);
    }

    private void HandleBlur()
    {
        // Delay hiding to allow click on suggestions
        _ = Task.Delay(150).ContinueWith(_ =>
        {
            _showSuggestions = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task SelectMention(BwMentionItem mention)
    {
        if (_mentionStartPos >= 0 && _mentionStartPos < Value.Length)
        {
            var before = Value.Substring(0, _mentionStartPos);
            var mentionText = $"{Prefix}{mention.Value ?? mention.Label} ";
            Value = before + mentionText;

            await ValueChanged.InvokeAsync(Value);
            await OnMention.InvokeAsync(mention);
        }

        _showSuggestions = false;
        _mentionStartPos = -1;
        StateHasChanged();
    }
}