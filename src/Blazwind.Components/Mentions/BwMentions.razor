@namespace Blazwind.Components.Mentions
@inherits BwBase
@using Blazwind.Components.Shared
@using Blazwind.Components
@using Microsoft.AspNetCore.Components.Web

@{
    var sizeClasses = Size switch
    {
        BwSize.Small => "text-sm py-1.5 px-2.5",
        BwSize.Large => "text-lg py-3 px-4",
        _ => "text-base py-2 px-3"
    };

    var variantClasses = Variant switch
    {
        BwVariant.Filled => "bg-gray-100 dark:bg-gray-800/50 border-transparent focus:bg-white dark:focus:bg-gray-800",
        BwVariant.Ghost => "bg-transparent border-transparent hover:bg-gray-50 dark:hover:bg-gray-800",
        _ => "bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-700"
    };

    var focusClasses = Color switch
    {
        BwColor.Success => "focus:border-emerald-500 focus:ring-emerald-500",
        BwColor.Danger => "focus:border-red-500 focus:ring-red-500",
        BwColor.Warning => "focus:border-amber-500 focus:ring-amber-500",
        BwColor.Info => "focus:border-sky-500 focus:ring-sky-500",
        _ => "focus:border-blue-500 focus:ring-blue-500"
    };
}

<div class="@CombineClasses("relative")" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    <textarea @ref="_textareaRef"
        class="w-full rounded-lg border @sizeClasses @variantClasses @focusClasses focus:outline-none focus:ring-2 transition-all resize-none text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-500 @(IsDisabled ? "opacity-50 cursor-not-allowed" : "")"
        placeholder="@Placeholder" disabled="@IsDisabled" rows="@Rows" @bind="_internalValue" @bind:event="oninput"
        @onkeydown="HandleKeyDown" @onkeydown:preventDefault="_preventKeyDown"
        @onblur="HandleBlur"></textarea>

    @if (_showSuggestions && _filteredMentions.Any())
    {
        <div class="absolute z-50 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto"
            style="bottom: 100%; left: 0; margin-bottom: 4px;">
            @foreach (var mention in _filteredMentions)
            {
                var isSelected = _selectedIndex == _filteredMentions.IndexOf(mention);
                <button type="button"
                    class="w-full px-3 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2 transition-colors @(isSelected ? "bg-blue-50 dark:bg-blue-900/20" : "")"
                    @onmousedown="() => SelectMention(mention)" @onmousedown:preventDefault>
                    @if (!string.IsNullOrEmpty(mention.Avatar))
                    {
                        <img src="@mention.Avatar" alt="@mention.Label" class="w-8 h-8 rounded-full object-cover" />
                    }
                    else
                    {
                        <div
                            class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 font-medium text-sm">
                            @mention.Label?.FirstOrDefault()
                        </div>
                    }
                    <div class="flex flex-col min-w-0">
                        <span class="font-medium text-gray-900 dark:text-white truncate">@mention.Label</span>
                        @if (!string.IsNullOrEmpty(mention.Description))
                        {
                            <span class="text-xs text-gray-500 dark:text-gray-400 truncate">@mention.Description</span>
                        }
                    </div>
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Bir şeyler yazın... @ ile bahsedin";
    [Parameter] public string Prefix { get; set; } = "@";
    [Parameter] public int Rows { get; set; } = 3;
    [Parameter] public bool IsDisabled { get; set; } = false;
    [Parameter] public List<BwMentionItem> Mentions { get; set; } = new();
    [Parameter] public EventCallback<BwMentionItem> OnMention { get; set; } = new();
    [Parameter] public BwSize Size { get; set; } = BwSize.Medium;
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public BwVariant Variant { get; set; } = BwVariant.Outline;

    [Parameter] public EventCallback<KeyboardEventArgs> OnKeyDown { get; set; }

    private ElementReference _textareaRef;
    private bool _showSuggestions = false;
    private bool _preventKeyDown = false;
    private string _searchQuery = "";
    private int _selectedIndex = 0;
    private int _mentionStartPos = -1;
    private List<BwMentionItem> _filteredMentions = new();

    private string _internalValue
    {
        get => Value;
        set
        {
            Value = value;
            ValueChanged.InvokeAsync(value);
            CheckForMentionTrigger(value);
        }
    }

    private void CheckForMentionTrigger(string text)
    {
        var lastAtIndex = text.LastIndexOf(Prefix);
        if (lastAtIndex >= 0)
        {
            var textAfterAt = text.Substring(lastAtIndex + 1);
            // Eğer @ sonrasında boşluk yoksa ve 20 karakterden kısaysa
            if (!textAfterAt.Contains(" ") && !textAfterAt.Contains("\n") && textAfterAt.Length <= 20)
            {
                _searchQuery = textAfterAt.ToLower();
                _mentionStartPos = lastAtIndex;
                _filteredMentions = Mentions
                .Where(m => string.IsNullOrEmpty(_searchQuery) ||
                m.Label?.ToLower().Contains(_searchQuery) == true ||
                m.Value?.ToLower().Contains(_searchQuery) == true)
                .Take(10)
                .ToList();
                _showSuggestions = _filteredMentions.Any();
                _selectedIndex = 0;
            }
            else
            {
                _showSuggestions = false;
            }
        }
        else
        {
            _showSuggestions = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        _preventKeyDown = false;

        if (_showSuggestions)
        {
            if (e.Key == "ArrowDown")
            {
                _selectedIndex = Math.Min(_selectedIndex + 1, _filteredMentions.Count - 1);
                _preventKeyDown = true;
                return;
            }
            else if (e.Key == "ArrowUp")
            {
                _selectedIndex = Math.Max(_selectedIndex - 1, 0);
                _preventKeyDown = true;
                return;
            }
            else if (e.Key == "Enter" || e.Key == "Tab")
            {
                if (_selectedIndex >= 0 && _selectedIndex < _filteredMentions.Count)
                {
                    await SelectMention(_filteredMentions[_selectedIndex]);
                    _preventKeyDown = true;
                    return;
                }
            }
            else if (e.Key == "Escape")
            {
                _showSuggestions = false;
                _preventKeyDown = true;
                return;
            }
        }
        
        // Bubble up normal keys
        await OnKeyDown.InvokeAsync(e);
    }

    private void HandleBlur()
    {
        // Delay hiding to allow click on suggestions
        _ = Task.Delay(150).ContinueWith(_ =>
        {
            _showSuggestions = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task SelectMention(BwMentionItem mention)
    {
        if (_mentionStartPos >= 0 && _mentionStartPos < Value.Length)
        {
            var before = Value.Substring(0, _mentionStartPos);
            var mentionText = $"{Prefix}{mention.Value ?? mention.Label} ";
            Value = before + mentionText;

            await ValueChanged.InvokeAsync(Value);
            await OnMention.InvokeAsync(mention);
        }

        _showSuggestions = false;
        _mentionStartPos = -1;
        StateHasChanged();
    }
}