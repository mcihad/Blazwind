@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Blazwind.Components.HelpTooltip
@inherits BwBaseInput<bool>

@{
    var sizeConfig = Size switch
    {
        BwSize.Small => ("bw-switch-track-small", "bw-switch-thumb-small"),
        BwSize.Large => ("bw-switch-track-large", "bw-switch-thumb-large"),
        _ => ("bw-switch-track-medium", "bw-switch-thumb-medium")
    };
    
    var trackSize = sizeConfig.Item1;
    var thumbSize = sizeConfig.Item2;
    
    var labelSizeClass = Size switch
    {
        BwSize.Small => "bw-label-small",
        BwSize.Large => "bw-label-large",
        _ => ""
    };
    
    var colorClass = Color switch
    {
        BwColor.Success => "bw-switch-success",
        BwColor.Danger => "bw-switch-danger",
        BwColor.Warning => "bw-switch-warning",
        BwColor.Info => "bw-switch-info",
        _ => ""
    };

    var errorClass = HasError ? "ring-2 ring-red-500/50" : "";
    var marginClass = GetDensityMarginClass();
}

<div class="@CombineClasses(marginClass)" style="@Style" id="@Id">
    <label class="inline-flex items-center gap-3 cursor-pointer @(IsDisabled ? "opacity-50 cursor-not-allowed" : "")">
        <button type="button"
                role="switch"
                aria-checked="@Value"
                disabled="@IsDisabled"
                class="bw-switch-track @trackSize @colorClass @(Value ? "checked" : "") @errorClass"
                @onclick="Toggle"
                @attributes="AdditionalAttributes">
            <span class="bw-switch-thumb @thumbSize"></span>
        </button>
        
        @if (HasLabel)
        {
            <span class="bw-label @labelSizeClass select-none">
                @Label
                @if (IsRequired)
                {
                    <span class="bw-required">*</span>
                }
            </span>
        }
        
        @if (ChildContent != null)
        {
            <span class="bw-label @labelSizeClass select-none">@ChildContent</span>
        }
        
        @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
        {
            <BwHelpTooltip Content="@HelperText" Size="BwSize.Small" />
        }
    </label>
    
    @* Error/Helper Messages *@
    @if (HasError)
    {
        <p class="bw-error-text">
            <i class="fa-solid fa-circle-exclamation"></i>
            @DisplayError
        </p>
    }
    else if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Inline)
    {
        <p class="bw-helper-text">@HelperText</p>
    }
</div>

@code {
    /// <summary>Color scheme for the switch</summary>
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    
    /// <summary>Custom content to display as label</summary>
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    /// <summary>Alias for Value - checked state</summary>
    [Parameter] 
    public bool IsChecked 
    { 
        get => Value; 
        set => Value = value; 
    }
    
    /// <summary>Callback when checked state changes</summary>
    [Parameter] public EventCallback<bool> IsCheckedChanged { get; set; }

    private async Task Toggle()
    {
        if (IsDisabled) return;
        
        Value = !Value;
        await ValueChanged.InvokeAsync(Value);
        await IsCheckedChanged.InvokeAsync(Value);
        await OnChange.InvokeAsync(Value);
        
        if (CascadedEditContext != null && For != null)
        {
            CascadedEditContext.NotifyFieldChanged(FieldIdentifier);
        }
    }
}
