@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Blazwind.Components.HelpTooltip
@inherits BwBaseInput<bool>

@{
    var sizeConfig = Size switch
    {
        BwSize.Small => ("w-8 h-4", "w-3 h-3", "translate-x-4", "translate-x-0.5"),
        BwSize.Large => ("w-14 h-7", "w-6 h-6", "translate-x-7", "translate-x-0.5"),
        _ => ("w-11 h-6", "w-5 h-5", "translate-x-5", "translate-x-0.5")
    };
    
    var trackSize = sizeConfig.Item1;
    var thumbSize = sizeConfig.Item2;
    var thumbOnPos = sizeConfig.Item3;
    var thumbOffPos = sizeConfig.Item4;
    
    var labelSizeClass = Size switch
    {
        BwSize.Small => "text-xs",
        BwSize.Large => "text-base",
        _ => "text-sm"
    };
    
    var activeColor = Color switch
    {
        BwColor.Success => "bg-emerald-500 hover:bg-emerald-600",
        BwColor.Danger => "bg-red-500 hover:bg-red-600",
        BwColor.Warning => "bg-amber-500 hover:bg-amber-600",
        BwColor.Info => "bg-sky-500 hover:bg-sky-600",
        BwColor.Secondary => "bg-gray-500 hover:bg-gray-600",
        _ => "bg-blue-600 hover:bg-blue-700"
    };
    
    var ringColor = Color switch
    {
        BwColor.Success => "focus:ring-emerald-500",
        BwColor.Danger => "focus:ring-red-500",
        BwColor.Warning => "focus:ring-amber-500",
        BwColor.Info => "focus:ring-sky-500",
        BwColor.Secondary => "focus:ring-gray-500",
        _ => "focus:ring-blue-500"
    };

    var trackColor = Value ? activeColor : "bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600";
    var thumbPos = Value ? thumbOnPos : thumbOffPos;
    
    // Error state
    var errorRingClass = HasError ? "ring-2 ring-red-500/50" : "";
    var marginClass = GetDensityMarginClass();
}

<div class="@CombineClasses(marginClass)" style="@Style" id="@Id">
    <label class="inline-flex items-center gap-3 cursor-pointer @(IsDisabled ? "opacity-50 cursor-not-allowed" : "")">
        <button type="button"
                role="switch"
                aria-checked="@Value"
                disabled="@IsDisabled"
                class="@trackSize relative inline-flex items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 @ringColor @trackColor @errorRingClass"
                @onclick="Toggle"
                @attributes="AdditionalAttributes">
            <span class="@thumbSize inline-block bg-white rounded-full shadow-sm transform transition-transform duration-200 @thumbPos"></span>
        </button>
        
        @if (HasLabel)
        {
            <span class="@labelSizeClass text-gray-700 dark:text-gray-300 select-none">
                @Label
                @if (IsRequired)
                {
                    <span class="text-red-500 ml-0.5">*</span>
                }
            </span>
        }
        
        @if (ChildContent != null)
        {
            <span class="@labelSizeClass text-gray-700 dark:text-gray-300 select-none">@ChildContent</span>
        }
        
        @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
        {
            <BwHelpTooltip Content="@HelperText" Size="BwSize.Small" />
        }
    </label>
    
    @* Error/Helper Messages *@
    @if (HasError)
    {
        <p class="mt-1 text-xs text-red-600 dark:text-red-400 flex items-center gap-1">
            <i class="fa-solid fa-circle-exclamation"></i>
            @DisplayError
        </p>
    }
    else if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Inline)
    {
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">@HelperText</p>
    }
</div>

@code {
    /// <summary>Color scheme for the switch</summary>
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    
    /// <summary>Custom content to display as label</summary>
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    /// <summary>Alias for Value - checked state</summary>
    [Parameter] 
    public bool IsChecked 
    { 
        get => Value; 
        set => Value = value; 
    }
    
    /// <summary>Callback when checked state changes</summary>
    [Parameter] public EventCallback<bool> IsCheckedChanged { get; set; }

    private async Task Toggle()
    {
        if (IsDisabled) return;
        
        Value = !Value;
        await ValueChanged.InvokeAsync(Value);
        await IsCheckedChanged.InvokeAsync(Value);
        await OnChange.InvokeAsync(Value);
        
        if (CascadedEditContext != null && For != null)
        {
            CascadedEditContext.NotifyFieldChanged(FieldIdentifier);
        }
    }
}
