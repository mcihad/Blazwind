@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@inherits BwBaseInput<double>

@{
    var sizeClass = Size switch
    {
        BwSize.Small => "text-lg gap-0.5",
        BwSize.Large => "text-3xl gap-1.5",
        _ => "text-2xl gap-1"
    };

    var (filledColor, emptyColor) = Color switch
    {
        BwColor.Warning => ("text-[var(--bw-color-warning)]", "text-[var(--bw-gray-300)]"),
        BwColor.Danger => ("text-[var(--bw-color-danger)]", "text-[var(--bw-gray-300)]"),
        BwColor.Success => ("text-[var(--bw-color-success)]", "text-[var(--bw-gray-300)]"),
        _ => ("text-[var(--bw-color-warning)]", "text-[var(--bw-gray-300)]")
    };
}

<div class="@CombineClasses(Class)" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="bw-label mb-1.5">@Label</label>
    }

    <div class="flex items-center @sizeClass @(IsReadOnly || IsDisabled ? "" : "cursor-pointer")">
        @for (var i = 1; i <= MaxValue; i++)
        {
            var starIndex = i;
            var isFilled = Value >= starIndex;
            var isHalf = AllowHalf && Value >= starIndex - 0.5 && Value < starIndex;

            <span class="relative transition-transform @(IsReadOnly || IsDisabled ? "" : "hover:scale-110")"
                  @onclick="() => OnStarClick(starIndex)"
                  @onmouseover="() => OnStarHover(starIndex)"
                  @onmouseout="OnMouseOut">
                @if (isHalf)
                {
                    @* Half star - empty background *@
                    <i class="@EmptyIcon @emptyColor"></i>
                    @* Half star - filled overlay *@
                    <span class="absolute inset-0 overflow-hidden" style="width: 50%;">
                        <i class="@FilledIcon @filledColor"></i>
                    </span>
                }
                else if (isFilled || (_hoverValue.HasValue && _hoverValue >= starIndex))
                {
                    <i class="@FilledIcon @filledColor"></i>
                }
                else
                {
                    <i class="@EmptyIcon @emptyColor"></i>
                }
            </span>
        }

        @if (ShowValue)
        {
            <span class="bw-label ml-2">@Value.ToString("0.#")</span>
        }
    </div>

    @if (!string.IsNullOrEmpty(HelperText))
    {
        <p class="bw-helper-text">@HelperText</p>
    }
</div>

@code {

    [CascadingParameter]
    private EditContext? CascadedEditContextLocal { get; set; }


    /// <summary>Maximum rating value (default: 5)</summary>
    [Parameter]
    public int MaxValue { get; set; } = 5;

    /// <summary>Allow half-star ratings</summary>
    [Parameter]
    public bool AllowHalf { get; set; }

    /// <summary>Display rating value next to stars</summary>
    [Parameter]
    public bool ShowValue { get; set; }

    /// <summary>Icon for filled star</summary>
    [Parameter]
    public string FilledIcon { get; set; } = "fa-solid fa-star";

    /// <summary>Icon for empty star</summary>
    [Parameter]
    public string EmptyIcon { get; set; } = "fa-regular fa-star";

    /// <summary>Color variant</summary>
    [Parameter]
    public BwColor Color { get; set; } = BwColor.Warning;


    private double? _hoverValue;
    private FieldIdentifier _fieldIdentifier;

    protected override void OnInitialized()
    {
        if (CascadedEditContext != null && For != null)
        {
            _fieldIdentifier = FieldIdentifier.Create(For);
        }
    }

    private async Task OnStarClick(int starIndex)
    {
        if (IsReadOnly || IsDisabled) return;

        var newValue = AllowHalf && Value == starIndex - 0.5 ? starIndex : starIndex - 0.5;
        if (!AllowHalf) newValue = starIndex;

        // Toggle off if clicking the same full value
        // if (Value == starIndex && !AllowHalf)
        // {
        //     newValue = 0;
        // }

        Value = Math.Max(0, Math.Min(MaxValue, newValue));
        await ValueChanged.InvokeAsync(Value);
    }

    private void OnStarHover(int starIndex)
    {
        if (IsReadOnly || IsDisabled) return;
        _hoverValue = starIndex;
    }

    private void OnMouseOut()
    {
        _hoverValue = null;
    }

}
