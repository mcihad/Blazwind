@namespace Blazwind.Components.Input
@using Blazwind.Components.HelpTooltip
@using Blazwind.Components.Shared
@inherits BwBaseInput<bool>

@{
    var sizeClass = Size switch
    {
        BwSize.Small => "bw-checkbox-small",
        BwSize.Large => "bw-checkbox-large",
        _ => "bw-checkbox-medium"
    };

    var iconSizeClass = Size switch
    {
        BwSize.Small => "text-[10px]",
        BwSize.Large => "text-base",
        _ => "text-xs"
    };

    var labelSizeClass = Size switch
    {
        BwSize.Small => "bw-label-small",
        BwSize.Large => "bw-label-large",
        _ => ""
    };

    var colorClass = Color switch
    {
        BwColor.Success => "bw-checkbox-success",
        BwColor.Danger => "bw-checkbox-danger",
        BwColor.Warning => "bw-checkbox-warning",
        BwColor.Info => "bw-checkbox-info",
        _ => ""
    };

    var errorClass = HasError ? "bw-input-error" : "";
    var marginClass = GetDensityMarginClass();
}

<div class="@CombineClasses(marginClass)" style="@Style" id="@Id">
    <div class="inline-flex items-center gap-2.5" @onclick="Toggle">
        <div
            class="bw-checkbox @sizeClass @colorClass @(Value ? "checked" : "") @(IsDisabled ? "bw-checkbox-disabled" : "") @errorClass"
            tabindex="@(IsDisabled ? -1 : 0)"
            @onkeydown="OnKeyDownHandler"
            @onclick:stopPropagation="true"
            @onclick="Toggle"
            @attributes="AdditionalAttributes">
            <i class="fa-solid fa-check bw-checkbox-icon @iconSizeClass"></i>
        </div>

        @if (HasLabel)
        {
            <span class="bw-label @labelSizeClass @(IsDisabled ? "opacity-60" : "") select-none">
                @Label
                @if (IsRequired)
                {
                    <span class="bw-required">*</span>
                }
            </span>
        }

        @if (ChildContent != null)
        {
            <span class="bw-label @labelSizeClass @(IsDisabled ? "opacity-60" : "") select-none">@ChildContent</span>
        }

        @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
        {
            <BwHelpTooltip Content="@HelperText" Size="BwSize.Small"/>
        }
    </div>

    @* Error/Helper Messages *@
    @if (HasError)
    {
        <p class="bw-error-text">
            <i class="fa-solid fa-circle-exclamation"></i>
            @DisplayError
        </p>
    }
    else if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Inline)
    {
        <p class="bw-helper-text">@HelperText</p>
    }
</div>

@code {

    /// <summary>Color scheme for the checkbox</summary>
    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    /// <summary>Custom content to display as label</summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>Alias for Value - checked state</summary>
    [Parameter]
    public bool IsChecked
    {
        get => Value;
        set => Value = value;
    }

    /// <summary>Callback when checked state changes</summary>
    [Parameter]
    public EventCallback<bool> IsCheckedChanged { get; set; }

    private async Task Toggle()
    {
        if (IsDisabled) return;

        Value = !Value;
        await ValueChanged.InvokeAsync(Value);
        await IsCheckedChanged.InvokeAsync(Value);
        await OnChange.InvokeAsync(Value);

        if (CascadedEditContext != null && For != null)
        {
            CascadedEditContext.NotifyFieldChanged(FieldIdentifier);
        }
    }

    private async Task OnKeyDownHandler(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            await Toggle();
        }

        await HandleKeyDown(e);
    }

}
