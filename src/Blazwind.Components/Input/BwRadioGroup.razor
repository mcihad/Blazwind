@namespace Blazwind.Components.Input
@inherits BwBaseInput<TValue>
@using Blazwind.Components.HelpTooltip
@using Blazwind.Components.Shared
@typeparam TValue where TValue : notnull

@{
    var hasError = !IsValid || !string.IsNullOrEmpty(ErrorMessage);
    var hasLabel = !string.IsNullOrEmpty(Label);
    var hasHelper = !string.IsNullOrEmpty(HelperText);

    var marginClass = EffectiveDensity switch
    {
        BwFormDensity.Compact => "mb-2",
        BwFormDensity.Relaxed => "mb-6",
        _ => "mb-4"
    };

    var labelSpacingClass = EffectiveDensity switch
    {
        BwFormDensity.Compact => "mb-0.5",
        BwFormDensity.Relaxed => "mb-2",
        _ => "mb-1.5"
    };
}

<div class="@CombineClasses(marginClass)" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (hasLabel)
    {
        <div class="flex items-center gap-1 @labelSpacingClass">
            <label class="bw-label">
                @Label
                @if (IsRequired)
                {
                    <span class="bw-required">*</span>
                }
            </label>
            @if (hasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
            {
                <BwHelpTooltip Content="@HelperText" Size="BwSize.Small"/>
            }
        </div>
    }

    <div class="@_orientationClass" role="radiogroup">
        <CascadingValue Value="this">
            @if (Items != null)
            {
                @foreach (var item in Items)
                {
                    <BwRadio TValue="TValue"
                             Value="@item.Value"
                             Label="@item.Text"
                             IsDisabled="@item.IsDisabled"/>
                }
            }
            @ChildContent
        </CascadingValue>
    </div>

    @* Error/Helper Messages *@
    @if (hasError)
    {
        <p class="bw-error-text">
            <i class="fa-solid fa-circle-exclamation"></i>
            @DisplayError
        </p>
    }
    else if (hasHelper && EffectiveHelpTextMode == BwHelpTextMode.Inline)
    {
        <p class="bw-helper-text">@HelperText</p>
    }
</div>

@code {


    #region Parameters

    [Parameter]
    public string Name { get; set; } = Guid.NewGuid().ToString();

    [Parameter]
    public BwOrientation Orientation { get; set; } = BwOrientation.Vertical;

    /// <summary>Data source for radio options</summary>
    [Parameter]
    public IEnumerable<BwSelectItem<TValue>>? Items { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    #endregion

    #region Private Fields

    #endregion

    #region Computed Properties

    private string _orientationClass => Orientation == BwOrientation.Horizontal
        ? "flex flex-row flex-wrap gap-4"
        : "flex flex-col gap-2";

    public string GroupName { get; private set; } = default!;

    #endregion

    #region Lifecycle

    protected override void OnInitialized()
    {
        base.OnInitialized();
        GroupName = Name ?? $"bw-radio-group-{Guid.NewGuid():N}";
    }

    #endregion

    #region Public Methods

    public async Task OnRadioChange(TValue selectedValue)
    {
        if (!EqualityComparer<TValue>.Default.Equals(Value, selectedValue))
        {
            Value = selectedValue;
            await ValueChanged.InvokeAsync(selectedValue);
            await OnChange.InvokeAsync(selectedValue);
            StateHasChanged();

            if (CascadedEditContext != null && For != null)
            {
                CascadedEditContext.NotifyFieldChanged(FieldIdentifier);
            }
        }
    }

    #endregion


}
