@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inherits BwBaseInput<string>

@{
    var hasError = !string.IsNullOrEmpty(ErrorMessage);
    var hasLabel = !string.IsNullOrEmpty(Label);
    var hasHelper = !string.IsNullOrEmpty(HelperText);
    var hasPrefixIcon = !string.IsNullOrEmpty(PrefixIcon);
    var hasSuffixIcon = !string.IsNullOrEmpty(SuffixIcon);
    var actualType = _showPassword ? "text" : Type;

    var sizeClass = Size switch
    {
        BwSize.Small => "bw-input-small",
        BwSize.Large => "bw-input-large",
        _ => "bw-input-medium"
    };

    var iconSize = Size switch
    {
        BwSize.Small => "text-xs",
        BwSize.Large => "text-lg",
        _ => "text-sm"
    };

    // Padding is handled by checking icons, might need custom padding class or just rely on layout
    var inputPadding = Size switch
    {
        BwSize.Small => hasPrefixIcon ? "pl-7 pr-7" : "px-2.5", // pr-7 for potential suffix icon
        BwSize.Large => hasPrefixIcon ? "pl-11 pr-10" : "px-4",
        _ => hasPrefixIcon ? "pl-9 pr-9" : "px-3"
    };

    var baseClass = "bw-input w-full"; // The group handles the border, but input needs reset

    // State classes for the GROUP container
    var groupStateClass = "";
    if (hasError) groupStateClass += " bw-input-error";
    if (IsDisabled) groupStateClass += " bw-input-disabled";

    var stateClass = hasError
        ? "text-[var(--bw-color-danger)]"
        : "text-[var(--bw-color-text)] placeholder-[var(--bw-input-placeholder)]";
}

<div class="@CombineClasses(Class)" style="@Style" id="@Id">
    @if (hasLabel)
    {
        <label
            class="bw-label mb-1.5 @(Size == BwSize.Small ? "bw-label-small" : Size == BwSize.Large ? "bw-label-large" : "")">
            @Label
            @if (IsRequired)
            {
                <span class="bw-required">*</span>
            }
        </label>
    }

    <div class="bw-input-group @sizeClass @groupStateClass">
        @* Prepend Content (Custom) *@
        @if (PrependContent != null)
        {
            <div class="bw-input-group-text">
                @PrependContent
            </div>
        }

        @* Input Field with Optional Prefix/Suffix Icons *@
        <div class="flex-1 relative flex items-center">
            @if (hasPrefixIcon)
            {
                <span class="bw-input-icon bw-input-icon-left @iconSize">
                    <i class="@PrefixIcon"></i>
                </span>
            }

            <input type="@actualType" @ref="_inputRef"
                   class="bw-input @inputPadding @stateClass @(IsDisabled ? "cursor-not-allowed" : "")"
                   style="outline: none !important; box-shadow: none !important;" placeholder="@Placeholder"
                   value="@Value"
                   disabled="@IsDisabled" readonly="@IsReadOnly" @oninput="OnInput" @onclick="OnInputClick"
                   @onclick:stopPropagation="true" @onkeydown="HandleKeyDown" @attributes="AdditionalAttributes"/>

            @* Suffix buttons inside input area *@
            <div class="absolute right-2 flex items-center gap-1">
                @if (_isLoading)
                {
                    <span class="text-(--bw-color-primary) @iconSize">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                    </span>
                }
                else
                {
                    @if (ShowClear && !string.IsNullOrEmpty(Value) && !IsDisabled && !IsReadOnly)
                    {
                        <button type="button"
                                class="p-1 text-(--bw-color-text-muted) hover:text-(--bw-color-text) focus:outline-none @iconSize"
                                @onclick="ClearValue" @onclick:stopPropagation="true">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    }

                    @if (Type == "password" && ShowPasswordToggle)
                    {
                        <button type="button"
                                class="p-1 text-(--bw-color-text-muted) hover:text-(--bw-color-text) focus:outline-none @iconSize"
                                @onclick="TogglePassword" @onclick:stopPropagation="true">
                            <i class="@(_showPassword ? "fa-solid fa-eye-slash" : "fa-solid fa-eye")"></i>
                        </button>
                    }

                    @if (ShowCopy && !string.IsNullOrEmpty(Value))
                    {
                        <button type="button"
                                class="p-1 text-(--bw-color-text-muted) hover:text-(--bw-color-text) focus:outline-none @iconSize"
                                @onclick="CopyToClipboard" @onclick:stopPropagation="true" title="Kopyala">
                            <i class="@(_copied ? "fa-solid fa-check text-(--bw-color-success)" : "fa-solid fa-copy")"></i>
                        </button>
                    }

                    @if (hasSuffixIcon && Buttons == null && AppendContent == null && !ShowCopy && !(Type == "password" &&
                                                                                                     ShowPasswordToggle))
                    {
                        <span class="text-(--bw-color-text-muted) @iconSize pointer-events-none">
                            <i class="@SuffixIcon"></i>
                        </span>
                    }
                }
            </div>
        </div>

        @* Buttons (Shorthand for common button patterns) *@
        @if (Buttons != null)
        {
            <div class="flex items-center">
                @Buttons
            </div>
        }

        @* Append Content (Custom) *@
        @if (AppendContent != null)
        {
            <div class="bw-input-group-text">
                @AppendContent
            </div>
        }
    </div>

    @if (hasError)
    {
        <p class="bw-error-text">
            <i class="fa-solid fa-circle-exclamation"></i>
            @ErrorMessage
        </p>
    }
    else if (hasHelper)
    {
        <p class="bw-helper-text">@HelperText</p>
    }
</div>

@code {

    [Parameter]
    public bool IsLoading { get; set; }

    /// <summary>Input type (text, password, etc.)</summary>
    [Parameter]
    public string Type { get; set; } = "text";


    /// <summary>Prefix icon class (e.g., "fa-solid fa-search")</summary>
    [Parameter]
    public string? PrefixIcon { get; set; }

    /// <summary>Suffix icon class (e.g., "fa-solid fa-check")</summary>
    [Parameter]
    public string? SuffixIcon { get; set; }

    /// <summary>Show clear button when value is not empty</summary>
    [Parameter]
    public bool ShowClear { get; set; }

    /// <summary>Show password toggle button (for password type)</summary>
    [Parameter]
    public bool ShowPasswordToggle { get; set; } = true;

    /// <summary>Show copy to clipboard button</summary>
    [Parameter]
    public bool ShowCopy { get; set; }

    /// <summary>Custom prepend content (left side, with border)</summary>
    [Parameter]
    public RenderFragment? PrependContent { get; set; }

    /// <summary>Custom append content (right side, with border)</summary>
    [Parameter]
    public RenderFragment? AppendContent { get; set; }

    /// <summary>Buttons to append (no border, direct inline)</summary>
    [Parameter]
    public RenderFragment? Buttons { get; set; }


    [Parameter]
    public EventCallback OnEnterPressed { get; set; }

    [Parameter]
    public EventCallback OnClear { get; set; }


    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private ElementReference _inputRef;
    private bool _showPassword;
    private bool _copied;
    private bool _isLoading;
    private FieldIdentifier _fieldIdentifier;

    protected override void OnInitialized()
    {
        if (CascadedEditContext != null && For != null)
        {
            _fieldIdentifier = FieldIdentifier.Create(For);
        }
    }

    protected override void OnParametersSet()
    {
        _isLoading = IsLoading;
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);
    }

    private async Task OnInputClick(MouseEventArgs e)
    {
        await OnClick.InvokeAsync(e);
    }

    protected override async Task HandleKeyDown(KeyboardEventArgs e)
    {
        await base.HandleKeyDown(e);
        if (e.Key == "Enter" && OnEnterPressed.HasDelegate)
        {
            await OnEnterPressed.InvokeAsync();
        }
    }

    private void TogglePassword()
    {
        _showPassword = !_showPassword;
    }

    private async Task ClearValue()
    {
        Value = "";
        await ValueChanged.InvokeAsync(Value);
        if (OnClear.HasDelegate)
        {
            await OnClear.InvokeAsync();
        }

        await _inputRef.FocusAsync();
    }

    private async Task CopyToClipboard()
    {
        if (!string.IsNullOrEmpty(Value))
        {
            try
            {
                await JS.InvokeVoidAsync("navigator.clipboard.writeText", Value);
                _copied = true;
                StateHasChanged();

                await Task.Delay(2000);
                _copied = false;
                StateHasChanged();
            }
            catch
            {
                // Clipboard API not available
            }
        }
    }

    /// <summary>Focus the input programmatically</summary>
    public async Task FocusAsync()
    {
        await _inputRef.FocusAsync();
    }

    /// <summary>Select all text in the input</summary>
    public async Task SelectAsync()
    {
        await JS.InvokeVoidAsync("eval", "document.activeElement?.select?.()");
    }

}