@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Blazwind.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@inherits BwBaseInput<List<IBrowserFile>>

@{
    var hasLabel = !string.IsNullOrEmpty(Label);
    var hasFiles = Files.Count > 0;
}

<div class="@CombineClasses(Class)" style="@Style" id="@Id" @attributes="AdditionalAttributes">
    @if (hasLabel)
    {
        <label class="block text-sm font-medium text-gray-700 mb-1.5">@Label</label>
    }
    
    @* Drop Zone *@
    <div class="border-2 border-dashed rounded-lg p-6 text-center transition-colors
        @(_isDragging ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20" : "border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-800/50")
        @(IsDisabled ? "opacity-60 cursor-not-allowed" : "cursor-pointer")"
         @ondragenter="OnDragEnter"
         @ondragover="OnDragOver"
         @ondragleave="OnDragLeave"
         @ondrop="OnDrop"
         @onclick="TriggerFileInput">
        
        <div class="flex flex-col items-center justify-center py-8 px-4 text-center">
            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mb-3">
                <i class="fa-solid fa-cloud-arrow-up text-blue-600 text-xl"></i>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                <span class="font-semibold text-blue-600 dark:text-blue-400">Select file</span> or drag here
            </p>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-500">
                @if (!string.IsNullOrEmpty(Accept))
                {
                    <span>@Accept</span>
                }
                @if (MaxFileSize.HasValue)
                {
                    <span> â€¢ Max. @FormatFileSize(MaxFileSize.Value)</span>
                }
            </p>
        </div>
        
        <InputFile @ref="_inputFile"
                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                   OnChange="OnFilesSelected"
                   accept="@Accept"
                   multiple="@Multiple"
                   disabled="@IsDisabled" />
    </div>
    
    @* File List *@
    @if (ShowPreview && hasFiles)
    {
        <div class="mt-3 space-y-2">
            @foreach (var file in Files)
            {
                var fileInfo = file;
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-3 overflow-hidden">
                    <div class="flex-shrink-0">
                        @if (IsImageFile(file.Name))
                        {
                            <i class="fa-solid fa-image text-blue-500 text-xl"></i>
                        }
                        else if (IsPdfFile(file.Name))
                        {
                            <i class="fa-solid fa-file-pdf text-red-500 text-xl"></i>
                        }
                        else
                        {
                            <i class="fa-solid fa-file text-gray-400 dark:text-gray-500 text-xl"></i>
                        }
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate">
                            @file.Name
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            @FormatFileSize(file.Size)
                        </p>
                    </div>
                </div>    @* Remove button *@
                    <button type="button"
                            class="text-gray-400 hover:text-red-500 transition-colors p-1"
                            @onclick="() => RemoveFile(fileInfo)"
                            @onclick:stopPropagation="true">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            }
        </div>
    }
    
    @if (!string.IsNullOrEmpty(HelperText))
    {
        <p class="mt-1.5 text-xs text-gray-500">@HelperText</p>
    }
    
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1.5 text-xs text-red-600 flex items-center gap-1">
            <i class="fa-solid fa-circle-exclamation"></i>
            @ErrorMessage
        </p>
    }
</div>

@code {
    /// <summary>Selected files</summary>
    [Parameter] public List<IBrowserFile> Files 
    { 
        get => Value ?? new List<IBrowserFile>(); 
        set => Value = value;
    }
    
    [Parameter] public EventCallback<List<IBrowserFile>> FilesChanged { get; set; }
    
    /// <summary>Accepted file types (e.g., ".jpg,.png,.pdf")</summary>
    [Parameter] public string? Accept { get; set; }
    
    /// <summary>Maximum file size in bytes</summary>
    [Parameter] public long? MaxFileSize { get; set; }
    
    /// <summary>Maximum number of files</summary>
    [Parameter] public int? MaxFiles { get; set; }
    
    /// <summary>Allow multiple files</summary>
    [Parameter] public bool Multiple { get; set; } = true;
    
    /// <summary>Show file preview list</summary>
    [Parameter] public bool ShowPreview { get; set; } = true;
    

    
    [Parameter] public EventCallback<IReadOnlyList<IBrowserFile>> OnFileSelected { get; set; }

    private InputFile? _inputFile;
    private bool _isDragging;

    private void TriggerFileInput()
    {
        // Native click handled by InputFile overlay
    }

    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        var selectedFiles = e.GetMultipleFiles(MaxFiles ?? 10).ToList();
        
        foreach (var file in selectedFiles)
        {
            if (MaxFileSize.HasValue && file.Size > MaxFileSize.Value) continue;
            if (!Multiple && Files.Count > 0) Files.Clear();
            if (MaxFiles.HasValue && Files.Count >= MaxFiles) break;
            
            Files.Add(file);
        }
        
        await FilesChanged.InvokeAsync(Files);
        await ValueChanged.InvokeAsync(Files);
        await OnFileSelected.InvokeAsync(selectedFiles);
    }

    private async Task RemoveFile(IBrowserFile file)
    {
        Files.Remove(file);
        await FilesChanged.InvokeAsync(Files);
        await ValueChanged.InvokeAsync(Files);
    }

    private void OnDragEnter(DragEventArgs e) => _isDragging = true;
    private void OnDragOver(DragEventArgs e) => e.DataTransfer.DropEffect = "copy";
    private void OnDragLeave(DragEventArgs e) => _isDragging = false;
    private void OnDrop(DragEventArgs e) => _isDragging = false;

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:0.#} KB";
        return $"{bytes / (1024.0 * 1024):0.#} MB";
    }

    private bool IsImageFile(string name) => 
        name.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) ||
        name.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase) ||
        name.EndsWith(".png", StringComparison.OrdinalIgnoreCase) ||
        name.EndsWith(".gif", StringComparison.OrdinalIgnoreCase) ||
        name.EndsWith(".webp", StringComparison.OrdinalIgnoreCase);

    private bool IsPdfFile(string name) => 
        name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase);
}
