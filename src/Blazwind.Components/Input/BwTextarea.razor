@namespace Blazwind.Components.Input
@using Blazwind.Components.HelpTooltip
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inherits BwBaseInput<string>
@inject IJSRuntime JS

@{
    var marginClass = GetDensityMarginClass();
    var labelSpacingClass = GetLabelSpacingClass();
    var showCounter = ShowCounter && MaxLength.HasValue;
    var currentLength = Value?.Length ?? 0;

    var baseClass = "bw-input resize-none";
    var stateClass = GetStateClass();
    var disabledClass = GetDisabledClass();
    var paddingClass = "p-3 text-sm";
}

<div class="@CombineClasses(marginClass)" style="@Style" id="@Id">
    @switch (EffectiveLabelPosition)
    {
        case BwLabelPosition.Top:
            @if (HasLabel)
            {
                <div class="flex items-center gap-1 @labelSpacingClass">
                    <label class="bw-label">
                        @Label
                        @if (IsRequired)
                        {
                            <span class="bw-required">*</span>
                        }
                    </label>
                    @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
                    {
                        <BwHelpTooltip Content="@HelperText" Size="BwSize.Small"/>
                    }
                </div>
            }

            <div class="relative">
                <textarea @ref="_textareaRef"
                          class="@baseClass @stateClass @disabledClass @paddingClass"
                          placeholder="@Placeholder"
                          disabled="@IsDisabled"
                          readonly="@IsReadOnly"
                          rows="@Rows"
                          maxlength="@MaxLength"
                          style="@GetStyleString()"
                          @oninput="HandleInputEvent"
                          @onfocus="HandleFocusEvent"
                          @onblur="HandleBlurEvent"
                          @onkeydown="HandleKeyDownEvent"
                          @onkeydown="HandleKeyDownEvent"
                          @onkeyup="HandleKeyUpEvent"
                          @attributes="AdditionalAttributes">@Value</textarea>
            </div>
            break;

        case BwLabelPosition.Left:
            <div class="flex items-start gap-3">
                @if (HasLabel)
                {
                    <div class="flex items-center gap-1 pt-3 flex-shrink-0"
                         style="width: @LabelWidth; min-width: @LabelWidth;">
                        <label class="bw-label text-right flex-1">
                            @Label
                            @if (IsRequired)
                            {
                                <span class="bw-required">*</span>
                            }
                        </label>
                        @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
                        {
                            <BwHelpTooltip Content="@HelperText" Size="BwSize.Small"/>
                        }
                    </div>
                }
                <div class="flex-1 relative">
                    <textarea @ref="_textareaRef"
                              class="@baseClass @stateClass @disabledClass @paddingClass"
                              placeholder="@Placeholder"
                              disabled="@IsDisabled"
                              readonly="@IsReadOnly"
                              rows="@Rows"
                              maxlength="@MaxLength"
                              style="@GetStyleString()"
                              @oninput="HandleInputEvent"
                              @onfocus="HandleFocusEvent"
                              @onblur="HandleBlurEvent"
                              @onkeydown="HandleKeyDownEvent"
                              @onkeyup="HandleKeyUpEvent">@Value</textarea>
                </div>
            </div>
            break;

        case BwLabelPosition.Hidden:
        default:
            <div class="relative">
                <textarea @ref="_textareaRef"
                          class="@baseClass @stateClass @disabledClass @paddingClass"
                          placeholder="@Placeholder"
                          disabled="@IsDisabled"
                          readonly="@IsReadOnly"
                          rows="@Rows"
                          maxlength="@MaxLength"
                          style="@GetStyleString()"
                          @oninput="HandleInputEvent"
                          @onfocus="HandleFocusEvent"
                          @onblur="HandleBlurEvent"
                          @onkeydown="HandleKeyDownEvent"
                          @onkeyup="HandleKeyUpEvent">@Value</textarea>
            </div>
            break;
    }

    <div class="flex justify-between items-center mt-1">
        @if (HasError)
        {
            <p class="bw-error-text">
                <i class="fa-solid fa-circle-exclamation"></i>
                @DisplayError
            </p>
        }
        else if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Inline)
        {
            <p class="bw-helper-text">@HelperText</p>
        }
        else
        {
            <span></span>
        }

        @if (showCounter)
        {
            <span class="text-xs @(currentLength >= MaxLength ? "text-red-500 font-medium" : "text-gray-400")">
                @currentLength / @MaxLength
            </span>
        }
    </div>
</div>

@code {

    /// <summary>Number of visible rows</summary>
    [Parameter]
    public int Rows { get; set; } = 3;

    /// <summary>Minimum rows when auto-resizing</summary>
    [Parameter]
    public int MinRows { get; set; } = 2;

    /// <summary>Maximum rows when auto-resizing</summary>
    [Parameter]
    public int MaxRows { get; set; } = 10;

    /// <summary>Maximum character count</summary>
    [Parameter]
    public int? MaxLength { get; set; }

    /// <summary>Show character counter</summary>
    [Parameter]
    public bool ShowCounter { get; set; } = true;

    /// <summary>Auto-resize based on content</summary>
    [Parameter]
    public bool AutoResize { get; set; }

    /// <summary>Input event for real-time updates</summary>
    [Parameter]
    public EventCallback<ChangeEventArgs> OnInput { get; set; }

    private ElementReference _textareaRef;
    private readonly int _lineHeight = 24;

    private string GetStyleString()
    {
        if (!AutoResize) return "";

        var minHeight = MinRows * _lineHeight + 24;
        var maxHeight = MaxRows * _lineHeight + 24;
        return $"min-height: {minHeight}px; max-height: {maxHeight}px; overflow-y: auto;";
    }

    private async Task HandleInputEvent(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);
        await OnInput.InvokeAsync(e);
        await OnChange.InvokeAsync(Value);

        if (CascadedEditContext != null && For != null)
        {
            CascadedEditContext.NotifyFieldChanged(FieldIdentifier);
        }

        if (AutoResize)
        {
            await AdjustHeight();
        }
    }

    private async Task HandleFocusEvent(FocusEventArgs e)
    {
        IsFocused = true;
        await HandleFocus(e);
    }

    private async Task HandleBlurEvent(FocusEventArgs e)
    {
        IsFocused = false;
        await HandleBlur(e);
    }

    private async Task HandleKeyDownEvent(KeyboardEventArgs e)
    {
        await HandleKeyDown(e);
    }

    private async Task HandleKeyUpEvent(KeyboardEventArgs e)
    {
        await HandleKeyUp(e);
    }

    private async Task AdjustHeight()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var el = document.querySelector('[_bl_{_textareaRef.Id}]') || document.activeElement;
                    if (el && el.tagName === 'TEXTAREA') {{
                        el.style.height = 'auto';
                        el.style.height = Math.min(el.scrollHeight, {MaxRows * _lineHeight + 24}) + 'px';
                    }}
                }})()
            ");
        }
        catch
        {
            // JS not available
        }
    }

}
