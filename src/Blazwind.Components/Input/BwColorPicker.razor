@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Blazwind.Components.HelpTooltip
@inherits BwBaseInput<string>

@{
    var marginClass = GetDensityMarginClass();
    var labelSpacingClass = GetLabelSpacingClass();
    var previewStyle = $"background-color: {Value};";
}

<div class="@CombineClasses(marginClass)" style="@Style" id="@Id">
    @if (HasLabel)
    {
        <div class="flex items-center gap-1 @labelSpacingClass">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                @Label
                @if (IsRequired)
                {
                    <span class="text-red-500 ml-0.5">*</span>
                }
            </label>
            @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
            {
                <BwHelpTooltip Content="@HelperText" Size="BwSize.Small" />
            }
        </div>
    }
    
    <div class="flex items-center gap-3">
        @* Color Preview & Native Picker *@
        <div class="relative">
            <div class="w-10 h-10 rounded border @(HasError ? "border-red-500" : "border-gray-300 dark:border-gray-600") shadow-inner cursor-pointer overflow-hidden"
                 style="@previewStyle">
                <input type="color"
                       class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                       value="@Value"
                       disabled="@IsDisabled"
                       @onchange="HandleColorChange"
                       @onfocus="HandleFocusEvent"
                       @onblur="HandleBlurEvent"
                       @attributes="AdditionalAttributes" />
            </div>
        </div>
        
        @* HEX Input *@
        @if (ShowInput)
        {
            <div class="flex items-center gap-1">
                <span class="text-gray-400 dark:text-gray-500 text-sm">#</span>
                <input type="text" 
                       class="w-20 h-10 px-2 text-sm border @(HasError ? "border-red-500" : "border-gray-300 dark:border-gray-600") rounded focus:outline-none focus:border-blue-500 dark:focus:border-blue-400 focus:ring-2 focus:ring-blue-500/20 dark:focus:ring-blue-400/30 uppercase bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                       value="@((Value ?? "").TrimStart('#'))" 
                       @onchange="HandleHexInputChange"
                       maxlength="6"
                       disabled="@IsDisabled" />
            </div>
        }
    </div>
    
    @* Preset Colors *@
    @if (PresetColors != null && PresetColors.Length > 0)
    {
        <div class="flex flex-wrap gap-2 mt-3">
            @foreach (var color in PresetColors)
            {
                var colorValue = color;
                var isSelected = (Value ?? "").Equals(color, StringComparison.OrdinalIgnoreCase);
                <button type="button"
                        class="w-6 h-6 rounded border-2 transition-transform hover:scale-110 @(isSelected ? "border-blue-500 ring-2 ring-blue-500/30" : "border-gray-200 dark:border-gray-600")"
                        style="background-color: @color;"
                        disabled="@IsDisabled"
                        @onclick="() => SelectPreset(colorValue)">
                </button>
            }
        </div>
    }
    
    @* Error/Helper Messages *@
    @if (HasError)
    {
        <p class="mt-1 text-xs text-red-600 dark:text-red-400 flex items-center gap-1">
            <i class="fa-solid fa-circle-exclamation"></i>
            @DisplayError
        </p>
    }
    else if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Inline)
    {
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">@HelperText</p>
    }
</div>

@code {
    /// <summary>Show manual HEX input</summary>
    [Parameter] public bool ShowInput { get; set; } = true;
    
    /// <summary>Preset color palette</summary>
    [Parameter] public string[]? PresetColors { get; set; } = new[]
    {
        "#EF4444", "#F97316", "#F59E0B", "#EAB308", "#84CC16",
        "#22C55E", "#10B981", "#14B8A6", "#06B6D4", "#0EA5E9",
        "#3B82F6", "#6366F1", "#8B5CF6", "#A855F7", "#D946EF",
        "#EC4899", "#F43F5E", "#000000", "#6B7280", "#FFFFFF"
    };

    protected override void OnInitialized()
    {
        base.OnInitialized();
        if (string.IsNullOrEmpty(Value))
        {
            Value = "#3B82F6";
        }
    }

    private async Task HandleColorChange(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? "#000000";
        await ValueChanged.InvokeAsync(Value);
        await OnChange.InvokeAsync(Value);
    }

    private async Task HandleHexInputChange(ChangeEventArgs e)
    {
        var hex = e.Value?.ToString() ?? "";
        if (hex.Length == 6 && IsValidHex(hex))
        {
            Value = $"#{hex}";
            await ValueChanged.InvokeAsync(Value);
            await OnChange.InvokeAsync(Value);
        }
    }

    private async Task SelectPreset(string color)
    {
        if (IsDisabled) return;
        Value = color;
        await ValueChanged.InvokeAsync(Value);
        await OnChange.InvokeAsync(Value);
    }

    private bool IsValidHex(string hex)
    {
        return System.Text.RegularExpressions.Regex.IsMatch(hex, "^[0-9A-Fa-f]{6}$");
    }
    
    private async Task HandleFocusEvent(FocusEventArgs e)
    {
        IsFocused = true;
        await HandleFocus(e);
    }

    private async Task HandleBlurEvent(FocusEventArgs e)
    {
        IsFocused = false;
        await HandleBlur(e);
    }
}
