@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Blazwind.Components.HelpTooltip
@using System.Globalization
@inherits BwBaseInput<TimeSpan?>

@{
    var sizeClass = GetSizeClass();
    var baseClass = GetBaseInputClass();
    var stateClass = GetStateClass();
    var disabledClass = GetDisabledClass();
    var marginClass = GetDensityMarginClass();
    var labelSpacingClass = GetLabelSpacingClass();
}

<div class="@CombineClasses(marginClass)" style="@Style" id="@Id">
    @switch (EffectiveLabelPosition)
    {
        case BwLabelPosition.Top:
            @if (HasLabel)
            {
                <div class="flex items-center gap-1 @labelSpacingClass">
                    <label class="bw-label">
                        @Label
                        @if (IsRequired)
                        {
                            <span class="bw-required">*</span>
                        }
                    </label>
                    @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
                    {
                        <BwHelpTooltip Content="@HelperText" Size="BwSize.Small" />
                    }
                </div>
            }
            <input type="time"
                   class="@baseClass @sizeClass @stateClass @disabledClass"
                   value="@(Value?.ToString(@"hh\:mm"))"
                   disabled="@IsDisabled"
                   readonly="@IsReadOnly"
                   @onchange="HandleTimeChange"
                   @onfocus="HandleFocusEvent"
                   @onblur="HandleBlurEvent"
                   @attributes="AdditionalAttributes" />
            break;
            
        case BwLabelPosition.Left:
            <div class="flex items-start gap-3">
                @if (HasLabel)
                {
                    <div class="flex items-center gap-1 pt-2.5 flex-shrink-0" style="width: @LabelWidth; min-width: @LabelWidth;">
                        <label class="bw-label text-right flex-1">
                            @Label
                            @if (IsRequired)
                            {
                                <span class="bw-required">*</span>
                            }
                        </label>
                        @if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Popup)
                        {
                            <BwHelpTooltip Content="@HelperText" Size="BwSize.Small" />
                        }
                    </div>
                }
                <div class="flex-1">
                    <input type="time"
                           class="@baseClass @sizeClass @stateClass @disabledClass"
                           value="@(Value?.ToString(@"hh\:mm"))"
                           disabled="@IsDisabled"
                           readonly="@IsReadOnly"
                           @onchange="HandleTimeChange"
                           @onfocus="HandleFocusEvent"
                           @onblur="HandleBlurEvent" />
                </div>
            </div>
            break;
            
        default:
            <input type="time"
                   class="@baseClass @sizeClass @stateClass @disabledClass"
                   value="@(Value?.ToString(@"hh\:mm"))"
                   disabled="@IsDisabled"
                   readonly="@IsReadOnly"
                   @onchange="HandleTimeChange"
                   @onfocus="HandleFocusEvent"
                   @onblur="HandleBlurEvent" />
            break;
    }
    
    @* Error/Helper Messages *@
    @if (HasError)
    {
        <p class="bw-error-text">
            <i class="fa-solid fa-circle-exclamation"></i>
            @DisplayError
        </p>
    }
    else if (HasHelper && EffectiveHelpTextMode == BwHelpTextMode.Inline)
    {
        <p class="bw-helper-text">@HelperText</p>
    }
</div>

@code {
    /// <summary>Culture for time formatting (default: Turkish)</summary>
    [Parameter] public CultureInfo Culture { get; set; } = new CultureInfo("tr-TR");
    
    /// <summary>Time format (24h default for Turkey)</summary>
    [Parameter] public string Format { get; set; } = "HH:mm";

    private async Task HandleTimeChange(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e.Value?.ToString(), out var time))
        {
            Value = time;
        }
        else
        {
            Value = null;
        }
        
        await ValueChanged.InvokeAsync(Value);
        await OnChange.InvokeAsync(Value);
        
        if (CascadedEditContext != null && For != null)
        {
            CascadedEditContext.NotifyFieldChanged(FieldIdentifier);
        }
    }
    
    private async Task HandleFocusEvent(FocusEventArgs e)
    {
        IsFocused = true;
        await HandleFocus(e);
    }

    private async Task HandleBlurEvent(FocusEventArgs e)
    {
        IsFocused = false;
        await HandleBlur(e);
    }
}
