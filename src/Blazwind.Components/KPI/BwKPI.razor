@namespace Blazwind.Components.KPI
@using Blazwind.Components.Shared
@inherits BwBase

<div class="@CombineClasses($"bw-kpi-card {Class}")" style="@Style" id="@Id" @attributes="AdditionalAttributes"
     @onclick="HandleClick">
    <div class="px-4 py-4">
        <div class="flex items-start justify-between">
            <div>
                <p class="bw-kpi-title">@Title</p>
                <h3 class="bw-kpi-value">
                    @if (!string.IsNullOrEmpty(ValuePrefix))
                    {
                        <span class="text-sm opacity-60 mr-0.5 align-top">@ValuePrefix</span>
                    }
                    @Value
                    @if (!string.IsNullOrEmpty(ValueSuffix))
                    {
                        <span class="text-sm opacity-60 ml-0.5 align-baseline">@ValueSuffix</span>
                    }
                </h3>
            </div>
            @if (!string.IsNullOrEmpty(Icon))
            {
                <div class="@($"bw-kpi-icon-wrapper {GetIconColorClass()}")">
                    <i class="@Icon fa-lg"></i>
                </div>
            }
        </div>

        @if (ShowTrend)
        {
            <div class="mt-4 flex items-center justify-between">
                <div class="@($"bw-kpi-trend {GetTrendColorClass()}")">
                    <i class="@GetTrendIcon() text-xs"></i>
                    <span>@TrendValue</span>
                </div>
                @if (!string.IsNullOrEmpty(TrendDescription))
                {
                    <span class="text-xs text-gray-400 dark:text-gray-500">@TrendDescription</span>
                }
            </div>
        }
        @if (ShowProgress)
        {
            <div class="bw-kpi-progress-bg">
                <div class="@($"bw-kpi-progress-bar {GetProgressColorClass()}")"
                     style="width: @(ProgressValue ?? 0)%"></div>
            </div>
        }

        @* Footer *@
        @if (ChildContent != null)
        {
            <div class="px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700">
                @ChildContent
            </div>
        }
    </div>
</div>

@code {

    [Parameter]
    public string Title { get; set; } = "KPI";

    [Parameter]
    public string? Subtitle { get; set; }

    [Parameter]
    public double Value { get; set; }

    [Parameter]
    public string? ValuePrefix { get; set; }

    [Parameter]
    public string? ValueSuffix { get; set; }

    [Parameter]
    public string? Icon { get; set; }

    [Parameter]
    public BwColor Color { get; set; } = BwColor.Primary;

    [Parameter]
    public BwSize Size { get; set; } = BwSize.Medium;

    [Parameter]
    public KpiFormat Format { get; set; } = KpiFormat.Number;

    [Parameter]
    public bool ShowTrend { get; set; } = true;

    [Parameter]
    public double? TrendValue { get; set; }

    [Parameter]
    public string? TrendDescription { get; set; } = "geçen aya göre";

    [Parameter]
    public bool TrendPositiveIsGood { get; set; } = true;

    [Parameter]
    public bool ShowProgress { get; set; }

    [Parameter]
    public double? ProgressValue { get; set; }

    [Parameter]
    public bool Clickable { get; set; }

    [Parameter]
    public EventCallback OnClick { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private string GetTrendIcon()
    {
        return TrendValue switch
        {
            > 0 => "fa-solid fa-arrow-trend-up",
            < 0 => "fa-solid fa-arrow-trend-down",
            _ => "fa-solid fa-minus"
        };
    }

    private string GetTrendColorClass()
    {
        return TrendValue switch
        {
            > 0 when TrendPositiveIsGood => "bw-kpi-trend-up",
            > 0 when !TrendPositiveIsGood => "bw-kpi-trend-down",
            < 0 when TrendPositiveIsGood => "bw-kpi-trend-down",
            < 0 when !TrendPositiveIsGood => "bw-kpi-trend-up",
            _ => "bw-kpi-trend-neutral"
        };
    }

    private string GetIconColorClass()
    {
        return Color switch
        {
            BwColor.Primary => "bw-kpi-icon-primary",
            BwColor.Success => "bw-kpi-icon-success",
            BwColor.Warning => "bw-kpi-icon-warning",
            BwColor.Danger => "bw-kpi-icon-danger",
            BwColor.Info => "bw-kpi-icon-info",
            BwColor.Secondary => "bw-kpi-icon-secondary",
            _ => "bw-kpi-icon-primary"
        };
    }

    private string GetProgressColorClass()
    {
        return Color switch
        {
            BwColor.Primary => "bw-kpi-progress-primary",
            BwColor.Success => "bw-kpi-progress-success",
            BwColor.Warning => "bw-kpi-progress-warning",
            BwColor.Danger => "bw-kpi-progress-danger",
            BwColor.Info => "bw-kpi-progress-info",
            BwColor.Secondary => "bw-kpi-progress-secondary",
            _ => "bw-kpi-progress-primary"
        };
    }

    private async Task HandleClick()
    {
        if (Clickable)
        {
            await OnClick.InvokeAsync();
        }
    }

}
