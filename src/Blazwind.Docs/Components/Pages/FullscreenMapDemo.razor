@page "/demos/fullscreen-map"
@using Blazwind.Components.Drawer
@using Blazwind.Components.Input
@using Blazwind.Components.Map
@using Blazwind.Components.Map.Models
@using Blazwind.Components.Typography
@using Blazwind.Docs.Components.Samples
@layout MapFullscreenLayout
@inject DialogService DialogService
@inject DrawerService DrawerService

<PageTitle>Fullscreen Map - Blazwind</PageTitle>

<div class="relative w-full h-full">
    <BwMapLibre @ref="_map" StyleUrl="osm_style.json" Center="@_sivasCenter" Zoom="14" NavigationControl="true"
                ScaleControl="true" FullscreenControl="true" GeolocateControl="true" OnLoad="OnMapLoaded">

        @* Map Markers *@
        <BwMapLibreMarker Id="meydan" Longitude="37.0150" Latitude="39.7505" Color="#ef4444"
                          PopupContent="<strong>Sivas Square</strong><br/>Historic city center"/>

        <BwMapLibreMarker Id="kongre" Longitude="37.0180" Latitude="39.7480" Color="#3b82f6"
                          PopupContent="<strong>Congress Building</strong><br/>Historic building where Sivas Congress was held"/>

        <BwMapLibreMarker Id="ulucami" Longitude="37.0165" Latitude="39.7510" Color="#10b981"
                          PopupContent="<strong>Grand Mosque</strong><br/>Historic Seljuk mosque"/>

        @* Declarative Layers *@

        @* OSM Base Layer (Raster) *@
        @if (_osmVisible)
        {
            <BwMapLibreSource Id="osm-source" Type="@MapSourceType.Raster"
                              Tiles="@(new List<string> { "https://tile.openstreetmap.org/{z}/{x}/{y}.png" })"
                              TileSize="256">
                <BwMapLibreLayer Id="osm-layer" Type="@MapLayerType.Raster" SourceId="osm-source"/>
            </BwMapLibreSource>
        }

        @* Buildings (Vector Tile) - ClickOrder 10 (Higher priority) *@
        @if (_binalarVisible)
        {
            <BwMapLibreSource Id="binalar-source" Type="@MapSourceType.Vector"
                              Tiles="@(new List<string> { "https://harita.sivas.bel.tr/binalar/{z}/{x}/{y}" })">
                <BwMapLibreLayer Id="binalar-fill" Type="@MapLayerType.Fill" SourceId="binalar-source"
                                 SourceLayer="binalar"
                                 Interactive="true" ClickOrder="@_binalarClickOrder" OnClick="OnBinalarClick"
                                 Paint="@(new Dictionary<string, object> { ["fill-color"] = "#ef4444", ["fill-opacity"] = 0.6, ["fill-outline-color"] = "#ffffff" })"/>
            </BwMapLibreSource>
        }

        @* Assembly Areas (GeoJSON) - ClickOrder 5 *@
        @if (_toplanmaVisible)
        {
            <BwMapLibreSource Id="toplanma-alanlari-source" Type="@MapSourceType.GeoJson"
                              Data="@("https://kentrehberi.sivas.bel.tr/api/geojson/toplanma-alanlari")">
                <BwMapLibreLayer Id="toplanma-alanlari-fill" Type="@MapLayerType.Fill"
                                 SourceId="toplanma-alanlari-source"
                                 Interactive="true" ClickOrder="@_toplanmaClickOrder" OnClick="OnToplanmaClick"
                                 Paint="@(new Dictionary<string, object> { ["fill-color"] = "#3b82f6", ["fill-opacity"] = 0.6, ["fill-outline-color"] = "#ffffff" })"/>
            </BwMapLibreSource>
        }

        @* Unlicensed Buildings (WMS) *@
        @if (_wmsVisible && !_wmsHasCorsError)
        {
            <BwMapLibreSource Id="ruhsatsiz-wms-source" Type="@MapSourceType.Raster"
                              Tiles="@(new List<string> { "https://tucbs.sivas.bel.tr/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=view_binalar_ruhsatsiz&WIDTH=256&HEIGHT=256&CRS=EPSG:3857&BBOX={bbox-epsg-3857}" })"
                              TileSize="256">
                <BwMapLibreLayer Id="ruhsatsiz-wms-layer" Type="@MapLayerType.Raster" SourceId="ruhsatsiz-wms-source"
                                 Paint="@(new Dictionary<string, object> { ["raster-opacity"] = 1.0 })"/>
            </BwMapLibreSource>
        }

    </BwMapLibre>

    @* Control Panel *@
    <div class="absolute top-4 left-4 z-[1000]">
        <BwCard Class="bg-white/95 dark:bg-gray-800/95 backdrop-blur shadow-xl w-80">
            @* Title *@
            <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                <div class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-map-location-dot text-white text-lg"></i>
                </div>
                <div>
                    <BwTypography Tag="BwTypographyTag.H5" Weight="BwFontWeight.Bold">Sivas City Map</BwTypography>
                    <BwTypography Tag="BwTypographyTag.P" Size="BwSize.Small" Class="text-gray-500">
                        Layer and location management
                    </BwTypography>
                </div>
            </div>

            @* Quick Locations *@
            <div class="mb-4">
                <BwTypography Tag="BwTypographyTag.P" Size="BwSize.Small" Weight="BwFontWeight.Semibold"
                              Class="text-gray-600 dark:text-gray-400 mb-2">
                    <i class="fa-solid fa-location-dot mr-1"></i> Quick Locations
                </BwTypography>
                <div class="flex flex-wrap gap-2">
                    <BwButton Text="Square" Color="BwColor.Danger" Size="BwSize.Small" OnClick="GoToMeydan"/>
                    <BwButton Text="Congress" Color="BwColor.Primary" Size="BwSize.Small" OnClick="GoToKongre"/>
                    <BwButton Text="General" Color="BwColor.Secondary" Variant="BwVariant.Outline" Size="BwSize.Small"
                              OnClick="ResetView"/>
                </div>
            </div>

            @* Layers *@
            <div class="mb-4">
                <BwTypography Tag="BwTypographyTag.P" Size="BwSize.Small" Weight="BwFontWeight.Semibold"
                              Class="text-gray-600 dark:text-gray-400 mb-2">
                    <i class="fa-solid fa-layer-group mr-1"></i> Layers
                </BwTypography>
                <div class="space-y-2">
                    @* OSM Base Layer *@
                    <label
                        class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                        <input type="checkbox" checked="@_osmVisible" @onchange="ToggleOSM"
                               class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500"/>
                        <span class="w-4 h-4 rounded bg-gray-400"></span>
                        <span class="text-sm">OpenStreetMap</span>
                    </label>

                    @* Buildings (Vector Tile) *@
                    <label
                        class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                        <input type="checkbox" checked="@_binalarVisible" @onchange="ToggleBinalar"
                               class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500"/>
                        <span class="w-4 h-4 rounded bg-red-500"></span>
                        <span class="text-sm">Buildings</span>
                        <span class="ml-auto text-xs text-gray-400">Vector</span>
                    </label>

                    @* Assembly Areas (GeoJSON) *@
                    <label
                        class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                        <input type="checkbox" checked="@_toplanmaVisible" @onchange="ToggleToplanma"
                               class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500"/>
                        <span class="w-4 h-4 rounded bg-blue-500"></span>
                        <span class="text-sm">Assembly Areas</span>
                        <span class="ml-auto text-xs text-gray-400">GeoJSON</span>
                    </label>

                    @* Unlicensed Buildings (WMS) *@
                    <label
                        class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors @(_wmsHasCorsError ? "opacity-50" : "")">
                        <input type="checkbox" checked="@_wmsVisible" @onchange="ToggleWms" disabled="@_wmsHasCorsError"
                               class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500"/>
                        <span class="w-4 h-4 rounded bg-orange-500"></span>
                        <span class="text-sm">Unlicensed Buildings</span>
                        <span class="ml-auto text-xs text-gray-400">WMS</span>
                    </label>
                    @if (_wmsHasCorsError)
                    {
                        <div class="text-xs text-orange-500 ml-6">
                            <i class="fa-solid fa-exclamation-triangle mr-1"></i> CORS error - Server configuration
                            required
                        </div>
                    }
                </div>

                @* Click Order *@
                <div class="mb-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <BwTypography Tag="BwTypographyTag.P" Size="BwSize.Small" Weight="BwFontWeight.Semibold"
                                  Class="text-gray-600 dark:text-gray-400 mb-2">
                        <i class="fa-solid fa-sort-amount-up mr-1"></i> Click Priority
                    </BwTypography>
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Buildings Priority</div>
                            <BwSelect TValue="int" Value="_binalarClickOrder" ValueChanged="SetBinalarClickOrder"
                                      Items="_clickOrderOptions" Size="BwSize.Small"/>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Assembly Priority</div>
                            <BwSelect TValue="int" Value="_toplanmaClickOrder" ValueChanged="SetToplanmaClickOrder"
                                      Items="_clickOrderOptions" Size="BwSize.Small"/>
                        </div>
                    </div>
                </div>
            </div>

            @* Map Tools *@
            <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <div class="flex gap-1">
                        <BwButton Icon="fa-solid fa-compass" Color="BwColor.Secondary" Variant="BwVariant.Ghost"
                                  Size="BwSize.Small" OnClick="ResetNorth" Title="Reset North"/>
                        <BwButton Icon="fa-solid fa-plus" Color="BwColor.Secondary" Variant="BwVariant.Ghost"
                                  Size="BwSize.Small" OnClick="ZoomIn" Title="Zoom In"/>
                        <BwButton Icon="fa-solid fa-minus" Color="BwColor.Secondary" Variant="BwVariant.Ghost"
                                  Size="BwSize.Small" OnClick="ZoomOut" Title="Zoom Out"/>
                    </div>
                    <a href="/maps"
                       class="relative inline-flex items-center justify-center gap-2 font-medium rounded transition-all focus:outline-none focus:ring-2 focus:ring-offset-1 border-2 border-transparent px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100 focus:ring-gray-400 no-underline">
                        <i class="fa-solid fa-arrow-left text-xs"></i>
                        <span>Back</span>
                    </a>
                </div>
            </div>
        </BwCard>
    </div>

    @* Legend *@
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[1000]">
        <div
            class="bg-white/95 dark:bg-gray-800/95 backdrop-blur rounded-full px-6 py-2 shadow-lg flex items-center gap-4 text-sm">
            <span class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-danger-500"></span>
                <span>Square</span>
            </span>
            <span class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-primary-500"></span>
                <span>Congress</span>
            </span>
            <span class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-success-500"></span>
                <span>Grand Mosque</span>
            </span>
        </div>
    </div>
</div>

@code {
    private BwMapLibre? _map;
    private readonly double[] _sivasCenter = [37.0150, 39.7505];

    // Layer visibility states
    private bool _osmVisible = true;
    private bool _binalarVisible;
    private bool _toplanmaVisible;
    private bool _wmsVisible;
    private readonly bool _wmsHasCorsError = true; // Keep true until CORS is enabled on WMS server

    // Click Order
    private int _binalarClickOrder = 10;
    private int _toplanmaClickOrder = 5;

    private readonly List<BwSelectItem<int>> _clickOrderOptions = new()
    {
        new BwSelectItem<int>(1, "1 - Low"),
        new BwSelectItem<int>(5, "5 - Medium"),
        new BwSelectItem<int>(10, "10 - High")
    };

    private void OnMapLoaded()
    {
        // Map ready
    }

    private async Task OnBinalarClick(MapLayerClickEventArgs e)
    {
        if (e.Features.Count == 0) return;
        var feature = e.Features[0];

        var parameters = new Dictionary<string, object> { { "Feature", feature } };

        // Right Drawer for Buildings
        await DrawerService.ShowAsync<MapFeatureDialog>("Building Information", parameters, new DrawerOptions
        {
            Position = BwDirection.Right,
            Size = BwSize.Large,
            Resizable = true
        });
    }

    private async Task OnToplanmaClick(MapLayerClickEventArgs e)
    {
        if (e.Features.Count == 0) return;
        var feature = e.Features[0];

        var parameters = new Dictionary<string, object> { { "Feature", feature } };

        // Bottom Drawer for Assembly Areas
        await DrawerService.ShowAsync<MapFeatureDialog>("Assembly Area Information", parameters, new DrawerOptions
        {
            Position = BwDirection.Bottom,
            Size = BwSize.Large
        });
    }

    #region Location Navigation

    private async Task GoToMeydan()
    {
        if (_map == null) return;
        await _map.FlyToAsync(new FlyToOptions
        {
            Center = new LngLat(37.0150, 39.7505),
            Zoom = 17,
            Duration = 2000
        });
    }

    private async Task GoToKongre()
    {
        if (_map == null) return;
        await _map.FlyToAsync(new FlyToOptions
        {
            Center = new LngLat(37.0180, 39.7480),
            Zoom = 17,
            Duration = 2000
        });
    }

    private async Task ResetView()
    {
        if (_map == null) return;
        await _map.FlyToAsync(new FlyToOptions
        {
            Center = new LngLat(37.0150, 39.7505),
            Zoom = 14,
            Duration = 2000
        });
    }

    private async Task ResetNorth()
    {
        if (_map == null) return;
        await _map.ResetNorthAsync();
    }

    private async Task ZoomIn()
    {
        if (_map == null) return;
        await _map.ZoomInAsync();
    }

    private async Task ZoomOut()
    {
        if (_map == null) return;
        await _map.ZoomOutAsync();
    }

    #endregion

    #region Layer Management

    private void ToggleOSM(ChangeEventArgs e)
    {
        _osmVisible = (bool)(e.Value ?? false);
    }

    private void ToggleBinalar(ChangeEventArgs e)
    {
        _binalarVisible = (bool)(e.Value ?? false);
    }

    private void ToggleToplanma(ChangeEventArgs e)
    {
        _toplanmaVisible = (bool)(e.Value ?? false);
    }

    private void ToggleWms(ChangeEventArgs e)
    {
        if (_wmsHasCorsError) return;
        _wmsVisible = (bool)(e.Value ?? false);
    }

    private void SetBinalarClickOrder(int value)
    {
        _binalarClickOrder = value;
    }

    private void SetToplanmaClickOrder(int value)
    {
        _toplanmaClickOrder = value;
    }

    #endregion

}