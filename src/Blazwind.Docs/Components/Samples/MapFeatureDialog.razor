@using Blazwind.Components.Dialog
@using Blazwind.Components.Drawer
@using Blazwind.Components.Button
@using Blazwind.Components.Map.Models
@using Blazwind.Components.Layout
@using Blazwind.Components.Typography
@using Blazwind.Components.Icon
@using Blazwind.Components.Card
@using Blazwind.Components.Shared
@using Blazwind.Components.Border
@inject DialogService DialogService
@inject DrawerService DrawerService

<BwColumn Spacing="BwSpacing.Md">
    @if (Feature != null)
    {
        @* Genel Bilgiler *@
        <BwCard Color="BwColor.Secondary">
            <BwRow CrossAxisAlignment="BwCrossAxisAlignment.Center" Spacing="BwSpacing.Sm">
                <BwMargin Bottom="BwSpacing.Sm" Class="flex items-center gap-2 w-full">
                    <BwIcon Name="fa-solid fa-info-circle" Color="BwColor.Primary" />
                    <BwTypography Tag="BwTypographyTag.Span" Weight="BwFontWeight.Semibold">General Information
                    </BwTypography>
                </BwMargin>
            </BwRow>
            <BwGrid Columns="2" Gap="BwSpacing.Sm">
                <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.Small" Color="BwColor.Secondary">Type:</BwTypography>
                <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.Small" Weight="BwFontWeight.Medium">@Feature.Type
                </BwTypography>

                @if (Feature.Id != null)
                {
                    <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.Small" Color="BwColor.Secondary">ID:</BwTypography>
                    <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.ExtraSmall" Weight="BwFontWeight.Medium"
                        Class="font-mono">@Feature.Id</BwTypography>
                }

                @if (!string.IsNullOrEmpty(Feature.Source))
                {
                    <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.Small" Color="BwColor.Secondary">Source:</BwTypography>
                    <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.Small" Weight="BwFontWeight.Medium">@Feature.Source
                    </BwTypography>
                }

                @if (!string.IsNullOrEmpty(Feature.SourceLayer))
                {
                    <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.Small" Color="BwColor.Secondary">Source Layer:
                    </BwTypography>
                    <BwTypography Tag="BwTypographyTag.Div" Size="BwSize.Small" Weight="BwFontWeight.Medium">
                        @Feature.SourceLayer</BwTypography>
                }
            </BwGrid>
        </BwCard>

        @* Geometri Bilgisi *@
        @if (Feature.Geometry != null)
        {
            <BwCard Color="BwColor.Info">
                <BwMargin Bottom="BwSpacing.Sm" Class="flex items-center gap-2">
                    <BwIcon Name="fa-solid fa-draw-polygon" Color="BwColor.Info" />
                    <BwTypography Tag="BwTypographyTag.Span" Weight="BwFontWeight.Semibold">Geometry</BwTypography>
                </BwMargin>
                <BwRow Spacing="BwSpacing.Sm">
                    <BwTypography Tag="BwTypographyTag.Span" Size="BwSize.Small" Color="BwColor.Secondary">Tip:</BwTypography>
                    <BwTypography Tag="BwTypographyTag.Span" Size="BwSize.Small" Weight="BwFontWeight.Medium">
                        @Feature.Geometry.Type</BwTypography>
                </BwRow>
            </BwCard>
        }

        @* Properties *@
        @if (Feature.Properties != null && Feature.Properties.Count > 0)
        {
            <BwCard Color="BwColor.Success">
                <BwMargin Bottom="BwSpacing.Sm" Class="flex items-center gap-2">
                    <BwIcon Name="fa-solid fa-tags" Color="BwColor.Success" />
                    <BwTypography Tag="BwTypographyTag.Span" Weight="BwFontWeight.Semibold">Properties</BwTypography>
                    <BwTypography Tag="BwTypographyTag.Span" Size="BwSize.ExtraSmall" Color="BwColor.Secondary" Class="ml-auto">
                        (@Feature.Properties.Count items)</BwTypography>
                </BwMargin>
                <div style="max-height: 16rem; overflow-y: auto;">
                    <table style="width: 100%;">
                        <tbody>
                            @foreach (var prop in Feature.Properties.OrderBy(p => p.Key))
                            {
                                <tr style="border-bottom: 1px solid var(--bw-color-border);">
                                    <td style="padding: 0.5rem 1rem 0.5rem 0;">
                                        <BwTypography Tag="BwTypographyTag.Span" Size="BwSize.Small" Weight="BwFontWeight.Medium"
                                            Color="BwColor.Secondary" Class="whitespace-nowrap">@prop.Key</BwTypography>
                                    </td>
                                    <td style="padding: 0.5rem 0; word-break: break-all;">
                                        <BwTypography Tag="BwTypographyTag.Span" Size="BwSize.Small">@FormatValue(prop.Value)
                                        </BwTypography>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </BwCard>
        }
        else
        {
            <BwColumn MainAxisAlignment="BwMainAxisAlignment.Center" CrossAxisAlignment="BwCrossAxisAlignment.Center"
                Spacing="BwSpacing.Sm">
                <BwPadding Vertical="BwSpacing.Lg">
                    <BwIcon Name="fa-solid fa-inbox" Size="BwSize.Large" Color="BwColor.Gray" />
                    <BwTypography Tag="BwTypographyTag.P" Size="BwSize.Small" Color="BwColor.Gray">No additional information
                        available for this feature.</BwTypography>
                </BwPadding>
            </BwColumn>
        }
    }
    else
    {
        <BwColumn MainAxisAlignment="BwMainAxisAlignment.Center" CrossAxisAlignment="BwCrossAxisAlignment.Center"
            Spacing="BwSpacing.Sm">
            <BwPadding Vertical="BwSpacing.Xl">
                <BwIcon Name="fa-solid fa-exclamation-circle" Size="BwSize.ExtraLarge" Color="BwColor.Gray" />
                <BwTypography Tag="BwTypographyTag.P" Color="BwColor.Gray">Feature data not found.</BwTypography>
            </BwPadding>
        </BwColumn>
    }

    @* Footer *@
    <BwBorder Position="BwBorderPosition.Top" />
    <BwRow MainAxisAlignment="BwMainAxisAlignment.End" Spacing="BwSpacing.Sm">
        <BwPadding Top="BwSpacing.Md">
            <BwButton Text="Close" Color="BwColor.Secondary" OnClick="Close" />
        </BwPadding>
    </BwRow>
</BwColumn>

@code {
    [CascadingParameter] public DialogInstance? DialogInstance { get; set; }
    [CascadingParameter] public DrawerInstance? DrawerInstance { get; set; }

    [Parameter] public MapFeature? Feature { get; set; }

    private void Close()
    {
        if (DialogInstance != null)
        {
            DialogService.Close(DialogInstance, DialogResult.Cancel());
        }
        else if (DrawerInstance != null)
        {
            DrawerService.Close(DrawerInstance, DrawerResult.Cancel());
        }
    }

    private string FormatValue(object? value)
    {
        if (value == null) return "-";

        var strValue = value.ToString() ?? "-";

        // Çok uzun değerleri kısalt
        if (strValue.Length > 100)
        {
            return strValue.Substring(0, 100) + "...";
        }

        return strValue;
    }
}