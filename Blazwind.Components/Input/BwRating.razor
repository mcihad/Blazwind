@namespace Blazwind.Components.Input
@using Blazwind.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions

@{
    var sizeClass = Size switch
    {
        BwSize.Small => "text-lg gap-0.5",
        BwSize.Large => "text-3xl gap-1.5",
        _ => "text-2xl gap-1"
    };
    
    var (filledColor, emptyColor) = Color switch
    {
        BwColor.Warning => ("text-amber-400", "text-gray-300"),
        BwColor.Danger => ("text-red-500", "text-gray-300"),
        BwColor.Success => ("text-green-500", "text-gray-300 dark:text-gray-600"),
        _ => ("text-amber-400", "text-gray-300 dark:text-gray-600")
    };
}

<div class="@Class">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">@Label</label>
    }
    
    <div class="flex items-center @sizeClass @(IsReadOnly || IsDisabled ? "" : "cursor-pointer")">
        @for (int i = 1; i <= MaxValue; i++)
        {
            var starIndex = i;
            var isFilled = Value >= starIndex;
            var isHalf = AllowHalf && Value >= starIndex - 0.5 && Value < starIndex;
            
            <span class="relative transition-transform @(IsReadOnly || IsDisabled ? "" : "hover:scale-110")"
                  @onclick="() => OnStarClick(starIndex)"
                  @onmouseover="() => OnStarHover(starIndex)"
                  @onmouseout="OnMouseOut">
                @if (isHalf)
                {
                    @* Half star - empty background *@
                    <i class="@EmptyIcon @emptyColor"></i>
                    @* Half star - filled overlay *@
                    <span class="absolute inset-0 overflow-hidden" style="width: 50%;">
                        <i class="@FilledIcon @filledColor"></i>
                    </span>
                }
                else if (isFilled || (_hoverValue.HasValue && _hoverValue >= starIndex))
                {
                    <i class="@FilledIcon @filledColor"></i>
                }
                else
                {
                    <i class="@EmptyIcon @emptyColor"></i>
                }
            </span>
        }
        
        @if (ShowValue)
        {
            <span class="ml-2 text-sm text-gray-600 dark:text-gray-400 font-medium">@Value.ToString("0.#")</span>
        }
    </div>
    
    @if (!string.IsNullOrEmpty(HelperText))
    {
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">@HelperText</p>
    }
</div>

@code {
    [CascadingParameter] private EditContext? CascadedEditContext { get; set; }
    
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? Class { get; set; }
    
    /// <summary>Current rating value (0 to MaxValue)</summary>
    [Parameter] public double Value { get; set; }
    [Parameter] public EventCallback<double> ValueChanged { get; set; }
    
    /// <summary>Maximum rating value (default: 5)</summary>
    [Parameter] public int MaxValue { get; set; } = 5;
    
    /// <summary>Allow half-star ratings</summary>
    [Parameter] public bool AllowHalf { get; set; }
    
    /// <summary>Display rating value next to stars</summary>
    [Parameter] public bool ShowValue { get; set; }
    
    /// <summary>Read-only mode</summary>
    [Parameter] public bool IsReadOnly { get; set; }
    
    /// <summary>Disabled state</summary>
    [Parameter] public bool IsDisabled { get; set; }
    
    /// <summary>Icon for filled star</summary>
    [Parameter] public string FilledIcon { get; set; } = "fa-solid fa-star";
    
    /// <summary>Icon for empty star</summary>
    [Parameter] public string EmptyIcon { get; set; } = "fa-regular fa-star";
    
    /// <summary>Size of the stars</summary>
    [Parameter] public BwSize Size { get; set; } = BwSize.Medium;
    
    /// <summary>Color variant</summary>
    [Parameter] public BwColor Color { get; set; } = BwColor.Warning;
    
    /// <summary>Expression for validation binding</summary>
    [Parameter] public Expression<Func<double>>? For { get; set; }

    private double? _hoverValue;
    private FieldIdentifier _fieldIdentifier;
    
    protected override void OnInitialized()
    {
        if (CascadedEditContext != null && For != null)
        {
            _fieldIdentifier = FieldIdentifier.Create(For);
        }
    }

    private async Task OnStarClick(int starIndex)
    {
        if (IsReadOnly || IsDisabled) return;
        
        var newValue = AllowHalf && Value == starIndex - 0.5 ? (double)starIndex : starIndex - 0.5;
        if (!AllowHalf) newValue = starIndex;
        
        // Toggle off if clicking the same full value
        if (Value == starIndex && !AllowHalf)
        {
            newValue = 0;
        }
        
        Value = Math.Max(0, Math.Min(MaxValue, newValue));
        await ValueChanged.InvokeAsync(Value);
    }

    private void OnStarHover(int starIndex)
    {
        if (IsReadOnly || IsDisabled) return;
        _hoverValue = starIndex;
    }

    private void OnMouseOut()
    {
        _hoverValue = null;
    }
}
