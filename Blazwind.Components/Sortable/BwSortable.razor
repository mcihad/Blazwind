@namespace Blazwind.Components.Sortable
@using Blazwind.Components.Shared

@typeparam TItem

<div class="@Class" style="@Style">
    @foreach (var (item, index) in Items.Select((item, i) => (item, i)))
    {
        var isDragging = _dragIndex == index;
        var isOver = _overIndex == index && _dragIndex != index;
        
        <div class="@(isDragging ? "opacity-50" : "") @(isOver ? "border-t-2 border-blue-500" : "") transition-all"
             draggable="true"
             @ondragstart="() => HandleDragStart(index)"
             @ondragover="() => HandleDragOver(index)"
             @ondragover:preventDefault="true"
             @ondrop="() => HandleDrop(index)"
             @ondragend="HandleDragEnd">
            <div class="flex items-center gap-2">
                @if (ShowHandle)
                {
                    <div class="cursor-grab active:cursor-grabbing text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 px-1">
                        <i class="@HandleIcon"></i>
                    </div>
                }
                <div class="flex-1">
                    @ItemTemplate(item)
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public List<TItem> Items { get; set; } = new();
    [Parameter, EditorRequired] public RenderFragment<TItem> ItemTemplate { get; set; } = default!;
    [Parameter] public bool ShowHandle { get; set; } = true;
    [Parameter] public string HandleIcon { get; set; } = "fa-solid fa-grip-vertical";
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public EventCallback<List<TItem>> OnReorder { get; set; }
    
    private int _dragIndex = -1;
    private int _overIndex = -1;
    
    private void HandleDragStart(int index)
    {
        _dragIndex = index;
    }
    
    private void HandleDragOver(int index)
    {
        _overIndex = index;
    }
    
    private async Task HandleDrop(int targetIndex)
    {
        if (_dragIndex < 0 || _dragIndex == targetIndex) return;
        
        var item = Items[_dragIndex];
        Items.RemoveAt(_dragIndex);
        
        if (targetIndex > _dragIndex) targetIndex--;
        Items.Insert(targetIndex, item);
        
        await OnReorder.InvokeAsync(Items);
        
        _dragIndex = -1;
        _overIndex = -1;
    }
    
    private void HandleDragEnd()
    {
        _dragIndex = -1;
        _overIndex = -1;
    }
}
