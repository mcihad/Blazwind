@namespace Blazwind.Components.Gantt
@using Blazwind.Components.Shared
@using Blazwind.Components.Avatar
@using Blazwind.Components.Button
@using Blazwind.Components.Card
@using Blazwind.Components.Layout
@using Microsoft.JSInterop
@using System.Globalization
@inject IJSRuntime JS
@implements IAsyncDisposable

<BwCard Class="@($"bw-gantt overflow-hidden {Class}")" Style="@Style" BodyClass="p-0">
    @* Header - View Controls *@
    <BwRow MainAxisAlignment="BwMainAxisAlignment.SpaceBetween" CrossAxisAlignment="BwCrossAxisAlignment.Center" Class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
        <div class="font-medium text-sm text-gray-700 dark:text-gray-200 flex items-center">
            <i class="fa-solid fa-bars-progress mr-2"></i>
            @Title
        </div>
        <BwButtonGroup Size="BwSize.Small">
            <BwButton Text="Gün" 
                      Variant="@(ViewMode == GanttViewMode.Day ? BwVariant.Filled : BwVariant.Outline)" 
                      Color="@(ViewMode == GanttViewMode.Day ? BwColor.Primary : BwColor.Secondary)"
                      OnClick="() => SetViewMode(GanttViewMode.Day)" />
            <BwButton Text="Hafta" 
                      Variant="@(ViewMode == GanttViewMode.Week ? BwVariant.Filled : BwVariant.Outline)" 
                      Color="@(ViewMode == GanttViewMode.Week ? BwColor.Primary : BwColor.Secondary)"
                      OnClick="() => SetViewMode(GanttViewMode.Week)" />
            <BwButton Text="Ay" 
                      Variant="@(ViewMode == GanttViewMode.Month ? BwVariant.Filled : BwVariant.Outline)" 
                      Color="@(ViewMode == GanttViewMode.Month ? BwColor.Primary : BwColor.Secondary)"
                      OnClick="() => SetViewMode(GanttViewMode.Month)" />
        </BwButtonGroup>
    </BwRow>

    @* Main Content with unified vertical scroll *@
    <div class="overflow-auto" style="height: @Height;">
        <div class="flex min-w-max">
            @* Task List (Left Panel - Sticky) *@
            <div class="w-64 flex-shrink-0 border-r border-gray-200 dark:border-gray-700 sticky left-0 bg-white dark:bg-gray-800 z-50">
                @* Task List Header *@
                <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-3 h-8 flex items-center text-xs font-semibold text-gray-600 dark:text-gray-400 z-50" style="top: 0;">
                    Görevler
                </div>
                @* Task List Items - fixed height rows *@
                @{ int taskIndex = 0; }
                @foreach (var task in FlatTasks)
                {
                    var isHovered = _hoveredTaskId == task.Id;
                    <div class="bw-gantt-task-row flex items-center gap-2 px-3 border-b border-gray-100 dark:border-gray-700 cursor-pointer text-sm transition-colors h-8 @(task.ParentId != null ? "pl-6" : "") @(isHovered ? "bg-blue-50 dark:bg-blue-900/20" : "hover:bg-gray-50 dark:hover:bg-gray-700")"
                         data-task-index="@taskIndex"
                         @onclick="() => HandleTaskClick(task)"
                         @onmouseenter="() => _hoveredTaskId = task.Id"
                         @onmouseleave="() => _hoveredTaskId = null">
                        @if (task.Children.Count > 0)
                        {
                            <i class="fa-solid fa-folder text-amber-500 text-xs"></i>
                        }
                        else if (task.IsMilestone)
                        {
                            <i class="fa-solid fa-diamond text-purple-500 text-xs"></i>
                        }
                        else
                        {
                            <i class="fa-solid fa-circle text-xs" style="color: @(task.Color ?? "#3b82f6")"></i>
                        }
                        <span class="truncate flex-1 @(task.Status == GanttTaskStatus.Completed ? "line-through text-gray-400 dark:text-gray-500" : "text-gray-700 dark:text-gray-200")">
                            @task.Title
                        </span>
                        @if (!string.IsNullOrEmpty(task.AssigneeAvatar) || !string.IsNullOrEmpty(task.AssigneeName))
                        {
                            <BwAvatar Name="@task.AssigneeName" Src="@task.AssigneeAvatar" Size="BwSize.ExtraSmall" />
                        }
                    </div>
                    taskIndex++;
                }
            </div>


        @* Timeline (Right Panel) *@
        <div class="flex-1">
            @* Timeline Header - same height as task list header *@
            <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 flex z-40 h-8" style="top: 0;">
                @foreach (var period in TimelinePeriods)
                {
                    <div class="flex-shrink-0 text-center border-r border-gray-200 dark:border-gray-700 px-1 flex items-center justify-center text-xs font-semibold text-gray-600 dark:text-gray-400"
                         style="width: @(GetColumnWidth())px;">
                        @period
                    </div>
                }
            </div>

            @* Timeline Grid - with @ref for JS interop *@
            <div @ref="_timelineContainer" class="relative" style="width: @(TimelinePeriods.Count * GetColumnWidth())px;">
                @* Row Backgrounds with Grid Pattern *@
                <div class="absolute inset-0 pointer-events-none">
                    @{ int rowBgIndex = 0; }
                    @foreach (var task in FlatTasks)
                    {
                        var isRowHovered = _hoveredTaskId == task.Id;
                        <div class="absolute left-0 right-0 border-b border-gray-100 dark:border-gray-700 transition-colors @(isRowHovered ? "bg-blue-50/50 dark:bg-blue-900/10" : (rowBgIndex % 2 == 0 ? "bg-white dark:bg-gray-800" : "bg-gray-50/30 dark:bg-gray-800/50"))"
                             style="top: @(rowBgIndex * 32)px; height: 32px;"></div>
                        rowBgIndex++;
                    }
                </div>
                
                @* Vertical Grid Lines *@
                <div class="absolute inset-0 flex pointer-events-none">
                    @foreach (var period in TimelinePeriods)
                    {
                        <div class="border-r border-gray-100/60 dark:border-gray-700/60 flex-shrink-0 bg-gradient-to-b from-transparent via-gray-50/10 dark:via-gray-800/10 to-transparent" style="width: @(GetColumnWidth())px;"></div>
                    }
                </div>

                @* Today Line *@
                @if (TodayOffset >= 0 && TodayOffset <= TimelinePeriods.Count)
                {
                    <div class="absolute top-0 bottom-0 w-0.5 bg-red-400 z-20"
                         style="left: @(TodayOffset * GetColumnWidth())px;">
                        <div class="absolute -top-1 -left-1 w-2 h-2 rounded-full bg-red-400"></div>
                    </div>
                }

                @* Task Bars *@
                @{
                    int rowIndex = 0;
                }
                @foreach (var task in FlatTasks)
                {
                    var barStyle = GetTaskBarStyle(task, rowIndex);
                    var taskLocal = task;
                    
                    @* Task bar container with data-task-id for JS *@
                    <div class="bw-gantt-bar absolute flex items-center @(Editable ? "cursor-move" : "")" 
                         style="@barStyle"
                         data-task-id="@task.Id"
                         @onclick="() => HandleTaskClick(taskLocal)">
                        @if (task.IsMilestone)
                        {
                            @* Milestone Diamond *@
                            <div class="w-3 h-3 transform rotate-45 shadow-sm hover:scale-110 transition-transform" 
                                 style="background-color: @(task.Color ?? "#8b5cf6");"></div>
                        }
                        else
                        {
                            @* Task Bar with compact height *@
                            <div class="h-5 rounded shadow-sm relative overflow-hidden group transition-all hover:shadow-md"
                                 style="width: 100%; background-color: @(GetTaskBgColor(task));">
                                
                                @* Left resize handle *@
                                @if (Editable)
                                {
                                    <div class="bw-gantt-resize-handle bw-gantt-resize-left absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 transition-colors z-10"></div>
                                }
                                
                                @* Progress *@
                                @if (task.Progress > 0)
                                {
                                    <div class="absolute inset-y-0 left-0 rounded-l"
                                         style="width: @task.Progress%; background-color: @(task.Color ?? "#3b82f6");"></div>
                                }
                                
                                @* Label *@
                                <div class="absolute inset-0 flex items-center justify-center px-1">
                                    <span class="text-[9px] font-medium text-white truncate drop-shadow">
                                        @if (task.Progress > 0 && task.Progress < 100)
                                        {
                                            @($"{task.Progress}%")
                                        }
                                    </span>
                                </div>
                                
                                @* Right resize handle *@
                                @if (Editable)
                                {
                                    <div class="bw-gantt-resize-handle bw-gantt-resize-right absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 transition-colors z-10"></div>
                                }
                                
                                @* Tooltip on hover *@
                                <div class="absolute left-0 bottom-full mb-1 hidden group-hover:block z-30 pointer-events-none">
                                    <div class="bg-gray-800 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap shadow-lg">
                                        <span class="font-medium">@task.Title</span> - @task.Progress%
                                        <br />
                                        @task.StartDate.ToString("dd.MM") - @task.EndDate.ToString("dd.MM")
                                        @if (Editable)
                                        {
                                            <br /><span class="text-gray-400 text-[9px]">Sürükle: taşı | Kenarlar: boyutlandır</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    rowIndex++;
                }
            </div>
        </div>
        </div>
    </div>
</BwCard>

@code {
    [Parameter] public List<GanttTask> Tasks { get; set; } = new();
    [Parameter] public string Title { get; set; } = "Proje Planı";
    [Parameter] public string Height { get; set; } = "400px";
    [Parameter] public GanttViewMode ViewMode { get; set; } = GanttViewMode.Week;
    [Parameter] public DateTime? StartDate { get; set; }
    [Parameter] public DateTime? EndDate { get; set; }
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public bool Editable { get; set; } = false;
    [Parameter] public EventCallback<GanttTask> OnTaskClick { get; set; }
    [Parameter] public EventCallback<GanttTaskResizeEventArgs> OnTaskResize { get; set; }
    [Parameter] public EventCallback<GanttTaskDragEventArgs> OnTaskDrag { get; set; }

    private List<GanttTask> FlatTasks => FlattenTasks(Tasks);
    private List<string> TimelinePeriods = new();
    private DateTime _timelineStart;
    private DateTime _timelineEnd;
    private double TodayOffset => (DateTime.Today - _timelineStart).TotalDays;
    private string? _hoveredTaskId;

    protected override void OnParametersSet()
    {
        CalculateTimeline();
    }

    private List<GanttTask> FlattenTasks(List<GanttTask> tasks, int level = 0)
    {
        var result = new List<GanttTask>();
        foreach (var task in tasks)
        {
            result.Add(task);
            if (task.Children.Count > 0)
            {
                result.AddRange(FlattenTasks(task.Children, level + 1));
            }
        }
        return result;
    }

    private void CalculateTimeline()
    {
        var allTasks = FlatTasks;
        if (allTasks.Count == 0)
        {
            _timelineStart = StartDate ?? DateTime.Today;
            _timelineEnd = EndDate ?? DateTime.Today.AddMonths(1);
        }
        else
        {
            _timelineStart = StartDate ?? allTasks.Min(t => t.StartDate).AddDays(-3);
            _timelineEnd = EndDate ?? allTasks.Max(t => t.EndDate).AddDays(7);
        }

        TimelinePeriods = GeneratePeriods();
    }

    private List<string> GeneratePeriods()
    {
        var periods = new List<string>();
        var current = _timelineStart;

        while (current <= _timelineEnd)
        {
            switch (ViewMode)
            {
                case GanttViewMode.Day:
                    periods.Add(current.ToString("dd"));
                    current = current.AddDays(1);
                    break;
                case GanttViewMode.Week:
                    periods.Add($"H{GetWeekNumber(current)}");
                    current = current.AddDays(7);
                    break;
                case GanttViewMode.Month:
                    var turkishCulture = new CultureInfo("tr-TR");
                    periods.Add(current.ToString("MMM", turkishCulture));
                    current = current.AddMonths(1);
                    break;
            }
        }
        return periods;
    }

    private int GetWeekNumber(DateTime date)
    {
        var jan1 = new DateTime(date.Year, 1, 1);
        return (date.DayOfYear - 1) / 7 + 1;
    }

    private int GetColumnWidth()
    {
        return ViewMode switch
        {
            GanttViewMode.Day => 30,
            GanttViewMode.Week => 60,
            GanttViewMode.Month => 80,
            _ => 40
        };
    }

    private double GetDaysPerColumn()
    {
        return ViewMode switch
        {
            GanttViewMode.Day => 1,
            GanttViewMode.Week => 7,
            GanttViewMode.Month => 30,
            _ => 1
        };
    }

    private string GetTaskBarStyle(GanttTask task, int rowIndex)
    {
        var daysPerColumn = GetDaysPerColumn();
        var columnWidth = GetColumnWidth();
        var rowHeight = 32;

        var startOffset = (task.StartDate - _timelineStart).TotalDays / daysPerColumn * columnWidth;
        var width = task.IsMilestone ? 16 : Math.Max(16, task.DurationDays / daysPerColumn * columnWidth);
        var top = rowIndex * rowHeight + 6;

        return $"left: {startOffset}px; width: {width}px; top: {top}px; height: 20px;";
    }

    private string GetTaskBgColor(GanttTask task)
    {
        if (!string.IsNullOrEmpty(task.Color))
        {
            // Lighter version of the color
            return task.Color + "40";
        }

        return task.Status switch
        {
            GanttTaskStatus.Completed => "#d1fae540",
            GanttTaskStatus.InProgress => "#dbeafe",
            GanttTaskStatus.Delayed => "#fee2e2",
            GanttTaskStatus.Cancelled => "#f3f4f6",
            _ => "#e5e7eb"
        };
    }

    private void SetViewMode(GanttViewMode mode)
    {
        ViewMode = mode;
        CalculateTimeline();
    }

    // JS Interop for drag/resize
    private ElementReference _timelineContainer;
    private DotNetObjectReference<BwGantt>? _netRef;
    private string? _instanceId;
    private bool _isJsInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Editable)
        {
            await InitializeJsInteropAsync();
        }
    }

    private async Task InitializeJsInteropAsync()
    {
        if (_isJsInitialized) return;
        
        _netRef = DotNetObjectReference.Create(this);
        var columnWidth = GetColumnWidth();
        var daysPerColumn = GetDaysPerColumn();
        
        try
        {
            _instanceId = await JS.InvokeAsync<string>(
                "Blazwind.Gantt.init", 
                _timelineContainer, 
                _netRef,
                daysPerColumn,
                columnWidth,
                32 // row height
            );
            _isJsInitialized = true;
        }
        catch
        {
            // JS not available yet
        }
    }

    [JSInvokable]
    public async Task HandleTaskDragFromJs(string taskId, int daysMoved)
    {
        var task = FlatTasks.FirstOrDefault(t => t.Id == taskId);
        if (task == null) return;

        var oldStart = task.StartDate;
        var oldEnd = task.EndDate;
        
        // Update task dates
        task.StartDate = task.StartDate.AddDays(daysMoved);
        task.EndDate = task.EndDate.AddDays(daysMoved);

        var args = new GanttTaskDragEventArgs
        {
            Task = task,
            OldStartDate = oldStart,
            OldEndDate = oldEnd,
            NewStartDate = task.StartDate,
            NewEndDate = task.EndDate,
            DaysMoved = daysMoved
        };
        
        await OnTaskDrag.InvokeAsync(args);
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleTaskResizeFromJs(string taskId, int startDaysDelta, int endDaysDelta)
    {
        var task = FlatTasks.FirstOrDefault(t => t.Id == taskId);
        if (task == null) return;

        var oldStart = task.StartDate;
        var oldEnd = task.EndDate;
        
        // Update task dates
        if (startDaysDelta != 0)
        {
            task.StartDate = task.StartDate.AddDays(startDaysDelta);
        }
        if (endDaysDelta != 0)
        {
            task.EndDate = task.EndDate.AddDays(endDaysDelta);
        }

        var args = new GanttTaskResizeEventArgs
        {
            Task = task,
            OldStartDate = oldStart,
            OldEndDate = oldEnd,
            NewStartDate = task.StartDate,
            NewEndDate = task.EndDate
        };
        
        await OnTaskResize.InvokeAsync(args);
        StateHasChanged();
    }

    private async Task HandleTaskClick(GanttTask task)
    {
        await OnTaskClick.InvokeAsync(task);
    }

    public async ValueTask DisposeAsync()
    {
        if (_instanceId != null)
        {
            try
            {
                await JS.InvokeVoidAsync("Blazwind.Gantt.dispose", _instanceId);
            }
            catch { }
        }
        _netRef?.Dispose();
    }
}
