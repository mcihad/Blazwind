@namespace Blazwind.Components.Gantt
@using Blazwind.Components.Shared
@using Blazwind.Components.Avatar
@using Blazwind.Components.Button
@using Blazwind.Components.Card
@using Blazwind.Components.ContextMenu
@using Blazwind.Components.Layout
@using Microsoft.JSInterop
@using System.Globalization
@inject IJSRuntime JS
@implements IAsyncDisposable

<BwCard Class="@($"bw-gantt overflow-hidden {(_isFullScreen ? "fixed inset-0 z-50 m-0 rounded-none w-screen h-screen shadow-none border-none" : Class)}")" Style="@(_isFullScreen ? "z-index: 50;" : Style)" BodyClass="p-0">
    @* Header - Modern Toolbar *@
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 transition-all">
        @* Title Section *@
        <div class="flex items-center gap-3 w-full sm:w-auto">
            <div class="w-8 h-8 rounded-lg bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div class="font-semibold text-gray-800 dark:text-gray-200">
                @Title
            </div>
        </div>
        
        @* Controls Container *@
        <div class="flex items-center gap-4 w-full sm:w-auto overflow-x-auto pb-1 sm:pb-0 scrollbar-hide">
            @* View Mode Switcher (Segmented Control Style) *@
            <div class="flex bg-gray-100 dark:bg-gray-700/50 p-1 rounded-lg flex-shrink-0">
                <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(ViewMode == GanttViewMode.Day ? "bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm" : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200")"
                        @onclick="async () => await SetViewMode(GanttViewMode.Day)">
                    Gün
                </button>
                <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(ViewMode == GanttViewMode.Week ? "bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm" : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200")"
                        @onclick="async () => await SetViewMode(GanttViewMode.Week)">
                    Hafta
                </button>
                <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(ViewMode == GanttViewMode.Month ? "bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm" : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200")"
                        @onclick="async () => await SetViewMode(GanttViewMode.Month)">
                    Ay
                </button>
            </div>
            
            @* Actions Group *@
            <div class="flex items-center gap-1 flex-shrink-0 pl-4 border-l border-gray-200 dark:border-gray-700">
                <button class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                        @onclick="ZoomOut" title="Uzaklaş">
                    <i class="fa-solid fa-minus text-xs"></i>
                </button>
                <button class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                        @onclick="ZoomIn" title="Yakınlaş">
                    <i class="fa-solid fa-plus text-xs"></i>
                </button>
                
                <div class="w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1"></div>
                
                <button class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors @(_isFullScreen ? "bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400" : "")"
                        @onclick="ToggleFullScreen" title="@(_isFullScreen ? "Küçült" : "Tam Ekran")">
                    <i class="@(_isFullScreen ? "fa-solid fa-compress" : "fa-solid fa-expand") text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    @* Main Content with unified vertical scroll *@
    <div class="overflow-auto" style="height: @(_isFullScreen ? "calc(100vh - 46px)" : Height);">
        <div class="flex min-w-max">
            @* Task List (Left Panel - Sticky) *@
            @if (ShowTaskList && _isTaskListVisible)
            {
                <div class="bw-gantt-task-list flex-shrink-0 border-r border-gray-200 dark:border-gray-700 sticky left-0 bg-white dark:bg-gray-800 z-30 relative"
                     style="width: @(_currentTaskListWidth)px;">
                    @* Task List Header *@
                    <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-3 h-8 flex items-center justify-between text-xs font-semibold text-gray-600 dark:text-gray-400 z-32" style="top: 0;">
                        <span>Görevler</span>
                        <button type="button" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors" 
                                @onclick="ToggleTaskList" title="Görev listesini gizle">
                            <i class="fa-solid fa-chevron-left text-xs"></i>
                        </button>
                    </div>
                    @* Task List Items - fixed height rows *@
                    @{ int taskIndex = 0; }
                    @foreach (var task in FlatTasks)
                    {
                        var isHovered = _hoveredTaskId == task.Id;
                        var currentTask = task;
                        <div class="bw-gantt-task-row flex items-center gap-2 px-3 border-b border-gray-100 dark:border-gray-700 cursor-pointer text-sm transition-colors h-8 @(task.ParentId != null ? "pl-6" : "") @(isHovered ? "bg-blue-50 dark:bg-blue-900/20" : "hover:bg-gray-50 dark:hover:bg-gray-700")"
                             data-task-index="@taskIndex"
                             @onclick="() => HandleTaskClick(task)"
                             @onmouseenter="() => _hoveredTaskId = task.Id"
                             @onmouseleave="() => _hoveredTaskId = null">
                            @if (TaskItemTemplate != null)
                            {
                                @TaskItemTemplate(currentTask)
                            }
                            else
                            {
                                @if (task.Children.Count > 0)
                                {
                                    <i class="fa-solid fa-folder text-amber-500 text-xs"></i>
                                }
                                else if (task.IsMilestone)
                                {
                                    <i class="fa-solid fa-diamond text-purple-500 text-xs"></i>
                                }
                                else
                                {
                                    <i class="fa-solid fa-circle text-xs" style="color: @(task.Color ?? "#3b82f6")"></i>
                                }
                                <span class="truncate flex-1 @(task.Status == GanttTaskStatus.Completed ? "line-through text-gray-400 dark:text-gray-500" : "text-gray-700 dark:text-gray-200")">
                                    @task.Title
                                </span>
                                @if (!string.IsNullOrEmpty(task.AssigneeAvatar) || !string.IsNullOrEmpty(task.AssigneeName))
                                {
                                    <BwAvatar Name="@task.AssigneeName" Src="@task.AssigneeAvatar" Size="BwSize.ExtraSmall" />
                                }
                            }
                        </div>
                        taskIndex++;
                    }
                    
                    @* Resize Handle *@
                    @if (TaskListResizable)
                    {
                        <div class="bw-gantt-resize-handle absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors z-40"
                             @onmousedown="StartTaskListResize"
                             @onmousedown:preventDefault="true"></div>
                    }
                </div>
            }
            else if (ShowTaskList)
            {
                @* Collapsed state - show expand button *@
                <div class="flex-shrink-0 border-r border-gray-200 dark:border-gray-700 sticky left-0 bg-white dark:bg-gray-800 z-30" style="width: 32px;">
                    <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 h-8 flex items-center justify-center z-32">
                        <button type="button" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors" 
                                @onclick="ToggleTaskList" title="Görev listesini göster">
                            <i class="fa-solid fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                    @* Row placeholders for alignment *@
                    @foreach (var task in FlatTasks)
                    {
                        <div class="h-8 border-b border-gray-100 dark:border-gray-700"></div>
                    }
                </div>
            }


        @* Timeline (Right Panel) *@
        <div class="flex-1">
            @* Timeline Header - same height as task list header *@
            <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 flex z-20 h-8" style="top: 0;">
                @foreach (var period in TimelinePeriods)
                {
                    <div class="flex-shrink-0 text-center border-r border-gray-200 dark:border-gray-700 px-1 flex items-center justify-center text-xs font-semibold text-gray-600 dark:text-gray-400"
                         style="width: @(GetColumnWidth())px;">
                        @period
                    </div>
                }
            </div>

            @* Timeline Grid - with @ref for JS interop *@
            <div @ref="_timelineContainer" class="relative" style="width: @(TimelinePeriods.Count * GetColumnWidth())px;">
                @* Row Backgrounds with Grid Pattern *@
                <div class="absolute inset-0 pointer-events-none">
                    @{ int rowBgIndex = 0; }
                    @foreach (var task in FlatTasks)
                    {
                        var isRowHovered = _hoveredTaskId == task.Id;
                        <div class="absolute left-0 right-0 border-b border-gray-100 dark:border-gray-700 transition-colors @(isRowHovered ? "bg-blue-50/50 dark:bg-blue-900/10" : (rowBgIndex % 2 == 0 ? "bg-white dark:bg-gray-800" : "bg-gray-50/30 dark:bg-gray-800/50"))"
                             style="top: @(rowBgIndex * 32)px; height: 32px;"></div>
                        rowBgIndex++;
                    }
                </div>
                
                @* Dependency Lines (SVG Overlay) *@
                <svg class="absolute inset-0 w-full h-full pointer-events-none z-10" style="overflow: visible;">
                    <defs>
                        <marker id="arrowhead" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto">
                            <polygon points="0 0, 6 2, 0 4" fill="#9ca3af" />
                        </marker>
                    </defs>
                    @foreach (var dep in CalculateDependencies())
                    {
                        <path d="@dep" stroke="#9ca3af" stroke-width="1.5" fill="none" class="opacity-60" marker-end="url(#arrowhead)" />
                    }
                </svg>
                
                @* Vertical Grid Lines *@
                <div class="absolute inset-0 flex pointer-events-none">
                    @foreach (var period in TimelinePeriods)
                    {
                        <div class="border-r border-gray-100/60 dark:border-gray-700/60 flex-shrink-0 bg-gradient-to-b from-transparent via-gray-50/10 dark:via-gray-800/10 to-transparent" style="width: @(GetColumnWidth())px;"></div>
                    }
                </div>

                @* Today Line *@
                @if (TodayOffset >= 0)
                {
                    <div class="absolute top-0 bottom-0 z-20 pointer-events-none"
                         style="left: @(TodayOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))px;">
                        @* Line *@
                        <div class="absolute inset-y-0 left-0 w-px bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
                    </div>
                }

                @* Task Bars *@
                @{
                    int rowIndex = 0;
                }
                @foreach (var task in FlatTasks)
                {
                    var barStyle = GetTaskBarStyle(task, rowIndex);
                    var taskLocal = task;
                    
                    @* Task bar container with data-task-id for JS *@
                    @if (ContextMenuTemplate != null)
                    {
                        <BwContextMenu Class="@($"bw-gantt-bar absolute flex items-center {(Editable ? "cursor-move" : "")}")" 
                                       Style="@barStyle"
                                       @onclick="@(Editable ? null : () => HandleTaskClick(taskLocal))"
                                       data-task-id="@task.Id">
                            <ChildContent>
                                @RenderTaskBar(taskLocal)
                            </ChildContent>
                            <MenuContent>
                                @ContextMenuTemplate(taskLocal)
                            </MenuContent>
                        </BwContextMenu>
                    }
                    else
                    {
                        <div class="bw-gantt-bar absolute flex items-center @(Editable ? "cursor-move" : "")" 
                             style="@barStyle"
                             data-task-id="@task.Id"
                             @onclick="@(Editable ? null : () => HandleTaskClick(taskLocal))">
                             @RenderTaskBar(taskLocal)
                        </div>
                    }
                    rowIndex++;
                }
            </div>
        </div>
        </div>
    </div>
</BwCard>

@* Resize overlay - captures mouse during panel resize *@
@if (_isResizingTaskList)
{
    <div class="fixed inset-0 z-50 cursor-col-resize"
         @onmousemove="OnResizeMouseMove"
         @onmouseup="OnResizeMouseUp"
         @onmouseleave="OnResizeMouseUp">
    </div>
}

@code {
    [Parameter] public List<GanttTask> Tasks { get; set; } = new();
    [Parameter] public string Title { get; set; } = "Proje Planı";
    [Parameter] public string Height { get; set; } = "400px";
    [Parameter] public GanttViewMode ViewMode { get; set; } = GanttViewMode.Week;
    [Parameter] public EventCallback<GanttViewMode> ViewModeChanged { get; set; }
    [Parameter] public DateTime? StartDate { get; set; }
    [Parameter] public DateTime? EndDate { get; set; }
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public bool Editable { get; set; } = false;
    [Parameter] public EventCallback<GanttTask> OnTaskClick { get; set; }
    [Parameter] public EventCallback<GanttTaskResizeEventArgs> OnTaskResize { get; set; }
    [Parameter] public EventCallback<GanttTaskDragEventArgs> OnTaskDrag { get; set; }
    
    // Task List Panel Parameters
    /// <summary>Show/hide the task list panel on the left</summary>
    [Parameter] public bool ShowTaskList { get; set; } = true;
    
    /// <summary>Width of the task list panel in pixels</summary>
    [Parameter] public int TaskListWidth { get; set; } = 256;
    
    /// <summary>Allow resizing the task list panel</summary>
    [Parameter] public bool TaskListResizable { get; set; } = true;
    
    /// <summary>Custom template for task list items</summary>
    [Parameter] public RenderFragment<GanttTask>? TaskItemTemplate { get; set; }

    /// <summary>Custom context menu template for task bars</summary>
    [Parameter] public RenderFragment<GanttTask>? ContextMenuTemplate { get; set; }

    private RenderFragment RenderTaskBar(GanttTask task) => builder =>
    {
        if (task.IsMilestone)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "w-3 h-3 transform rotate-45 shadow-sm hover:scale-110 transition-transform");
            builder.AddAttribute(2, "style", $"background-color: {task.Color ?? "#8b5cf6"};");
            builder.CloseElement();
        }
        else
        {
            builder.OpenElement(3, "div");
            builder.AddAttribute(4, "class", "h-5 rounded shadow-sm relative overflow-hidden group transition-all hover:shadow-md");
            builder.AddAttribute(5, "style", $"width: 100%; background-color: {GetTaskBgColor(task)};");

            if (Editable)
            {
                builder.OpenElement(6, "div");
                builder.AddAttribute(7, "class", "bw-gantt-resize-handle bw-gantt-resize-left absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 transition-colors z-10");
                builder.CloseElement();
            }

            if (task.Progress > 0)
            {
                builder.OpenElement(8, "div");
                builder.AddAttribute(9, "class", "absolute inset-y-0 left-0 rounded-l");
                builder.AddAttribute(10, "style", $"width: {task.Progress}%; background-color: {task.Color ?? "#3b82f6"};");
                builder.CloseElement();
            }

            builder.OpenElement(11, "div");
            builder.AddAttribute(12, "class", "absolute inset-0 flex items-center justify-center px-1");
            builder.OpenElement(13, "span");
            builder.AddAttribute(14, "class", "text-[9px] font-medium text-white truncate drop-shadow");
            if (ShowBarLabels)
            {
                builder.AddContent(15, task.Title);
                if (task.Progress > 0 && task.Progress < 100)
                {
                    builder.AddContent(16, $" ({task.Progress}%)");
                }
            }
            else if (task.Progress > 0 && task.Progress < 100)
            {
                builder.AddContent(17, $"{task.Progress}%");
            }
            builder.CloseElement();
            builder.CloseElement();

            if (Editable)
            {
                builder.OpenElement(18, "div");
                builder.AddAttribute(19, "class", "bw-gantt-resize-handle bw-gantt-resize-right absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 transition-colors z-10");
                builder.CloseElement();
            }

            // Tooltip
            builder.OpenElement(20, "div");
            builder.AddAttribute(21, "class", "absolute left-0 bottom-full mb-1 hidden group-hover:block z-30 pointer-events-none");
            builder.OpenElement(22, "div");
            builder.AddAttribute(23, "class", "bg-gray-800 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap shadow-lg");
            builder.OpenElement(24, "span");
            builder.AddAttribute(25, "class", "font-medium");
            builder.AddContent(26, task.Title);
            builder.CloseElement();
            builder.AddContent(27, $" - {task.Progress}%");
            builder.OpenElement(28, "br");
            builder.CloseElement();
            builder.AddContent(29, $"{task.StartDate:dd.MM} - {task.EndDate:dd.MM}");
            if (Editable)
            {
                builder.OpenElement(30, "br");
                builder.CloseElement();
                builder.OpenElement(31, "span");
                builder.AddAttribute(32, "class", "text-gray-400 text-[9px]");
                builder.AddContent(33, "Sürükle: taşı | Kenarlar: boyutlandır");
                builder.CloseElement();
            }
            builder.CloseElement();
            builder.CloseElement(); // Tooltip wrapper

            builder.CloseElement(); // Task bar container
        }
    };
    
    /// <summary>Show task titles on timeline bars</summary>
    [Parameter] public bool ShowBarLabels { get; set; } = false;
    
    // Task List Events
    /// <summary>Fired when task list visibility changes</summary>
    [Parameter] public EventCallback<bool> OnTaskListVisibilityChanged { get; set; }
    
    /// <summary>Fired when task list width changes after resize</summary>
    [Parameter] public EventCallback<int> OnTaskListWidthChanged { get; set; }
    
    // Internal state
    private bool _isTaskListVisible = true;
    private int _currentTaskListWidth = 256;
    private bool _isResizingTaskList = false;
    private double _resizeStartX;
    private int _resizeStartWidth;
    private bool _isFullScreen = false;

    private void ToggleFullScreen()
    {
        _isFullScreen = !_isFullScreen;
        StateHasChanged();
    }

    private List<GanttTask> FlatTasks => FlattenTasks(Tasks);
    private List<string> TimelinePeriods = new();
    private List<DateTime> PeriodBoundaries = new(); // Start dates of each period
    private DateTime _timelineStart;
    private DateTime _timelineEnd;
    private double TodayOffset => CalculateTodayOffset();
    private string? _hoveredTaskId;

    private bool _prevShowTaskList;
    private int _prevTaskListWidth;
    private int _currentColumnWidth; // Dynamic column width for zooming

    protected override void OnInitialized()
    {
        _isTaskListVisible = ShowTaskList;
        _prevShowTaskList = ShowTaskList;
        
        _currentTaskListWidth = TaskListWidth;
        _prevTaskListWidth = TaskListWidth;
        
        // Initialize column width
        _currentColumnWidth = GetDefaultColumnWidth(ViewMode);
    }
    
    private int GetDefaultColumnWidth(GanttViewMode mode)
    {
        return mode switch
        {
            GanttViewMode.Day => 40,
            GanttViewMode.Week => 60,
            GanttViewMode.Month => 80,
            _ => 40
        };
    }

    [JSInvokable]
    public async Task HandleZoomFromJs(int delta)
    {
        var newWidth = _currentColumnWidth - delta; // Delta is typically +/- 100 from wheel
        // Normalize delta
        var change = delta > 0 ? -5 : 5;
        
        _currentColumnWidth = Math.Clamp(_currentColumnWidth + change, 20, 200);
        await UpdateJsOptionsAsync();
        StateHasChanged();
    }
    
    private async Task ZoomIn()
    {
        _currentColumnWidth = Math.Min(_currentColumnWidth + 10, 200);
        await UpdateJsOptionsAsync();
    }

    private async Task ZoomOut()
    {
        _currentColumnWidth = Math.Max(_currentColumnWidth - 10, 20);
        await UpdateJsOptionsAsync();
    }

    protected override void OnParametersSet()
    {
        CalculateTimeline();
        
        // Only update internal state if parameters explicitly changed
        if (ShowTaskList != _prevShowTaskList)
        {
            _isTaskListVisible = ShowTaskList;
            _prevShowTaskList = ShowTaskList;
        }
        
        if (TaskListWidth != _prevTaskListWidth)
        {
            _currentTaskListWidth = TaskListWidth;
            _prevTaskListWidth = TaskListWidth;
        }
    }
    
    private async Task ToggleTaskList()
    {
        _isTaskListVisible = !_isTaskListVisible;
        await OnTaskListVisibilityChanged.InvokeAsync(_isTaskListVisible);
    }
    
    private void StartTaskListResize(MouseEventArgs e)
    {
        _isResizingTaskList = true;
        _resizeStartX = e.ClientX;
        _resizeStartWidth = _currentTaskListWidth;
    }
    
    private void OnResizeMouseMove(MouseEventArgs e)
    {
        if (!_isResizingTaskList) return;
        
        var delta = e.ClientX - _resizeStartX;
        var newWidth = _resizeStartWidth + (int)delta;
        _currentTaskListWidth = Math.Max(150, Math.Min(newWidth, 500));
    }
    
    private async Task OnResizeMouseUp(MouseEventArgs e)
    {
        if (_isResizingTaskList)
        {
            _isResizingTaskList = false;
            await OnTaskListWidthChanged.InvokeAsync(_currentTaskListWidth);
        }
    }
    
    [JSInvokable]
    public async Task HandleTaskListResize(int newWidth)
    {
        _currentTaskListWidth = Math.Max(150, Math.Min(newWidth, 500));
        await OnTaskListWidthChanged.InvokeAsync(_currentTaskListWidth);
        StateHasChanged();
    }
    
    private double CalculateTodayOffset()
    {
        var columnWidth = GetColumnWidth();
        
        if (ViewMode != GanttViewMode.Month || PeriodBoundaries.Count == 0)
        {
            var days = (DateTime.Today - _timelineStart).TotalDays;
            var daysPerColumn = GetDaysPerColumn();
            return days / daysPerColumn * columnWidth;
        }
        
        // Month view - calculate based on period boundaries
        double offset = 0;
        
        for (int i = 0; i < PeriodBoundaries.Count; i++)
        {
            var periodStart = PeriodBoundaries[i];
            var periodEnd = i < PeriodBoundaries.Count - 1 ? PeriodBoundaries[i + 1] : _timelineEnd.AddDays(1);
            var periodDays = (periodEnd - periodStart).TotalDays;
            
            if (DateTime.Today >= periodEnd)
            {
                offset += columnWidth;
            }
            else if (DateTime.Today >= periodStart && DateTime.Today < periodEnd)
            {
                var daysInto = (DateTime.Today - periodStart).TotalDays;
                offset += (daysInto / periodDays * columnWidth);
                break;
            }
            else
            {
                break;
            }
        }
        
        return offset;
    }

    private List<GanttTask> FlattenTasks(List<GanttTask> tasks, int level = 0)
    {
        var result = new List<GanttTask>();
        foreach (var task in tasks)
        {
            result.Add(task);
            if (task.Children.Count > 0)
            {
                result.AddRange(FlattenTasks(task.Children, level + 1));
            }
        }
        return result;
    }

    private void CalculateTimeline()
    {
        var allTasks = FlatTasks;
        if (allTasks.Count == 0)
        {
            _timelineStart = StartDate ?? DateTime.Today;
            _timelineEnd = EndDate ?? DateTime.Today.AddMonths(1);
        }
        else
        {
            var minDate = allTasks.Min(t => t.StartDate);
            var maxDate = allTasks.Max(t => t.EndDate);
            
            // Adjust timeline based on view mode for better alignment
            if (ViewMode == GanttViewMode.Month)
            {
                // Start from beginning of the month
                _timelineStart = StartDate ?? new DateTime(minDate.Year, minDate.Month, 1);
                // End at the end of the month
                var endMonth = maxDate.AddMonths(1);
                _timelineEnd = EndDate ?? new DateTime(endMonth.Year, endMonth.Month, 1).AddDays(-1);
            }
            else if (ViewMode == GanttViewMode.Week)
            {
                _timelineStart = StartDate ?? minDate.AddDays(-3);
                _timelineEnd = EndDate ?? maxDate.AddDays(7);
            }
            else
            {
                _timelineStart = StartDate ?? minDate.AddDays(-2);
                _timelineEnd = EndDate ?? maxDate.AddDays(5);
            }
        }

        TimelinePeriods = GeneratePeriods();
    }

    private List<string> GeneratePeriods()
    {
        var periods = new List<string>();
        PeriodBoundaries = new List<DateTime>();
        var current = _timelineStart;

        while (current <= _timelineEnd)
        {
            PeriodBoundaries.Add(current);
            
            switch (ViewMode)
            {
                case GanttViewMode.Day:
                    periods.Add(current.ToString("dd"));
                    current = current.AddDays(1);
                    break;
                case GanttViewMode.Week:
                    periods.Add($"H{GetWeekNumber(current)}");
                    current = current.AddDays(7);
                    break;
                case GanttViewMode.Month:
                    var turkishCulture = new CultureInfo("tr-TR");
                    periods.Add(current.ToString("MMM", turkishCulture));
                    current = current.AddMonths(1);
                    break;
            }
        }
        return periods;
    }

    private int GetWeekNumber(DateTime date)
    {
        var jan1 = new DateTime(date.Year, 1, 1);
        return (date.DayOfYear - 1) / 7 + 1;
    }

    private int GetColumnWidth()
    {
        return _currentColumnWidth;
    }

    private double GetDaysPerColumn()
    {
        return ViewMode switch
        {
            GanttViewMode.Day => 1,
            GanttViewMode.Week => 7,
            GanttViewMode.Month => 30, // Average for JS interop
            _ => 1
        };
    }

    private string GetTaskBarStyle(GanttTask task, int rowIndex)
    {
        var columnWidth = GetColumnWidth();
        var rowHeight = 32;
        double startOffset = 0;
        double width = 0;

        if (ViewMode == GanttViewMode.Month && PeriodBoundaries.Count > 0)
        {
            // For month view, calculate based on actual period boundaries
            double totalOffset = 0;
            for (int i = 0; i < PeriodBoundaries.Count; i++)
            {
                var periodStart = PeriodBoundaries[i];
                var periodEnd = i < PeriodBoundaries.Count - 1 ? PeriodBoundaries[i + 1] : _timelineEnd.AddDays(1);
                var periodDays = (periodEnd - periodStart).TotalDays;
                
                if (task.StartDate >= periodEnd)
                {
                    // Task starts after this period
                    totalOffset += columnWidth;
                }
                else if (task.StartDate >= periodStart && task.StartDate < periodEnd)
                {
                    // Task starts in this period
                    var daysInto = (task.StartDate - periodStart).TotalDays;
                    startOffset = totalOffset + (daysInto / periodDays * columnWidth);
                    break;
                }
                else if (task.StartDate < periodStart)
                {
                    // Task started before this period
                    startOffset = totalOffset;
                    break;
                }
            }
            
            // Calculate width based on actual days spanning across months
            double remainingDuration = task.DurationDays;
            var currentDate = task.StartDate;
            
            for (int i = 0; i < PeriodBoundaries.Count && remainingDuration > 0; i++)
            {
                var periodStart = PeriodBoundaries[i];
                var periodEnd = i < PeriodBoundaries.Count - 1 ? PeriodBoundaries[i + 1] : _timelineEnd.AddDays(1);
                var periodDays = (periodEnd - periodStart).TotalDays;
                
                if (currentDate >= periodEnd)
                {
                    continue;
                }
                
                var effectiveStart = currentDate > periodStart ? currentDate : periodStart;
                var taskEnd = task.EndDate.AddDays(1); // EndDate is inclusive
                var effectiveEnd = taskEnd < periodEnd ? taskEnd : periodEnd;
                
                if (effectiveStart < effectiveEnd)
                {
                    var daysInPeriod = (effectiveEnd - effectiveStart).TotalDays;
                    width += (daysInPeriod / periodDays * columnWidth);
                    remainingDuration -= daysInPeriod;
                    currentDate = effectiveEnd;
                }
            }
            
            width = task.IsMilestone ? 16 : Math.Max(16, width);
        }
        else
        {
            // Day and Week views - simple calculation
            var daysPerColumn = GetDaysPerColumn();
            startOffset = (task.StartDate - _timelineStart).TotalDays / daysPerColumn * columnWidth;
            width = task.IsMilestone ? 16 : Math.Max(16, task.DurationDays / daysPerColumn * columnWidth);
        }

        var top = rowIndex * rowHeight + 6;
        
        // Use InvariantCulture to ensure decimal point (not comma) for WASM compatibility
        return $"left: {startOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}px; width: {width.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}px; top: {top}px; height: 20px;";
    }

    private IEnumerable<string> CalculateDependencies()
    {
        var tasks = FlatTasks;
        var taskMap = tasks.ToDictionary(t => t.Id);
        var paths = new List<string>();

        // Pre-calculate positions
        var positions = new Dictionary<string, (double Right, double Top, double Left)>();
        for (int i = 0; i < tasks.Count; i++)
        {
            var task = tasks[i];
            var (startOffset, width) = CalculateTaskPosition(task);
            var top = i * 32 + 16; // Middle of the row
            positions[task.Id] = (startOffset + width, top, startOffset);
        }

        foreach (var task in tasks)
        {
            foreach (var depId in task.Dependencies)
            {
                if (taskMap.ContainsKey(depId) && positions.TryGetValue(depId, out var fromPos) && positions.TryGetValue(task.Id, out var toPos))
                {
                    // Draw cubic bezier curve
                    var x1 = fromPos.Right;
                    var y1 = fromPos.Top;
                    var x2 = toPos.Left;
                    var y2 = toPos.Top;
                    
                    // Simple path logic: 
                    // Move right 10px, go to mid-y, move to target x-10, go to target
                    var path = $"M {x1.ToString(CultureInfo.InvariantCulture)} {y1.ToString(CultureInfo.InvariantCulture)} ";
                    path += $"C {(x1 + 20).ToString(CultureInfo.InvariantCulture)} {y1.ToString(CultureInfo.InvariantCulture)}, ";
                    path += $"{(x2 - 20).ToString(CultureInfo.InvariantCulture)} {y2.ToString(CultureInfo.InvariantCulture)}, ";
                    path += $"{x2.ToString(CultureInfo.InvariantCulture)} {y2.ToString(CultureInfo.InvariantCulture)}";
                    
                    paths.Add(path);
                }
            }
        }

        return paths;
    }

    private (double Left, double Width) CalculateTaskPosition(GanttTask task)
    {
        var columnWidth = GetColumnWidth();
        double startOffset = 0;
        double width = 0;

        if (ViewMode == GanttViewMode.Month && PeriodBoundaries.Count > 0)
        {
             // For month view, calculate based on actual period boundaries
            double totalOffset = 0;
            for (int i = 0; i < PeriodBoundaries.Count; i++)
            {
                var periodStart = PeriodBoundaries[i];
                var periodEnd = i < PeriodBoundaries.Count - 1 ? PeriodBoundaries[i + 1] : _timelineEnd.AddDays(1);
                var periodDays = (periodEnd - periodStart).TotalDays;
                
                if (task.StartDate >= periodEnd)
                {
                    totalOffset += columnWidth;
                }
                else if (task.StartDate >= periodStart && task.StartDate < periodEnd)
                {
                    var daysInto = (task.StartDate - periodStart).TotalDays;
                    startOffset = totalOffset + (daysInto / periodDays * columnWidth);
                    break;
                }
                else if (task.StartDate < periodStart)
                {
                    startOffset = totalOffset;
                    break;
                }
            }
            
            // Calculate width based on actual days spanning across months
            double remainingDuration = task.DurationDays;
            var currentDate = task.StartDate;
            
            for (int i = 0; i < PeriodBoundaries.Count && remainingDuration > 0; i++)
            {
                var periodStart = PeriodBoundaries[i];
                var periodEnd = i < PeriodBoundaries.Count - 1 ? PeriodBoundaries[i + 1] : _timelineEnd.AddDays(1);
                var periodDays = (periodEnd - periodStart).TotalDays;
                
                if (currentDate >= periodEnd)
                {
                    continue;
                }
                
                var effectiveStart = currentDate > periodStart ? currentDate : periodStart;
                var taskEnd = task.EndDate.AddDays(1); // EndDate is inclusive
                var effectiveEnd = taskEnd < periodEnd ? taskEnd : periodEnd;
                
                if (effectiveStart < effectiveEnd)
                {
                    var daysInPeriod = (effectiveEnd - effectiveStart).TotalDays;
                    width += (daysInPeriod / periodDays * columnWidth);
                    remainingDuration -= daysInPeriod;
                    currentDate = effectiveEnd;
                }
            }
             width = task.IsMilestone ? 16 : Math.Max(16, width);
        }
        else
        {
            var daysPerColumn = GetDaysPerColumn();
            startOffset = (task.StartDate - _timelineStart).TotalDays / daysPerColumn * columnWidth;
            width = task.IsMilestone ? 16 : Math.Max(16, task.DurationDays / daysPerColumn * columnWidth);
        }
        
        return (startOffset, width);
    }

    private string GetTaskBgColor(GanttTask task)
    {
        if (!string.IsNullOrEmpty(task.Color))
        {
            // Lighter version of the color
            return task.Color + "40";
        }

        return task.Status switch
        {
            GanttTaskStatus.Completed => "#d1fae540",
            GanttTaskStatus.InProgress => "#dbeafe",
            GanttTaskStatus.Delayed => "#fee2e2",
            GanttTaskStatus.Cancelled => "#f3f4f6",
            _ => "#e5e7eb"
        };
    }

    private async Task SetViewMode(GanttViewMode mode)
    {
        if (ViewMode != mode)
        {
            ViewMode = mode;
            _currentColumnWidth = GetDefaultColumnWidth(mode); // Reset zoom on view change
            CalculateTimeline();
            await UpdateJsOptionsAsync();
            await ViewModeChanged.InvokeAsync(mode);
        }
    }

    // JS Interop for drag/resize
    private ElementReference _timelineContainer;
    private DotNetObjectReference<BwGantt>? _netRef;
    private string? _instanceId;
    private bool _isJsInitialized;
    private bool _previousEditableState;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Editable && !_isJsInitialized)
        {
            await InitializeJsInteropAsync();
        }
        else if (!Editable && _isJsInitialized)
        {
            await DisposeJsAsync();
        }
        
        // Track editable state changes
        _previousEditableState = Editable;
    }

    private async Task InitializeJsInteropAsync()
    {
        if (_isJsInitialized) return;
        
        _netRef = DotNetObjectReference.Create(this);
        var columnWidth = GetColumnWidth();
        var daysPerColumn = GetDaysPerColumn();
        
        // Retry logic for WASM
        var retries = 0;
        while (!_isJsInitialized && retries < 3)
        {
            try
            {
                await Task.Delay(retries * 50); // Progressive delay
                _instanceId = await JS.InvokeAsync<string>(
                    "Blazwind.Gantt.init", 
                    _timelineContainer, 
                    _netRef,
                    daysPerColumn,
                    columnWidth,
                    32 // row height
                );
                _isJsInitialized = true;
            }
            catch
            {
                retries++;
                if (retries >= 3)
                {
                    // Give up after 3 retries
                    break;
                }
            }
        }
    }
    
    private async Task UpdateJsOptionsAsync()
    {
        if (!_isJsInitialized || string.IsNullOrEmpty(_instanceId)) return;
        
        try
        {
            await JS.InvokeVoidAsync(
                "Blazwind.Gantt.updateOptions",
                _instanceId,
                GetDaysPerColumn(),
                GetColumnWidth()
            );
        }
        catch
        {
            // JS not available
        }
    }
    
    private async Task DisposeJsAsync()
    {
        if (_instanceId != null)
        {
            try
            {
                await JS.InvokeVoidAsync("Blazwind.Gantt.dispose", _instanceId);
            }
            catch { }
        }
        _netRef?.Dispose();
        _netRef = null;
        _instanceId = null;
        _isJsInitialized = false;
    }

    [JSInvokable]
    public async Task HandleTaskDragFromJs(string taskId, int daysMoved)
    {
        var task = FlatTasks.FirstOrDefault(t => t.Id == taskId);
        if (task == null) return;

        var oldStart = task.StartDate;
        var oldEnd = task.EndDate;
        
        // Update task dates
        task.StartDate = task.StartDate.AddDays(daysMoved);
        task.EndDate = task.EndDate.AddDays(daysMoved);

        var args = new GanttTaskDragEventArgs
        {
            Task = task,
            OldStartDate = oldStart,
            OldEndDate = oldEnd,
            NewStartDate = task.StartDate,
            NewEndDate = task.EndDate,
            DaysMoved = daysMoved
        };
        
        await OnTaskDrag.InvokeAsync(args);
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleTaskResizeFromJs(string taskId, int startDaysDelta, int endDaysDelta)
    {
        var task = FlatTasks.FirstOrDefault(t => t.Id == taskId);
        if (task == null) return;

        var oldStart = task.StartDate;
        var oldEnd = task.EndDate;
        
        // Update task dates
        if (startDaysDelta != 0)
        {
            task.StartDate = task.StartDate.AddDays(startDaysDelta);
        }
        if (endDaysDelta != 0)
        {
            task.EndDate = task.EndDate.AddDays(endDaysDelta);
        }

        var args = new GanttTaskResizeEventArgs
        {
            Task = task,
            OldStartDate = oldStart,
            OldEndDate = oldEnd,
            NewStartDate = task.StartDate,
            NewEndDate = task.EndDate
        };
        
        await OnTaskResize.InvokeAsync(args);
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleTaskClickFromJs(string taskId)
    {
        var task = FlatTasks.FirstOrDefault(t => t.Id == taskId);
        if (task != null)
        {
            await OnTaskClick.InvokeAsync(task);
        }
    }


    private async Task HandleTaskClick(GanttTask task)
    {
        await OnTaskClick.InvokeAsync(task);
    }

    public async ValueTask DisposeAsync()
    {
        await DisposeJsAsync();
    }
}
