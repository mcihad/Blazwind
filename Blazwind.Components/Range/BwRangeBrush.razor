@namespace Blazwind.Components.Range
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<div id="@_elementId" class="bw-range-brush @Class" style="@Style">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">@Label</label>
    }

    @* Main Brush Container *@
    <div class="relative">
        @* Background Chart/Visualization Area *@
        @if (ChildContent != null)
        {
            <div class="bw-brush-chart mb-2 h-16 rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800/50">
                @ChildContent
            </div>
        }

        @* Brush Track *@
        <div
            class="bw-brush-track relative h-12 rounded-lg @GetTrackBgClass() overflow-hidden cursor-pointer select-none">
            @* Inactive areas (grayed out) *@
            <div class="absolute inset-y-0 left-0 bg-gray-200/80 dark:bg-gray-900/60 backdrop-blur-sm transition-all"
                style="width: @(_startPercent)%;"></div>
            <div class="absolute inset-y-0 right-0 bg-gray-200/80 dark:bg-gray-900/60 backdrop-blur-sm transition-all"
                style="width: @(100 - _endPercent)%;"></div>

            @* Selection Brush *@
            <div class="bw-brush-selection absolute inset-y-0 cursor-grab active:cursor-grabbing transition-shadow
                        @GetBrushBgClass() hover:shadow-lg"
                style="left: @(_startPercent)%; width: @(_endPercent - _startPercent)%;">

                @* Left Handle - wider hit area for easier dragging *@
                <div class="bw-brush-handle-left absolute left-0 inset-y-0 w-5 -ml-1 cursor-ew-resize group/handle
                            flex items-center justify-center z-10">
                    <div class="w-1 h-8 @GetHandleBgClass() rounded-full shadow-md 
                                group-hover/handle:h-10 group-hover/handle:w-1.5 transition-all"></div>
                </div>

                @* Center Grip Pattern *@
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="flex gap-0.5 opacity-40">
                        <div class="w-0.5 h-4 bg-white rounded-full"></div>
                        <div class="w-0.5 h-4 bg-white rounded-full"></div>
                        <div class="w-0.5 h-4 bg-white rounded-full"></div>
                    </div>
                </div>

                @* Right Handle - wider hit area for easier dragging *@
                <div class="bw-brush-handle-right absolute right-0 inset-y-0 w-5 -mr-1 cursor-ew-resize group/handle
                            flex items-center justify-center z-10">
                    <div class="w-1 h-8 @GetHandleBgClass() rounded-full shadow-md 
                                group-hover/handle:h-10 group-hover/handle:w-1.5 transition-all"></div>
                </div>
            </div>

            @* Scale Markers *@
            @if (ShowScale)
            {
                <div class="absolute bottom-0 inset-x-0 h-2 flex justify-between px-1 pointer-events-none">
                    @for (var i = 0; i <= 10; i++)
                    {
                        <div class="w-px h-1.5 bg-gray-400/50 dark:bg-gray-600/50"></div>
                    }
                </div>
            }
        </div>
    </div>

    @* Value Display *@
    @if (ShowValues)
    {
        <div class="mt-3 flex items-center justify-between text-sm">
            <div class="flex items-center gap-2">
                <span class="text-gray-500 dark:text-gray-400">Başlangıç:</span>
                <span class="font-semibold @GetTextColorClass()">@FormatValue(CurrentStart)</span>
            </div>
            <div class="flex items-center gap-2 px-3 py-1 rounded-full @GetBadgeClass()">
                <i class="fa-solid fa-arrows-left-right text-xs"></i>
                <span class="font-medium">@GetRangeText()</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-500 dark:text-gray-400">Bitiş:</span>
                <span class="font-semibold @GetTextColorClass()">@FormatValue(CurrentEnd)</span>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public double Min { get; set; } = 0;
    [Parameter] public double Max { get; set; } = 100;
    [Parameter] public double Step { get; set; } = 1;
    [Parameter] public double Start { get; set; } = 20;
    [Parameter] public double End { get; set; } = 80;
    [Parameter] public double StartPercent { get; set; } = 0;
    [Parameter] public double EndPercent { get; set; } = 100;
    [Parameter] public double MinWidthPercent { get; set; } = 5;
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Format { get; set; }
    [Parameter] public bool ShowValues { get; set; } = true;
    [Parameter] public bool ShowScale { get; set; } = true;
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public EventCallback<BrushChangedEventArgs<double>> OnBrushChanged { get; set; }

    private string _elementId = "";
    private DotNetObjectReference<BwRangeBrush>? _dotNetRef;
    private double _startPercent;
    private double _endPercent;
    private bool _isDragging;

    private double CurrentStartPercent => _startPercent;
    private double CurrentEndPercent => _endPercent;
    private double CurrentStart => Min + (Max - Min) * (_startPercent / 100);
    private double CurrentEnd => Min + (Max - Min) * (_endPercent / 100);

    protected override bool ShouldRender() => !_isDragging;

    protected override void OnInitialized()
    {
        _elementId = $"bw-brush-{Guid.NewGuid():N}";
        // Use StartPercent/EndPercent if provided, otherwise calculate from Start/End
        if (StartPercent > 0 || EndPercent < 100)
        {
            _startPercent = StartPercent;
            _endPercent = EndPercent;
        }
        else
        {
            _startPercent = ((Start - Min) / (Max - Min)) * 100;
            _endPercent = ((End - Min) / (Max - Min)) * 100;
        }
    }
    
    protected override void OnParametersSet()
    {
        // Update internal state if parameters change externally and we're not dragging
        if (!_isDragging)
        {
             // Calculate fresh percentages
            var newStartPercent = ((Start - Min) / (Max - Min)) * 100;
            var newEndPercent = ((End - Min) / (Max - Min)) * 100;
            
            // Only update if difference is significant (avoid floating point noise)
            if (Math.Abs(newStartPercent - _startPercent) > 0.01 || Math.Abs(newEndPercent - _endPercent) > 0.01)
            {
                _startPercent = newStartPercent;
                _endPercent = newEndPercent;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.initialize", _elementId, _dotNetRef, _startPercent, _endPercent,
            MinWidthPercent);
        }
    }
    
    [JSInvokable]
    public void HandleDragStart()
    {
        _isDragging = true;
    }

    [JSInvokable]
    public void HandleDragEnd()
    {
        _isDragging = false;
        // Trigger a render to ensure consistency
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleBrushChanged(double startPercent, double endPercent)
    {
        _startPercent = Math.Round(startPercent, 2);
        _endPercent = Math.Round(endPercent, 2);

        // Snap to step
        var start = SnapToStep(CurrentStart);
        var end = SnapToStep(CurrentEnd);

        await OnBrushChanged.InvokeAsync(new BrushChangedEventArgs<double>
        {
            Start = start,
            End = end,
            Min = Min,
            Max = Max,
            StartPercent = _startPercent,
            EndPercent = _endPercent
        });

        await InvokeAsync(StateHasChanged);
    }

    private double SnapToStep(double value) => Math.Round(value / Step) * Step;

    private string FormatValue(double value)
    {
        var snapped = SnapToStep(value);
        return string.IsNullOrEmpty(Format) ? snapped.ToString("N0") : snapped.ToString(Format);
    }

    private string GetRangeText()
    {
        var range = SnapToStep(CurrentEnd) - SnapToStep(CurrentStart);
        return string.IsNullOrEmpty(Format) ? range.ToString("N0") : range.ToString(Format);
    }

    private string GetTrackBgClass() => Color switch
    {
        BwColor.Primary => "bg-blue-100 dark:bg-blue-950",
        BwColor.Secondary => "bg-gray-100 dark:bg-gray-800",
        BwColor.Success => "bg-green-100 dark:bg-green-950",
        BwColor.Danger => "bg-red-100 dark:bg-red-950",
        BwColor.Warning => "bg-yellow-100 dark:bg-yellow-950",
        BwColor.Info => "bg-cyan-100 dark:bg-cyan-950",
        _ => "bg-blue-100 dark:bg-blue-950"
    };

    private string GetBrushBgClass() => Color switch
    {
        BwColor.Primary => "bg-gradient-to-r from-blue-500 to-blue-600",
        BwColor.Secondary => "bg-gradient-to-r from-gray-500 to-gray-600",
        BwColor.Success => "bg-gradient-to-r from-green-500 to-green-600",
        BwColor.Danger => "bg-gradient-to-r from-red-500 to-red-600",
        BwColor.Warning => "bg-gradient-to-r from-yellow-500 to-yellow-600",
        BwColor.Info => "bg-gradient-to-r from-cyan-500 to-cyan-600",
        _ => "bg-gradient-to-r from-blue-500 to-blue-600"
    };

    private string GetHandleClass() => Color switch
    {
        BwColor.Primary => "bg-blue-700 hover:bg-blue-800",
        BwColor.Secondary => "bg-gray-700 hover:bg-gray-800",
        BwColor.Success => "bg-green-700 hover:bg-green-800",
        BwColor.Danger => "bg-red-700 hover:bg-red-800",
        BwColor.Warning => "bg-yellow-700 hover:bg-yellow-800",
        BwColor.Info => "bg-cyan-700 hover:bg-cyan-800",
        _ => "bg-blue-700 hover:bg-blue-800"
    };

    private string GetHandleBgClass() => Color switch
    {
        BwColor.Primary => "bg-white border-2 border-blue-600",
        BwColor.Secondary => "bg-white border-2 border-gray-600",
        BwColor.Success => "bg-white border-2 border-green-600",
        BwColor.Danger => "bg-white border-2 border-red-600",
        BwColor.Warning => "bg-white border-2 border-yellow-600",
        BwColor.Info => "bg-white border-2 border-cyan-600",
        _ => "bg-white border-2 border-blue-600"
    };

    private string GetTextColorClass() => Color switch
    {
        BwColor.Primary => "text-blue-600 dark:text-blue-400",
        BwColor.Secondary => "text-gray-600 dark:text-gray-400",
        BwColor.Success => "text-green-600 dark:text-green-400",
        BwColor.Danger => "text-red-600 dark:text-red-400",
        BwColor.Warning => "text-yellow-600 dark:text-yellow-400",
        BwColor.Info => "text-cyan-600 dark:text-cyan-400",
        _ => "text-blue-600 dark:text-blue-400"
    };

    private string GetBadgeClass() => Color switch
    {
        BwColor.Primary => "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
        BwColor.Secondary => "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",
        BwColor.Success => "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
        BwColor.Danger => "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300",
        BwColor.Warning => "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300",
        BwColor.Info => "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300",
        _ => "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300"
    };

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.dispose", _elementId);
        }
        catch { }

        _dotNetRef?.Dispose();
    }
}