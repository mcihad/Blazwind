@namespace Blazwind.Components.Range
@using Blazwind.Components.Shared
@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<div id="@_elementId" class="bw-number-range-brush @Class" style="@Style">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">@Label</label>
    }

    @* Mini Histogram/Bar Chart *@
    @if (ShowHistogram && Data?.Any() == true)
    {
        <div class="h-12 flex items-end gap-px mb-1 px-0.5">
            @foreach (var (value, index) in Data.Select((v, i) => (v, i)))
            {
                var height = MaxDataValue > 0 ? (value / MaxDataValue) * 100 : 0;
                var isInRange = IsIndexInRange(index);
                <div class="flex-1 rounded-t transition-all duration-150 @(isInRange? GetBarActiveClass() : "bg-gray-300 dark:bg-gray-600")"
                    style="height: @(Math.Max(4, height))%;"></div>
            }
        </div>
    }

    @* Brush Track *@
    <div
        class="bw-brush-track relative h-10 rounded-lg bg-gray-100 dark:bg-gray-800 overflow-hidden cursor-pointer select-none">
        @* Inactive areas *@
        <div class="absolute inset-y-0 left-0 bg-gray-200/80 dark:bg-gray-900/60 transition-all"
            style="width: @GetInvariantPercent(StartPercent)%;"></div>
        <div class="absolute inset-y-0 right-0 bg-gray-200/80 dark:bg-gray-900/60 transition-all"
            style="width: @GetInvariantPercent(100 - EndPercent)%;"></div>

        @* Selection Brush *@
        <div class="bw-brush-selection absolute inset-y-0 cursor-grab active:cursor-grabbing
                    @GetBrushBgClass() shadow-md hover:shadow-lg transition-shadow"
            style="left: @GetInvariantPercent(StartPercent)%; width: @GetInvariantPercent(EndPercent - StartPercent)%;">

            @* Left Handle *@
            <div class="bw-brush-handle-left absolute left-0 inset-y-0 w-2.5 cursor-ew-resize
                        flex items-center justify-center @GetHandleClass()">
                <div class="w-0.5 h-5 bg-white/70 rounded-full"></div>
            </div>

            @* Grip Pattern *@
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-40">
                <div class="flex gap-0.5">
                    <div class="w-0.5 h-3 bg-white rounded-full"></div>
                    <div class="w-0.5 h-3 bg-white rounded-full"></div>
                </div>
            </div>

            @* Right Handle *@
            <div class="bw-brush-handle-right absolute right-0 inset-y-0 w-2.5 cursor-ew-resize
                        flex items-center justify-center @GetHandleClass()">
                <div class="w-0.5 h-5 bg-white/70 rounded-full"></div>
            </div>
        </div>

        @* Scale Labels *@
        @if (ShowScale)
        {
            <div class="absolute -bottom-5 inset-x-0 flex justify-between text-[10px] text-gray-400">
                <span>@FormatValue(Min)</span>
                <span>@FormatValue((Min + Max) / 2)</span>
                <span>@FormatValue(Max)</span>
            </div>
        }
    </div>

    @* Value Display *@
    @if (ShowValues)
    {
        <div class="mt-6 flex items-center justify-center gap-4">
            <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800">
                <span class="text-xs text-gray-500 dark:text-gray-400">Min:</span>
                <span class="text-sm font-semibold @GetTextColorClass()">@FormatValue(CurrentStart)</span>
            </div>
            <i class="fa-solid fa-arrow-right text-gray-400 text-xs"></i>
            <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800">
                <span class="text-xs text-gray-500 dark:text-gray-400">Max:</span>
                <span class="text-sm font-semibold @GetTextColorClass()">@FormatValue(CurrentEnd)</span>
            </div>
        </div>
    }

    @* Presets *@
    @if (Presets?.Any() == true)
    {
        <div class="mt-3 flex flex-wrap justify-center gap-2">
            @foreach (var preset in Presets)
            {
                <button type="button"
                    class="px-2 py-1 text-xs rounded-md transition-colors
                                               @(IsPresetActive(preset) ? GetActivePresetClass() : "bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300")"
                    @onclick="() => ApplyPreset(preset)">
                    @preset.Label
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public double Min { get; set; } = 0;
    [Parameter] public double Max { get; set; } = 100;
    [Parameter] public double Step { get; set; } = 1;
    [Parameter] public double Start { get; set; } = 20;
    [Parameter] public double End { get; set; } = 80;
    [Parameter] public double MinWidthPercent { get; set; } = 5;
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Prefix { get; set; }
    [Parameter] public string? Suffix { get; set; }
    [Parameter] public string? Format { get; set; }
    [Parameter] public bool ShowValues { get; set; } = true;
    [Parameter] public bool ShowScale { get; set; } = true;
    [Parameter] public bool ShowHistogram { get; set; } = true;
    [Parameter] public List<double>? Data { get; set; }
    [Parameter] public List<NumberBrushPreset>? Presets { get; set; }
    [Parameter] public BwColor Color { get; set; } = BwColor.Primary;
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public EventCallback<BrushChangedEventArgs<double>> OnBrushChanged { get; set; }

    private string _elementId = "";
    private DotNetObjectReference<BwNumberRangeBrush>? _dotNetRef;
    private double _startPercent;
    private double _endPercent;

    private bool _isDragging;
    
    private double _prevStart;
    private double _prevEnd;
    private double _prevMin; // Needed as Min/Max changes affect percent calculation
    private double _prevMax;

    private double StartPercent => _startPercent;
    private double EndPercent => _endPercent;
    private double CurrentStart => SnapToStep(Min + (Max - Min) * (_startPercent / 100));
    private double CurrentEnd => SnapToStep(Min + (Max - Min) * (_endPercent / 100));
    private double MaxDataValue => Data?.Max() ?? 0;

    protected override bool ShouldRender() => !_isDragging;

    protected override void OnInitialized()
    {
        _elementId = $"bw-number-brush-{Guid.NewGuid():N}";
        InitializeState();
    }
    
    private void InitializeState()
    {
        _startPercent = ((Start - Min) / (Max - Min)) * 100;
        _endPercent = ((End - Min) / (Max - Min)) * 100;
        
        _prevStart = Start;
        _prevEnd = End;
        _prevMin = Min;
        _prevMax = Max;
    }

    protected override void OnParametersSet()
    {
        if (_isDragging) return;

        bool paramsChanged = Math.Abs(Start - _prevStart) > double.Epsilon ||
                             Math.Abs(End - _prevEnd) > double.Epsilon ||
                             Math.Abs(Min - _prevMin) > double.Epsilon ||
                             Math.Abs(Max - _prevMax) > double.Epsilon;

        if (!paramsChanged) return;

        _startPercent = ((Start - Min) / (Max - Min)) * 100;
        _endPercent = ((End - Min) / (Max - Min)) * 100;

        _prevStart = Start;
        _prevEnd = End;
        _prevMin = Min;
        _prevMax = Max;
    }
    
    [JSInvokable]
    public void HandleDragStart()
    {
        _isDragging = true;
    }

    [JSInvokable]
    public void HandleDragEnd()
    {
        _isDragging = false;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.initialize", _elementId, _dotNetRef, _startPercent, _endPercent,
            MinWidthPercent);
        }
    }

    [JSInvokable]
    public async Task HandleBrushChanged(double startPercent, double endPercent)
    {
        _startPercent = Math.Round(startPercent, 2);
        _endPercent = Math.Round(endPercent, 2);

        await OnBrushChanged.InvokeAsync(new BrushChangedEventArgs<double>
        {
            Start = CurrentStart,
            End = CurrentEnd,
            Min = Min,
            Max = Max,
            StartPercent = _startPercent,
            EndPercent = _endPercent
        });

        StateHasChanged();
    }

    private async Task ApplyPreset(NumberBrushPreset preset)
    {
        _startPercent = ((preset.Start - Min) / (Max - Min)) * 100;
        _endPercent = ((preset.End - Min) / (Max - Min)) * 100;

        await JS.InvokeVoidAsync("Blazwind.RangeBrush.updatePosition", _elementId, _startPercent, _endPercent);

        await OnBrushChanged.InvokeAsync(new BrushChangedEventArgs<double>
        {
            Start = preset.Start,
            End = preset.End,
            Min = Min,
            Max = Max,
            StartPercent = _startPercent,
            EndPercent = _endPercent
        });
    }

    private bool IsPresetActive(NumberBrushPreset preset) =>
    Math.Abs(CurrentStart - preset.Start) < Step && Math.Abs(CurrentEnd - preset.End) < Step;

    private bool IsIndexInRange(int index)
    {
        if (Data == null || Data.Count == 0) return false;
        var percent = (double)index / (Data.Count - 1) * 100;
        return percent >= _startPercent && percent <= _endPercent;
    }

    private double SnapToStep(double value) => Math.Round(value / Step) * Step;

    private string FormatValue(double value)
    {
        var result = Prefix ?? "";
        result += string.IsNullOrEmpty(Format) ? value.ToString("N0") : value.ToString(Format);
        result += Suffix ?? "";
        return result;
    }

    private string GetInvariantPercent(double value) => 
        value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture);

    private string GetBrushBgClass() => Color switch
    {
        BwColor.Primary => "bg-gradient-to-r from-blue-500 to-blue-600",
        BwColor.Success => "bg-gradient-to-r from-green-500 to-green-600",
        BwColor.Danger => "bg-gradient-to-r from-red-500 to-red-600",
        BwColor.Warning => "bg-gradient-to-r from-yellow-500 to-yellow-600",
        BwColor.Info => "bg-gradient-to-r from-cyan-500 to-cyan-600",
        _ => "bg-gradient-to-r from-blue-500 to-blue-600"
    };

    private string GetHandleClass() => Color switch
    {
        BwColor.Primary => "bg-blue-700",
        BwColor.Success => "bg-green-700",
        BwColor.Danger => "bg-red-700",
        BwColor.Warning => "bg-yellow-700",
        BwColor.Info => "bg-cyan-700",
        _ => "bg-blue-700"
    };

    private string GetBarActiveClass() => Color switch
    {
        BwColor.Primary => "bg-blue-400 dark:bg-blue-500",
        BwColor.Success => "bg-green-400 dark:bg-green-500",
        BwColor.Danger => "bg-red-400 dark:bg-red-500",
        BwColor.Warning => "bg-yellow-400 dark:bg-yellow-500",
        BwColor.Info => "bg-cyan-400 dark:bg-cyan-500",
        _ => "bg-blue-400 dark:bg-blue-500"
    };

    private string GetTextColorClass() => Color switch
    {
        BwColor.Primary => "text-blue-600 dark:text-blue-400",
        BwColor.Success => "text-green-600 dark:text-green-400",
        BwColor.Danger => "text-red-600 dark:text-red-400",
        BwColor.Warning => "text-yellow-600 dark:text-yellow-400",
        BwColor.Info => "text-cyan-600 dark:text-cyan-400",
        _ => "text-blue-600 dark:text-blue-400"
    };

    private string GetActivePresetClass() => Color switch
    {
        BwColor.Primary => "bg-blue-500 text-white",
        BwColor.Success => "bg-green-500 text-white",
        BwColor.Danger => "bg-red-500 text-white",
        _ => "bg-blue-500 text-white"
    };

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("Blazwind.RangeBrush.dispose", _elementId);
        }
        catch { }

        _dotNetRef?.Dispose();
    }

    public class NumberBrushPreset
    {
        public string Label { get; set; } = "";
        public double Start { get; set; }
        public double End { get; set; }
    }
}