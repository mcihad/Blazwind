@namespace Blazwind.Components.CodeBlock
@inherits BwBase
@using Blazwind.Components.Shared
@using Blazwind.Components
@using Microsoft.JSInterop
@inject IJSRuntime JS

@{
    var themeClasses = Theme switch
    {
        "light" => "bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100",
        _ => "bg-gray-900 text-gray-100"
    };

    var headerTheme = Theme switch
    {
        "light" => "bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700",
        _ => "bg-gray-800 border-gray-700"
    };
}

<div class="@CombineClasses("rounded-lg overflow-hidden shadow-lg")" style="@Style" id="@Id"
    @attributes="AdditionalAttributes">
    @if (ShowHeader)
    {
        <div class="@headerTheme flex items-center justify-between px-4 py-2 border-b">
            <div class="flex items-center gap-2">
                @if (ShowDots)
                {
                    <div class="flex gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(FileName))
                {
                    <span class="text-sm text-gray-400 ml-2">@FileName</span>
                }
            </div>

            <div class="flex items-center gap-2">
                @if (!string.IsNullOrEmpty(Language))
                {
                    <span class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300">@Language</span>
                }
                @if (ShowCopyButton)
                {
                    <button type="button" class="text-gray-400 hover:text-white transition-colors p-1" title="Kodu kopyala"
                        @onclick="CopyToClipboard">
                        <i class="@(_copied ? "fa-solid fa-check text-green-500" : "fa-solid fa-copy")"></i>
                    </button>
                }
            </div>
        </div>
    }

    <div class="@themeClasses relative">
        <pre class="overflow-x-auto p-4 m-0 @(ShowLineNumbers ? "pl-12" : "")"><code class="font-mono text-sm">@if (ShowLineNumbers)
{
        var lines = GetLines();
        for (int i = 0; i < lines.Length; i++)
        {
                var lineNum = i + 1;
                var isHighlighted = HighlightLines?.Contains(lineNum) == true;
                var lineClass = isHighlighted ? (Theme == "light" ? "bg-yellow-100 dark:bg-yellow-900/30" : "bg-yellow-900/30") : "";
                <div class="@lineClass flex"><span class="absolute left-0 w-10 text-right pr-3 text-gray-500 select-none">@lineNum</span><span>@lines[i]</span></div>
        }
}
else
{
        @Code
}
</code></pre>
    </div>
</div>

@code {
    [Parameter] public string Code { get; set; } = "";
    [Parameter] public string? Language { get; set; }
    [Parameter] public string? FileName { get; set; }
    [Parameter] public string Theme { get; set; } = "dark";
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowLineNumbers { get; set; } = true;
    [Parameter] public bool ShowCopyButton { get; set; } = true;
    [Parameter] public bool ShowDots { get; set; } = true;
    [Parameter] public int[]? HighlightLines { get; set; }

    private bool _copied = false;

    private string[] GetLines()
    {
        return Code.Split('\n');
    }

    private async Task CopyToClipboard()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", Code);
            _copied = true;
            StateHasChanged();

            await Task.Delay(2000);
            _copied = false;
            StateHasChanged();
        }
        catch { }
    }
}