@namespace Blazwind.Components.DocumentViewer
@using Blazwind.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<div @ref="_viewerContainer" class="bw-document-viewer @Class" style="@_containerStyle">
    @* Toolbar - for images *@
    @if (ShowToolbar && Type != DocumentType.Pdf)
    {
        <div class="flex flex-wrap items-center justify-between gap-2 p-2 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 print:hidden sticky top-0 z-50">
            <div class="flex items-center gap-1">
                @* Zoom controls *@
                <button type="button" 
                        class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                        title="Uzaklaştır"
                        @onclick="ZoomOutAsync">
                    <i class="fa-solid fa-minus text-sm"></i>
                </button>
                <span class="text-xs text-gray-600 dark:text-gray-300 min-w-[48px] text-center select-none">@($"{(int)(_zoom * 100)}%")</span>
                <button type="button" 
                        class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                        title="Yakınlaştır"
                        @onclick="ZoomInAsync">
                    <i class="fa-solid fa-plus text-sm"></i>
                </button>
                
                <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>

                @* Rotation *@
                <button type="button" 
                        class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                        title="Sola Döndür"
                        @onclick="RotateLeft">
                    <i class="fa-solid fa-rotate-left text-sm"></i>
                </button>
                <button type="button" 
                        class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                        title="Sağa Döndür"
                        @onclick="RotateRight">
                    <i class="fa-solid fa-rotate-right text-sm"></i>
                </button>

                <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>

                @* Grayscale *@
                <button type="button" 
                        class="p-2 @(_isGrayscale ? "text-blue-600 bg-blue-100 dark:bg-blue-900 dark:text-blue-200" : "text-gray-600 dark:text-gray-300") hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                        title="Siyah/Beyaz"
                        @onclick="ToggleGrayscale">
                    <i class="fa-solid fa-wand-magic-sparkles text-sm"></i>
                </button>

            </div>
            
            <div class="flex items-center gap-2">
                @if (OnSave.HasDelegate)
                {
                    <button type="button" 
                            class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded shadow-sm transition-colors"
                            @onclick="SaveAsync">
                        <i class="fa-solid fa-floppy-disk"></i>
                        <span class="hidden sm:inline">Kaydet</span>
                    </button>
                    <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                }

                @if (ShowDownloadButton && !string.IsNullOrEmpty(Url))
                {
                    <a href="@Url" 
                       download
                       target="_blank"
                       class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                       title="İndir">
                        <i class="fa-solid fa-download text-sm"></i>
                    </a>
                }
                @if (ShowFullscreenButton)
                {
                    <button type="button" 
                            class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                            title="Tam Ekran"
                            @onclick="ToggleFullscreenAsync">
                        <i class="fa-solid @(_isFullscreen ? "fa-compress" : "fa-expand") text-sm"></i>
                    </button>
                }
            </div>
        </div>
    }
    
    @* Document container *@
    <div class="flex-1 overflow-auto relative @(Type == DocumentType.Pdf ? "" : "bg-gray-200 dark:bg-gray-900 overflow-hidden")">
        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-gray-800 text-red-500">
                <div class="text-center p-4">
                    <i class="fa-solid fa-triangle-exclamation text-2xl mb-2"></i>
                    <p class="text-sm">@_error</p>
                </div>
            </div>
        }
        else if (Type == DocumentType.Pdf)
        {
            <iframe @ref="_iframeRef"
                    src="@_documentSource" 
                    class="w-full h-full border-0"
                    title="PDF Viewer"></iframe>
        }
        else
        {
            <div class="w-full h-full flex items-center justify-center p-4 bg-gray-600 dark:bg-gray-900 relative" @ref="_imageContainer">
                @if (!string.IsNullOrEmpty(_documentSource))
                {
                    <img @ref="_imageRef"
                         src="@_documentSource" 
                         alt="Document"
                         class="max-w-full max-h-full object-contain transition-transform duration-200"
                         @onload="UpdateMetadataAsync"
                         style="@ImageStyle" />
                         
                    @if (_metaData != null)
                    {
                        <div class="absolute bottom-2 right-2 px-3 py-1.5 flex items-center gap-3 rounded-md bg-black/70 text-white text-[11px] font-medium backdrop-blur-md shadow-lg pointer-events-none select-none z-10 animate-fadeIn border border-white/10">
                            
                            @* Dimensions *@
                            <div class="flex items-center gap-1.5">
                                <i class="fa-solid fa-expand opacity-70"></i>
                                <span>@($"{_metaData.Width} x {_metaData.Height}")</span>
                            </div>
                            
                            <div class="w-px h-3 bg-white/20"></div>
                            
                            @* Format *@
                            <span class="uppercase tracking-wider opacity-90">@_metaData.MimeType.Split('/').LastOrDefault()</span>

                            @* Size if available *@
                            @if (_metaData.SizeBytes > 0)
                            {
                                <div class="w-px h-3 bg-white/20"></div>
                                <div class="flex items-center gap-1.5">
                                    <i class="fa-solid fa-weight-hanging opacity-70"></i>
                                    <span>@GetFormattedSize(_metaData.SizeBytes)</span>
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        }

        @if (_isLoading)
        {
            <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm text-white transition-opacity duration-200">
                <div class="text-center">
                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">İşlem yapılıyor...</p>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private ElementReference _viewerContainer;
    private ElementReference _imageContainer;
    private ElementReference _imageRef;
    private ElementReference _iframeRef;
    private bool _isLoading = true;
    private string? _error;
    private string? _documentSource;
    private double _zoom = 1.0;
    private int _rotation = 0;
    private bool _isGrayscale = false;
    private bool _isFullscreen;
    
    // We construct the style string dynamically based on state
    private string ImageStyle => $@"
        transform: scale({_zoom.ToString(System.Globalization.CultureInfo.InvariantCulture)}) rotate({_rotation}deg); 
        filter: {(_isGrayscale ? "grayscale(100%)" : "none")};
    ";
    
    private string _containerStyle => $"display: flex; flex-direction: column; height: {Height}; {Style}";
    
    #region Parameters
    
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public string Height { get; set; } = "600px";
    [Parameter] public string? Url { get; set; }
    [Parameter] public string? Data { get; set; }
    [Parameter] public DocumentType Type { get; set; } = DocumentType.Pdf;
    [Parameter] public double InitialZoom { get; set; } = 1.0;
    [Parameter] public bool ShowToolbar { get; set; } = true;
    [Parameter] public bool ShowDownloadButton { get; set; } = true;
    [Parameter] public bool ShowPrintButton { get; set; } = true;
    [Parameter] public bool ShowFullscreenButton { get; set; } = true;
    [Parameter] public EventCallback<int> OnLoad { get; set; }
    [Parameter] public EventCallback<int> OnPageChange { get; set; }
    [Parameter] public EventCallback<string> OnError { get; set; }
    [Parameter] public EventCallback<string> OnSave { get; set; }
    
    #endregion
    
    protected override void OnInitialized()
    {
        _zoom = InitialZoom;
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // Only load if source hasn't been set yet or if parameters changed significantly
        // For simplicity, we reload if Url/Data changes.
        // We'll need to detect if it's a "fresh" load to reset edits? 
        // For now, simple logic:
        if (_documentSource == null || (Url != null && !_documentSource.StartsWith(Url) && !string.IsNullOrEmpty(Url)))
        {
             await LoadDocumentAsync();
        }
    }
    
    private async Task LoadDocumentAsync()
    {
        if (string.IsNullOrEmpty(Url) && string.IsNullOrEmpty(Data))
        {
            _isLoading = false;
            _error = "Belge URL'i veya verisi belirtilmedi.";
            return;
        }
        
        _isLoading = true;
        _error = null;
        
        try
        {
            if (Type == DocumentType.Pdf)
            {
                _documentSource = !string.IsNullOrEmpty(Url) ? Url : $"data:application/pdf;base64,{Data}";
            }
            else
            {
                var mimeType = Type switch
                {
                    DocumentType.Png => "image/png",
                    DocumentType.Jpeg => "image/jpeg",
                    DocumentType.Gif => "image/gif",
                    DocumentType.Webp => "image/webp",
                    _ => "image/png"
                };
                
                // If it's a URL, use it directly. If it's Data, construct data URL.
                _documentSource = !string.IsNullOrEmpty(Url) ? Url : $"data:{mimeType};base64,{Data}";
            }
            
            _isLoading = false;
            // Reset edits on new doc
            _rotation = 0;
            _isGrayscale = false;
            await OnLoad.InvokeAsync(1);
        }
        catch (Exception ex)
        {
            _error = $"Belge yüklenemedi: {ex.Message}";
            _isLoading = false;
            await OnError.InvokeAsync(_error);
        }
    }
    
    #region Toolbar Actions
    
    public Task ZoomInAsync()
    {
        _zoom = Math.Min(_zoom + 0.25, 3.0);
        return Task.CompletedTask;
    }
    
    public Task ZoomOutAsync()
    {
        _zoom = Math.Max(_zoom - 0.25, 0.5);
        return Task.CompletedTask;
    }

    public void RotateLeft()
    {
        _rotation = (_rotation - 90) % 360;
    }

    public void RotateRight()
    {
        _rotation = (_rotation + 90) % 360;
    }

    public void ToggleGrayscale()
    {
        _isGrayscale = !_isGrayscale;
    }
    
    #endregion

    #region Save Logic

    public async Task SaveAsync()
    {
        try
        {
            _isLoading = true;
            // Get modified image data 
            var newImageData = await JS.InvokeAsync<string>("Blazwind.DocumentViewer.applyImageEdits", _imageContainer, _rotation, _isGrayscale);
            
            await OnSave.InvokeAsync(newImageData);
        }
        catch (Exception ex)
        {
             _error = "Kaydetme hatası: " + ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    #endregion
    
    public async Task ToggleFullscreenAsync()
    {
        _isFullscreen = !_isFullscreen;
        await JS.InvokeVoidAsync("Blazwind.DocumentViewer.toggleFullscreen", _viewerContainer);
    }
    
    #region Metadata Logic

    private class ImageProperties
    {
        public double Width { get; set; }
        public double Height { get; set; }
        public string MimeType { get; set; } = "";
        public long SizeBytes { get; set; }
    }

    private ImageProperties? _metaData;

    private async Task UpdateMetadataAsync()
    {
        try 
        {
            if (_imageContainer.Context != null) 
            {
               // We invoke JS to get natural dimensions
               _metaData = await JS.InvokeAsync<ImageProperties>("Blazwind.DocumentViewer.getImageProperties", _imageRef);
               StateHasChanged();
            }
        }
        catch (Exception) 
        { 
            // Ignore if image not ready 
        }
    }
    
    private string GetFormattedSize(long bytes)
    {
        if (bytes <= 0) return "";
        string[] suffixes = { "B", "KB", "MB", "GB", "TB" };
        int counter = 0;
        decimal number = (decimal)bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number = number / 1024;
            counter++;
        }
        return string.Format("{0:n1} {1}", number, suffixes[counter]);
    }

    #endregion

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_documentSource != null && Type != DocumentType.Pdf && _metaData == null)
        {
            // Try to get metadata after render if we haven't yet
            await UpdateMetadataAsync();
        }
    }
    
    // ... existing dispose ...
    public ValueTask DisposeAsync()
    {
        return ValueTask.CompletedTask;
    }
}
