@namespace Blazwind.Components.Map
@using Blazwind.Components.Map.Models
@implements IAsyncDisposable

@code {
    [CascadingParameter] public BwMapLibre? ParentMap { get; set; }

    #region Required Parameters

    /// <summary>
    /// Unique popup identifier
    /// </summary>
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();

    /// <summary>
    /// Popup position [longitude, latitude]
    /// </summary>
    [Parameter, EditorRequired] public double[] LngLat { get; set; } = [0, 0];

    /// <summary>
    /// HTML content for popup
    /// </summary>
    [Parameter, EditorRequired] public string Html { get; set; } = "";

    #endregion

    #region Options

    /// <summary>
    /// Whether to show close button
    /// </summary>
    [Parameter] public bool CloseButton { get; set; } = true;

    /// <summary>
    /// Whether to close popup on map click
    /// </summary>
    [Parameter] public bool CloseOnClick { get; set; } = true;

    /// <summary>
    /// Whether to close popup on map move
    /// </summary>
    [Parameter] public bool CloseOnMove { get; set; }

    /// <summary>
    /// Anchor position
    /// </summary>
    [Parameter] public string? Anchor { get; set; }

    /// <summary>
    /// Offset from anchor
    /// </summary>
    [Parameter] public object? Offset { get; set; }

    /// <summary>
    /// CSS class name
    /// </summary>
    [Parameter] public string? ClassName { get; set; }

    /// <summary>
    /// Maximum width (CSS value)
    /// </summary>
    [Parameter] public string? MaxWidth { get; set; }

    #endregion

    #region Events

    /// <summary>
    /// Fired when popup is closed
    /// </summary>
    [Parameter] public EventCallback OnClose { get; set; }

    #endregion

    private bool _isAdded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ParentMap != null)
        {
            await AddPopupAsync();
        }
    }

    private async Task AddPopupAsync()
    {
        if (ParentMap == null || _isAdded) return;

        var popup = new MapPopup
        {
            Id = Id,
            LngLat = new LngLat(LngLat[0], LngLat[1]),
            Html = Html,
            Options = new MapPopupOptions
            {
                CloseButton = CloseButton,
                CloseOnClick = CloseOnClick,
                CloseOnMove = CloseOnMove,
                Anchor = Anchor,
                Offset = Offset,
                ClassName = ClassName,
                MaxWidth = MaxWidth
            }
        };

        await ParentMap.AddPopupAsync(popup);
        _isAdded = true;
    }

    /// <summary>
    /// Update popup position
    /// </summary>
    public async Task SetLngLatAsync(double[] lngLat)
    {
        LngLat = lngLat;
        if (ParentMap != null && _isAdded)
        {
            await ParentMap.SetPopupLngLatAsync(Id, lngLat);
        }
    }

    /// <summary>
    /// Update popup content
    /// </summary>
    public async Task SetHtmlAsync(string html)
    {
        Html = html;
        if (ParentMap != null && _isAdded)
        {
            await ParentMap.SetPopupHtmlAsync(Id, html);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (ParentMap != null && _isAdded)
        {
            try
            {
                await ParentMap.RemovePopupAsync(Id);
            }
            catch { }
        }
    }
}