@namespace Blazwind.Components.Kanban
@inherits BwBase
@using Blazwind.Components.Shared
@using Blazwind.Components

<div class="@CombineClasses("flex gap-4 overflow-x-auto pb-4 items-start h-full")" style="@Style" id="@Id"
    @attributes="AdditionalAttributes">
    @foreach (var column in Columns)
    {
        var columnColor = column.Color ?? BwColor.Secondary;
        var isWipExceeded = column.MaxItems.HasValue && (column.Items?.Count ?? 0) > column.MaxItems.Value;
        
        var headerBorderClass = isWipExceeded 
            ? "border-red-500 shadow-[0_0_10px_rgba(239,68,68,0.3)]" 
            : columnColor switch
            {
                BwColor.Primary => "border-blue-500",
                BwColor.Success => "border-emerald-500",
                BwColor.Danger => "border-red-500",
                BwColor.Warning => "border-amber-500",
                BwColor.Info => "border-sky-500",
                _ => "border-gray-300 dark:border-gray-600"
            };

        if (column.IsCollapsed)
        {
            @* Collapsed State *@
            <div class="flex-shrink-0 w-12 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden flex flex-col items-center py-4 gap-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors h-full max-h-[calc(100vh-200px)] shadow-sm"
                 @onclick="() => column.IsCollapsed = false"
                 @ondragover="HandleDragOverColumn" @ondragover:preventDefault @ondrop="() => HandleDrop(column)">
                
                <div class="w-6 h-6 rounded-full bg-white dark:bg-gray-600 flex items-center justify-center text-xs font-bold text-gray-600 dark:text-gray-200 shadow-sm">
                    @(column.Items?.Count ?? 0)
                </div>

                <div class="writing-mode-vertical font-semibold text-gray-600 dark:text-gray-300 whitespace-nowrap tracking-wide flex-1 text-center flex items-center justify-center">
                     @column.Title
                </div>
                
                 @if (isWipExceeded)
                 {
                     <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse mb-2"></div>
                 }
            </div>
        }
        else
        {
            @* Expanded State *@
            <div class="flex-shrink-0 w-72 flex flex-col bg-gray-50/50 dark:bg-gray-900/50 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden shadow-sm transition-all duration-300" 
                @ondragover="HandleDragOverColumn"
                @ondragover:preventDefault 
                @ondrop="() => HandleDrop(column)">
                
                @* Header *@
                <div class="@headerBorderClass border-t-4 bg-white dark:bg-gray-800 px-3 py-3 flex items-center justify-between shadow-sm z-10">
                    <div class="flex items-center gap-2 overflow-hidden">
                         <button class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors"
                                 @onclick="() => column.IsCollapsed = true">
                             <i class="fa-solid fa-compress-alt text-xs"></i>
                         </button>
                    
                        @if (!string.IsNullOrEmpty(column.Icon))
                        {
                            <i class="@column.Icon text-gray-400 dark:text-gray-500 text-sm"></i>
                        }
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate text-sm">@column.Title</h3>
                        
                        <div class="flex items-center gap-1">
                            <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs px-2 py-0.5 rounded-full font-medium @(isWipExceeded ? "bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400" : "")">
                                @(column.Items?.Count ?? 0)
                                @if (column.MaxItems.HasValue)
                                {
                                    <span class="opacity-50">/@column.MaxItems</span>
                                }
                            </span>
                        </div>
                    </div>
                    @if (column.HeaderExtra != null)
                    {
                        @column.HeaderExtra
                    }
                </div>

                @* Item List *@
                <div class="p-2 space-y-2 min-h-[150px] max-h-[calc(100vh-220px)] overflow-y-auto custom-scrollbar">
                    @if (column.Items != null && column.Items.Any())
                    {
                        foreach (var item in column.Items)
                        {
                            var isDragging = _draggedItem == item;
                            var isTarget = _targetItem == item;
                            
                            @* Drop Zone Indicator *@
                            @if (isTarget && _draggedItem != item)
                            {
                                <div class="h-1 rounded bg-blue-500/50 my-1 transition-all duration-200"></div>
                            }
                        
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-3 cursor-grab active:cursor-grabbing hover:shadow-md hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200 group relative @(isDragging ? "opacity-40 grayscale" : "") @(isTarget ? "translate-y-1" : "")"
                                draggable="true" 
                                @ondragstart="() => HandleDragStart(item, column)"
                                @ondragenter="() => HandleDragEnterItem(item)"
                                @onclick="() => HandleItemClick(item)">
                                
                                @if (ItemTemplate != null)
                                {
                                    @ItemTemplate(item)
                                }
                                else
                                {
                                    <div class="space-y-2">
                                        @if (!string.IsNullOrEmpty(item.Title))
                                        {
                                            <h4 class="font-medium text-gray-900 dark:text-gray-100 text-sm leading-tight">@item.Title</h4>
                                        }
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                            <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2">@item.Description</p>
                                        }
                                        @if (item.Tags?.Any() == true)
                                        {
                                            <div class="flex flex-wrap gap-1">
                                                @foreach (var tag in item.Tags)
                                                {
                                                    <span class="text-[10px] px-1.5 py-0.5 rounded border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400">@tag</span>
                                                }
                                            </div>
                                        }
                                        @if (item.Assignee != null || item.DueDate != null)
                                        {
                                            <div class="flex items-center justify-between pt-2 border-t border-gray-50 dark:border-gray-700/50 mt-1">
                                                @if (item.Assignee != null)
                                                {
                                                    <div class="flex items-center gap-1.5" title="@item.Assignee.Name">
                                                        @if (!string.IsNullOrEmpty(item.Assignee.Avatar))
                                                        {
                                                            <img src="@item.Assignee.Avatar" class="w-5 h-5 rounded-full object-cover ring-1 ring-white dark:ring-gray-700" alt="@item.Assignee.Name" />
                                                        }
                                                        else
                                                        {
                                                            <div class="w-5 h-5 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-[10px] font-bold text-gray-600 dark:text-gray-300 ring-1 ring-white dark:ring-gray-700">
                                                                @item.Assignee.Name?.FirstOrDefault()
                                                            </div>
                                                        }
                                                        <span class="text-xs text-gray-500 dark:text-gray-400 max-w-[80px] truncate hidden sm:block">@item.Assignee.Name</span>
                                                    </div>
                                                }
                                                @if (item.DueDate != null)
                                                {
                                                    var isOverdue = item.DueDate < DateTime.Today;
                                                    <span class="text-[10px] font-medium @(isOverdue ? "text-red-500 dark:text-red-400 bg-red-50 dark:bg-red-900/10 px-1.5 py-0.5 rounded" : "text-gray-400 dark:text-gray-500")">
                                                        <i class="fa-regular fa-calendar mr-1"></i>@item.DueDate.Value.ToString("dd MMM")
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        @* Empty State *@
                        <div class="h-32 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl flex flex-col items-center justify-center text-gray-400 dark:text-gray-600 gap-2 m-1">
                            <i class="fa-solid fa-inbox text-xl opacity-50"></i>
                            <span class="text-xs font-medium">No Items</span>
                        </div>
                    }
                </div>

                @if (ShowAddButton)
                {
                    <div class="p-2 pt-0 mt-auto bg-gray-50/50 dark:bg-gray-900/50 rounded-b-xl border-t border-gray-100 dark:border-gray-700/50">
                        <button type="button"
                            class="w-full py-1.5 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-white dark:hover:bg-gray-800 rounded-lg transition-all shadow-sm border border-transparent hover:border-gray-200 dark:hover:border-gray-700 flex items-center justify-center gap-2 group"
                            @onclick="() => HandleAddClick(column)">
                            <div class="w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 group-hover:bg-blue-100 dark:group-hover:bg-blue-900/30 flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-plus text-xs group-hover:text-blue-600 dark:group-hover:text-blue-400"></i>
                            </div>
                            <span>Add Card</span>
                        </button>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    // Moved to BwKanban.razor.cs
}