@page "/components/workflow"
@using Blazwind.Components.Workflow
@using Blazwind.Components.Workflow.Interfaces
@using Blazwind.Components.Workflow.Nodes
@using Blazwind.Components.Workflow.Models
@using Blazwind.Components.Workflow.Events

<PageTitle>Workflow Demo - Blazwind</PageTitle>

<BwColumn Spacing="BwSpacing.Lg">
    <BwHero Title="Workflow Component"
            Description="BPMN-style process visualization with drag support, pan/zoom, and custom icons."
            Icon="fa-solid fa-diagram-project"
            Color="BwColor.Primary"/>

    @* Application Approval Workflow *@
    <BwCard Title="Application Approval Workflow" Subtitle="Citizen application approval process example."
            Icon="fa-solid fa-file-signature" Color="BwColor.Primary">
        <BwColumn Spacing="BwSpacing.Md">
            <BwWorkflow Nodes="_applicationNodes"
                        Edges="_applicationEdges"
                        Height="300px"
                        OnNodeClick="HandleNodeClick"
                        OnNodePositionChanged="HandlePositionChanged"
                        Draggable="true"/>

            @if (_selectedNode != null)
            {
                <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <h4 class="font-semibold mb-2">@_selectedNode.Label</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">@_selectedNode.Description</p>
                    <p class="text-xs text-gray-400 mt-2">
                        Status: <span class="font-medium @GetStatusColor(_selectedNode.Status)">@_selectedNode.Status</span>
                    </p>
                </div>
            }
        </BwColumn>
    </BwCard>

    @* Leave Request Workflow *@
    <BwCard Title="Leave Request Workflow" Subtitle="Personnel leave request process." Icon="fa-solid fa-calendar-check"
            Color="BwColor.Success">
        <BwColumn Spacing="BwSpacing.Md">
            <BwRow Spacing="BwSpacing.Sm">
                <BwButton Text="Approve Request" Icon="fa-solid fa-check" Size="BwSize.Small" Color="BwColor.Success"
                          OnClick="ApproveLeaveRequest"/>
                <BwButton Text="Reject Request" Icon="fa-solid fa-times" Size="BwSize.Small" Color="BwColor.Danger"
                          Variant="BwVariant.Outline" OnClick="RejectLeaveRequest"/>
                <BwButton Text="Reset" Icon="fa-solid fa-rotate-left" Size="BwSize.Small" Variant="BwVariant.Ghost"
                          OnClick="ResetLeaveRequest"/>
            </BwRow>

            <BwWorkflow @ref="_leaveWorkflow"
                        Nodes="_leaveNodes"
                        Edges="_leaveEdges"
                        Height="250px"/>
        </BwColumn>
    </BwCard>

    <BwRow Spacing="BwSpacing.Md" Cols="1" MdCols="2">
        @* Approval/Reject Decision Flow *@
        <BwCard Title="Approval/Reject Decision Flow" Subtitle="Workflow with decision points."
                Icon="fa-solid fa-code-branch" Color="BwColor.Warning">
            <BwWorkflow Nodes="_decisionNodes"
                        Edges="_decisionEdges"
                        Height="300px"
                        Direction="WorkflowDirection.Vertical"/>
        </BwCard>

        @* Parallel Process *@
        <BwCard Title="Parallel Process" Subtitle="Concurrent steps." Icon="fa-solid fa-arrows-split"
                Color="BwColor.Info">
            <BwWorkflow Nodes="_parallelNodes"
                        Edges="_parallelEdges"
                        Height="300px"
                        Direction="WorkflowDirection.Vertical"/>
        </BwCard>
    </BwRow>

    @* Tender Process - Comprehensive *@
    <BwCard Title="Tender Process" Subtitle="Comprehensive municipal tender workflow." Icon="fa-solid fa-gavel"
            Color="BwColor.Danger">
        <BwWorkflow Nodes="_tenderNodes"
                    Edges="_tenderEdges"
                    Height="350px"
                    NodeWidth="140"
                    NodeHeight="50"
                    HorizontalSpacing="60"/>
    </BwCard>
</BwColumn>

@code {
    private BwWorkflow? _leaveWorkflow;
    private IWorkflowNode? _selectedNode;

    // Application Approval Workflow
    private readonly List<IWorkflowNode> _applicationNodes = new()
    {
        new StartNode("start", "Application Received"),
        new TaskNode("check", "Document Check", "fa-solid fa-clipboard-check") { Status = WorkflowNodeStatus.Completed },
        new TaskNode("review", "Review", "fa-solid fa-magnifying-glass") { Status = WorkflowNodeStatus.Active },
        new TaskNode("approve", "Approval", "fa-solid fa-signature"),
        new EndNode("end", "Completed")
    };

    private readonly List<IWorkflowEdge> _applicationEdges = new()
    {
        new WorkflowEdge("start", "check"),
        new WorkflowEdge("check", "review"),
        new WorkflowEdge("review", "approve"),
        new WorkflowEdge("approve", "end")
    };

    // Leave Request Workflow
    private List<IWorkflowNode> _leaveNodes = new()
    {
        new StartNode("start", "Request"),
        new TaskNode("manager", "Manager Approval", "fa-solid fa-user-tie") { Status = WorkflowNodeStatus.Active },
        new TaskNode("hr", "HR Approval", "fa-solid fa-building"),
        new EndNode("end", "Completed")
    };

    private readonly List<IWorkflowEdge> _leaveEdges = new()
    {
        new WorkflowEdge("start", "manager"),
        new WorkflowEdge("manager", "hr"),
        new WorkflowEdge("hr", "end")
    };

    // Decision Workflow
    private readonly List<IWorkflowNode> _decisionNodes = new()
    {
        new StartNode("start", "Start"),
        new TaskNode("task1", "Document Check", "fa-solid fa-file-alt") { Status = WorkflowNodeStatus.Completed },
        new DecisionNode("decision", "Approve?") { Status = WorkflowNodeStatus.Active },
        new TaskNode("yes", "Approved", "fa-solid fa-check"),
        new TaskNode("no", "Rejected", "fa-solid fa-times"),
        new EndNode("end", "End")
    };

    private readonly List<IWorkflowEdge> _decisionEdges = new()
    {
        new WorkflowEdge("start", "task1"),
        new WorkflowEdge("task1", "decision"),
        new WorkflowEdge("decision", "yes", "Yes"),
        new WorkflowEdge("decision", "no", "No"),
        new WorkflowEdge("yes", "end"),
        new WorkflowEdge("no", "end")
    };

    // Parallel Workflow
    private readonly List<IWorkflowNode> _parallelNodes = new()
    {
        new StartNode("start", "Start"),
        new ParallelNode("fork", "Start Parallel") { Status = WorkflowNodeStatus.Completed },
        new TaskNode("step1", "Step 1", "fa-solid fa-1") { Status = WorkflowNodeStatus.Active },
        new TaskNode("step2", "Step 2", "fa-solid fa-2") { Status = WorkflowNodeStatus.Active },
        new ParallelNode("join", "Merge"),
        new EndNode("end", "End")
    };

    private readonly List<IWorkflowEdge> _parallelEdges = new()
    {
        new WorkflowEdge("start", "fork"),
        new WorkflowEdge("fork", "step1"),
        new WorkflowEdge("fork", "step2"),
        new WorkflowEdge("step1", "join"),
        new WorkflowEdge("step2", "join"),
        new WorkflowEdge("join", "end")
    };

    // Tender Process Workflow
    private readonly List<IWorkflowNode> _tenderNodes = new()
    {
        new StartNode("start", "Tender Announcement"),
        new TaskNode("docs", "Prepare Specifications", "fa-solid fa-file-contract") { Status = WorkflowNodeStatus.Completed },
        new TaskNode("announce", "Announcement", "fa-solid fa-bullhorn") { Status = WorkflowNodeStatus.Completed },
        new TaskNode("collect", "Collect Bids", "fa-solid fa-inbox") { Status = WorkflowNodeStatus.Completed },
        new TaskNode("evaluate", "Evaluation", "fa-solid fa-scale-balanced") { Status = WorkflowNodeStatus.Active },
        new DecisionNode("decision", "Suitable Bid?"),
        new TaskNode("award", "Award Decision", "fa-solid fa-medal"),
        new TaskNode("cancel", "Cancel", "fa-solid fa-ban") { Status = WorkflowNodeStatus.Skipped },
        new TaskNode("contract", "Contract", "fa-solid fa-file-signature"),
        new EndNode("end", "Completed")
    };

    private readonly List<IWorkflowEdge> _tenderEdges = new()
    {
        new WorkflowEdge("start", "docs"),
        new WorkflowEdge("docs", "announce"),
        new WorkflowEdge("announce", "collect"),
        new WorkflowEdge("collect", "evaluate"),
        new WorkflowEdge("evaluate", "decision"),
        new WorkflowEdge("decision", "award", "Yes"),
        new WorkflowEdge("decision", "cancel", "No"),
        new WorkflowEdge("award", "contract"),
        new WorkflowEdge("contract", "end"),
        new WorkflowEdge("cancel", "end")
    };

    private void HandleNodeClick(NodeClickedEventArgs args)
    {
        _selectedNode = args.Node;
        StateHasChanged();
    }

    private void HandlePositionChanged(NodePositionChangedEventArgs args)
    {
        // Node position was changed by dragging
        Console.WriteLine($"Node {args.NodeId} moved from ({args.OldPosition.X}, {args.OldPosition.Y}) to ({args.NewPosition.X}, {args.NewPosition.Y})");
    }

    private async Task ApproveLeaveRequest()
    {
        var manager = _leaveNodes.FirstOrDefault(n => n.Id == "manager");
        var hr = _leaveNodes.FirstOrDefault(n => n.Id == "hr");
        var end = _leaveNodes.FirstOrDefault(n => n.Id == "end");

        if (manager != null) manager.Status = WorkflowNodeStatus.Completed;
        if (hr != null) hr.Status = WorkflowNodeStatus.Completed;
        if (end != null) end.Status = WorkflowNodeStatus.Completed;

        StateHasChanged();
    }

    private async Task RejectLeaveRequest()
    {
        var manager = _leaveNodes.FirstOrDefault(n => n.Id == "manager");
        if (manager != null) manager.Status = WorkflowNodeStatus.Error;
        StateHasChanged();
    }

    private async Task ResetLeaveRequest()
    {
        foreach (var node in _leaveNodes)
        {
            node.Status = node.NodeType == "start" ? WorkflowNodeStatus.Completed : WorkflowNodeStatus.Pending;
        }
        var manager = _leaveNodes.FirstOrDefault(n => n.Id == "manager");
        if (manager != null) manager.Status = WorkflowNodeStatus.Active;
        StateHasChanged();
    }

    private string GetStatusColor(WorkflowNodeStatus status) => status switch
    {
        WorkflowNodeStatus.Pending => "text-gray-500",
        WorkflowNodeStatus.Active => "text-blue-500",
        WorkflowNodeStatus.Completed => "text-green-500",
        WorkflowNodeStatus.Error => "text-red-500",
        WorkflowNodeStatus.Skipped => "text-gray-400",
        _ => "text-gray-500"
    };
}
